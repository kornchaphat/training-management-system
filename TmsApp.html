<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary: #137333;
      --primary-dark: #0d5f2b;
      --primary-light: #34a853;
      --secondary: #1967d2;
      --success: #137333;
      --warning: #f9ab00;
      --danger: #d93025;
      --bg-dark: #f4f6f8;
      --bg-card: #ffffff;
      --bg-card-hover: #f8f9fa;
      --text-primary: #1a1f36;
      --text-secondary: #5f6368;
      --text-muted: #9aa0a6;
      --border: #e1e4e8;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, var(--bg-card-hover) 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-row {
      display: flex;
      gap: 1rem;
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .skeleton-cell {
      height: 14px;
      border-radius: 4px;
    }
    
    .skeleton-table {
      background: var(--bg-card);
      border-radius: 0.75rem;
      overflow: hidden;
    }
    
    .skeleton-header {
      display: flex;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-dark);
      border-bottom: 1px solid var(--border);
    }
    
    /* Pagination */
    .pagination-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      border-radius: 0 0 0.75rem 0.75rem;
    }
    
    .pagination-info {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .pagination-info strong {
      color: var(--text-primary);
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    #sessionsPageNumbers,
    #participantsPageNumbers {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .page-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .page-btn:hover:not(:disabled) { 
      background: var(--bg-card-hover); 
      border-color: var(--primary);
    }
    
    .page-btn.active { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary); 
    }
    
    .page-btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    .page-size-select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      margin-left: 1rem;
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
    }
    
    /* Progress Modal */
    .progress-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
      z-index: 10001;
      min-width: 380px;
      max-width: 90vw;
    }
    
    .progress-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .progress-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }
    
    .progress-count {
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    .progress-bar-container {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .progress-status {
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .progress-status i {
      color: var(--primary);
    }
    
    /* Cache Indicator */
    .cache-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.75rem;
      background: var(--primary-light);
      background: rgba(52, 168, 83, 0.15);
      border-radius: 20px;
      font-size: 0.75rem;
      color: var(--primary);
    }
    
    .cache-dot {
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      animation: cache-pulse 2s infinite;
    }
    
    @keyframes cache-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .app-container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .sidebar-logo i { font-size: 1.5rem; }

    .sidebar-nav { flex: 1; padding: 1rem 0; overflow-y: auto; }

    .nav-section { padding: 0 0.75rem; margin-bottom: 1.5rem; }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 0 0.75rem;
      margin-bottom: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item i { font-size: 1.25rem; }

    .sidebar-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
    }

    .user-info { display: flex; align-items: center; gap: 0.75rem; }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .user-details { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 0.75rem; color: var(--text-muted); }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    .logout-btn:hover { background: var(--danger); color: white; }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; display: flex; flex-direction: column; }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow);
    }

    .header-title { font-size: 1.5rem; font-weight: 700; }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: inherit;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background: white; color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-card-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
    .btn-icon { width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .content { flex: 1; padding: 2rem; overflow-y: auto; }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 0.75rem;
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .stat-icon.green { background: rgba(19, 115, 51, 0.1); color: var(--primary); }
    .stat-icon.blue { background: rgba(25, 103, 210, 0.1); color: var(--secondary); }
    .stat-icon.yellow { background: rgba(249, 171, 0, 0.1); color: var(--warning); }
    .stat-icon.purple { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
    .stat-label { color: var(--text-muted); font-size: 0.875rem; }

    /* 5-Month Calendar Grid */
    .calendar-5month {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .month-column {
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 600px;
    }

    .month-column.current {
      background: #eff6ff;
      border-color: #bfdbfe;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .month-header {
      padding: 1rem;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .month-column.current .month-header { color: var(--secondary); }

    .program-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .program-card {
      background: white;
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
      border-radius: 0.5rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .program-card.program-completed {
      border-left-color: #22c55e;
      background: linear-gradient(135deg, #f0fdf4 0%, white 100%);
    }
    .program-card.program-upcoming {
      border-left-color: #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, white 100%);
    }

    .program-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .program-card h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .program-date-range {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-card-hover);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
    }

    .program-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    /* Calendar Nav */
    .calendar-nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem 1.5rem;
      background: white;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-card-hover);
      padding: 0.25rem;
      border-radius: 0.5rem;
    }

    .nav-btn {
      background: transparent;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .nav-btn:hover { background: white; color: var(--text-primary); }

    .calendar-month-display {
      font-weight: 600;
      font-size: 1rem;
      width: 180px;
      text-align: center;
    }

    /* Search */
    .search-container { position: relative; }
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(19,115,51,0.1); }
    .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* Forms */
    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 0.5rem; }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
    .form-textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* Stepper */
    .stepper-group {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow: hidden;
      background: white;
    }
    .stepper-btn {
      width: 40px;
      border: none;
      background: var(--bg-card-hover);
      cursor: pointer;
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .stepper-btn:hover { background: var(--border); color: var(--primary); }
    .stepper-input {
      flex: 1;
      text-align: center;
      border: none !important;
      font-weight: 600;
      background: transparent;
    }

    /* Score Visual */
    .score-wrapper { position: relative; }
    .score-stepper {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow: hidden;
      background: white;
      position: relative;
    }
    .score-btn {
      width: 40px;
      border: none;
      background: var(--bg-card-hover);
      cursor: pointer;
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary);
      z-index: 2;
      transition: all 0.2s;
    }
    .score-btn:hover { background: #e6f4ea; }
    .score-input {
      flex: 1;
      text-align: center;
      border: none !important;
      font-weight: 700;
      background: transparent;
      z-index: 2;
    }
    .score-bar-bg {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: var(--border);
      width: 100%;
    }
    .score-bar-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s, background-color 0.3s;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: white;
      border-radius: 0.75rem;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .modal.large { max-width: 1000px; }
    .modal.xlarge { max-width: 1100px; }

    /* Stepper */
    .stepper-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 2rem;
      background: var(--bg-card-hover);
      border-bottom: 1px solid var(--border);
    }
    .stepper-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .stepper-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
      border: 2px solid var(--border);
      background: white;
      color: var(--text-muted);
      transition: all 0.3s;
    }
    .stepper-item.active .stepper-circle {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }
    .stepper-item.completed .stepper-circle {
      border-color: var(--primary);
      background: #e6f4ea;
      color: var(--primary);
    }
    .stepper-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }
    .stepper-item.active .stepper-label,
    .stepper-item.completed .stepper-label {
      color: var(--text-primary);
    }
    .stepper-line {
      width: 80px;
      height: 2px;
      background: var(--border);
      margin: 0 1rem;
    }
    .stepper-line.completed {
      background: var(--primary);
    }
    .stepper-or {
      padding: 0.25rem 0.75rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      margin: 0 0.5rem;
    }
    .stepper-item.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Calendar View Toggle */
    .view-toggle {
      display: flex;
      background: var(--bg-card-hover);
      border-radius: 0.5rem;
      padding: 0.25rem;
      gap: 0.25rem;
    }
    .view-toggle-btn {
      padding: 0.5rem 1rem;
      border: none;
      background: transparent;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.2s;
    }
    .view-toggle-btn:hover { color: var(--text-primary); }
    .view-toggle-btn.active { background: white; color: var(--text-primary); box-shadow: var(--shadow); }

    /* Monthly Calendar Grid - Light Theme */
    .monthly-calendar {
      background: white;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .monthly-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--bg-card-hover);
      border-bottom: 1px solid var(--border);
    }
    .monthly-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .monthly-nav-btn {
      width: 32px;
      height: 32px;
      border-radius: 0.375rem;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .monthly-nav-btn:hover { background: var(--bg-card-hover); }
    .monthly-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }
    .monthly-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--bg-card-hover);
      border-bottom: 1px solid var(--border);
    }
    .monthly-weekday {
      padding: 0.75rem;
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .monthly-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: white;
    }
    .monthly-day {
      min-height: 100px;
      border: 1px solid var(--border);
      border-top: none;
      border-left: none;
      padding: 0.5rem;
      position: relative;
    }
    .monthly-day:nth-child(7n) { border-right: none; }
    .monthly-day.other-month { background: #fafafa; }
    .monthly-day.other-month .monthly-day-number { color: #ccc; }
    .monthly-day-number {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    .monthly-day.today .monthly-day-number {
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .monthly-event {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .monthly-event:hover { transform: scale(1.02); }
    .monthly-event.status-Open { background: #fef3c7; color: #92400e; border-left: 3px solid #f59e0b; }
    .monthly-event.status-Completed { background: #dcfce7; color: #166534; border-left: 3px solid #22c55e; }
    .monthly-more {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* Calendar Filters */
    .calendar-filters {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .calendar-filters select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      background: white;
      font-size: 0.8rem;
      min-width: 120px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title { font-size: 1.125rem; font-weight: 600; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-size: 1.25rem;
    }
    .modal-close:hover { background: var(--bg-card-hover); color: var(--text-primary); }

    .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1.25rem 1.5rem;
      border-top: 1px solid var(--border);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-card-hover);
      padding: 0.25rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .tab {
      flex: 1;
      padding: 0.625rem 1rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 0.375rem;
      font-family: inherit;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .tab i {
      font-size: 1rem;
    }
    .tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.5); }
    .tab.active { background: white; color: var(--text-primary); box-shadow: var(--shadow); }
    .tab:disabled { cursor: not-allowed; }

    /* Session ID Badge */
    .session-badge {
      background: #e6f4ea;
      color: var(--primary);
      font-family: monospace;
      font-weight: 700;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      border: 1px dashed var(--primary);
      font-size: 0.875rem;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-Open, .status-Attended { background: #e6f4ea; color: #166534; border: 1px solid #ceead6; }
    .status-Enrolled { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .status-Absent { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
    
    /* Clickable status dropdown */
    .status-dropdown-container {
      position: relative;
      display: inline-block;
    }
    .status-badge.clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .status-badge.clickable:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .status-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      min-width: 110px;
      margin-top: 4px;
      display: none;
      overflow: hidden;
    }
    .status-dropdown.show {
      display: block;
      animation: fadeIn 0.15s ease;
    }
    .status-dropdown-item {
      padding: 8px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    .status-dropdown-item:hover {
      background: #f3f4f6;
    }
    .status-dropdown-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-dropdown-item .dot.attended { background: #166534; }
    .status-dropdown-item .dot.enrolled { background: #1e40af; }
    .status-dropdown-item .dot.absent { background: #dc2626; }
    .status-Completed, .status-Closed { background: #f1f3f4; color: var(--text-secondary); border: 1px solid #dadce0; }
    .status-Cancelled { background: #fce8e6; color: var(--danger); border: 1px solid #fad2cf; }

    /* Bulk Create Grid */
    .bulk-grid {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow-x: auto;
    }
    .bulk-header {
      display: grid;
      grid-template-columns: 0.9fr 85px 95px 85px 90px 45px 100px 0.7fr 90px 90px 30px;
      background: var(--bg-card-hover);
      font-size: 0.55rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      min-width: 850px;
    }
    .bulk-header > div { padding: 0.6rem 0.4rem; }
    .bulk-row {
      display: grid;
      grid-template-columns: 0.9fr 85px 95px 85px 90px 45px 100px 0.7fr 90px 90px 30px;
      border-top: 1px solid var(--border);
      align-items: center;
      min-width: 850px;
    }
    .bulk-row input, .bulk-row select {
      border: 1px solid transparent;
      background: transparent;
      padding: 0.4rem;
      font-size: 0.75rem;
      width: 100%;
    }
    .bulk-row input:hover, .bulk-row select:hover { border-color: var(--border); background: white; }
    .bulk-row input:focus, .bulk-row select:focus { border-color: var(--primary); background: white; outline: none; }
    .bulk-cell { padding: 0.2rem; }
    .bulk-stepper {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .bulk-stepper input {
      text-align: center;
      padding: 0.25rem 0.1rem;
      font-size: 0.7rem;
      width: 100%;
      min-width: 0;
    }
    .bulk-stepper button {
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      border-radius: 3px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: bold;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bulk-stepper button:hover { background: var(--primary-light); color: var(--primary); }
    .bulk-cell.center { text-align: center; }

    /* Participants Cards Container */
    .participants-cards-container {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
      background: #fafbfc;
    }
    .participant-card {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: white;
      border-bottom: 1px solid var(--border);
      gap: 0.75rem;
      transition: background 0.2s;
    }
    .participant-card:last-child { border-bottom: none; }
    .participant-card:hover { background: #f8f9fa; }
    .participant-card .checkbox-col {
      flex-shrink: 0;
    }
    .participant-card .info-col {
      flex: 1;
      min-width: 0;
    }
    .participant-card .name-row {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .participant-card .id-row {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    .participant-card .meta-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
      flex-shrink: 0;
    }
    .participant-card .func-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      background: #e8f4fd;
      color: #1976d2;
      border-radius: 0.25rem;
      white-space: nowrap;
    }
    .participant-card .subfunc-text {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .participant-card .status-col {
      flex-shrink: 0;
    }

    /* Participants Table (legacy) */
    .participants-table-container {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      overflow: hidden;
      max-height: 400px;
      overflow-y: auto;
    }
    .participants-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .participants-table th {
      position: sticky;
      top: 0;
      background: var(--bg-card-hover);
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }
    .participants-table td { padding: 0.5rem; border-bottom: 1px solid var(--border); }
    .participants-table tr:last-child td { border-bottom: none; }

    /* Employee List */
    .employee-list {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      max-height: 350px;
      overflow-y: auto;
    }
    .employee-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .employee-item:last-child { border-bottom: none; }
    .employee-item:hover { background: #f0f7ff; }
    .employee-item input[type="checkbox"] { margin-right: 0.75rem; cursor: pointer; accent-color: var(--primary); }
    .employee-info { flex: 1; }
    .employee-name { font-weight: 500; font-size: 0.875rem; }
    .employee-id { font-size: 0.75rem; color: var(--text-muted); font-family: monospace; }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .toast {
      background: white;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      flex-direction: column;
      gap: 1rem;
    }
    .loading-overlay.hidden { display: none; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .page-section { display: none; }
    .page-section.active { display: block; }

    /* ============================================
       ANALYTICS PAGE STYLES
       ============================================ */
    
    .analytics-container {
      padding: 0;
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .analytics-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .analytics-title i {
      color: var(--primary);
    }
    
    .analytics-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .analytics-filter {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .analytics-filter label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .analytics-filter select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      font-size: 0.85rem;
      min-width: 140px;
      cursor: pointer;
    }
    
    .analytics-filter select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* New Analytics Filters Section */
    .analytics-filters-section {
      background: white;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .filter-group label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .filter-group select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-size: 0.8rem;
      min-width: 80px;
      cursor: pointer;
    }
    
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .filter-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    
    .filter-actions .btn {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    
    /* Period Toggle Buttons */
    .period-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .period-toggle-btn {
      padding: 6px 12px;
      border: none;
      background: white;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 1px solid var(--border);
    }
    
    .period-toggle-btn:last-child {
      border-right: none;
    }
    
    .period-toggle-btn:hover {
      background: var(--bg);
    }
    
    .period-toggle-btn.active {
      background: var(--primary);
      color: white;
    }
    
    /* Multi-select Dropdown Styles */
    .multi-select-wrapper {
      position: relative;
      min-width: 110px;
    }
    
    .multi-select-display {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    
    .multi-select-display:hover {
      border-color: var(--primary);
    }
    
    .multi-select-display span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100px;
    }
    
    .multi-select-display i {
      font-size: 0.9rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    
    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 300px;
      display: none;
      margin-top: 4px;
      min-width: 180px;
    }
    
    .multi-select-dropdown.show {
      display: block;
    }
    
    .multi-select-search {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      outline: none;
      box-sizing: border-box;
    }
    
    .multi-select-search:focus {
      background: #f8fafc;
    }
    
    .multi-select-options {
      max-height: 220px;
      overflow-y: auto;
    }
    
    .multi-select-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    .multi-select-option.hidden {
      display: none;
    }
    
    .multi-select-option:hover {
      background: var(--hover);
    }
    
    .multi-select-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }
    
    /* Program Search Dropdown */
    .program-search-wrapper {
      position: relative;
      min-width: 130px;
    }
    
    .program-search-input {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-size: 0.8rem;
      width: 100%;
    }
    
    .program-search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .program-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 250px;
      overflow-y: auto;
      display: none;
      margin-top: 4px;
      min-width: 200px;
    }
    
    .program-dropdown.show {
      display: block;
    }
    
    .program-option {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .program-option:hover {
      background: var(--hover);
    }
    
    .program-option.selected {
      background: rgba(22, 163, 74, 0.1);
      color: var(--primary);
    }
    
    .multi-select-options {
      padding: 4px;
    }
    
    .multi-select-option {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    .multi-select-option:hover {
      background: var(--bg-light);
    }
    
    .multi-select-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 600px) {
      .kpi-grid { grid-template-columns: 1fr; }
    }
    
    .kpi-card {
      background: white;
      border-radius: 16px;
      padding: 1.25rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      min-height: 90px;
    }
    
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }
    
    .kpi-card.blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .kpi-card.green::before { background: linear-gradient(90deg, #10b981, #34d399); }
    .kpi-card.purple::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
    .kpi-card.orange::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    
    .kpi-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.1;
      display: block;
      width: 100%;
    }
    
    .kpi-card.blue .kpi-value { color: #2563eb; }
    .kpi-card.green .kpi-value { color: #059669; }
    .kpi-card.purple .kpi-value { color: #7c3aed; }
    .kpi-card.orange .kpi-value { color: #d97706; }
    
    .kpi-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
      display: block;
      width: 100%;
    }
    
    .kpi-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      opacity: 0.2;
    }
    
    .kpi-card.blue .kpi-icon { background: #3b82f6; color: white; }
    .kpi-card.green .kpi-icon { background: #10b981; color: white; }
    .kpi-card.purple .kpi-icon { background: #8b5cf6; color: white; }
    .kpi-card.orange .kpi-icon { background: #f59e0b; color: white; }
    
    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 1000px) {
      .charts-grid { grid-template-columns: 1fr; }
    }
    
    .chart-card {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1.25rem;
      min-height: 300px;
    }
    
    .chart-card.full-width {
      grid-column: 1 / -1;
    }
    
    .chart-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-title i {
      color: var(--primary);
    }
    
    .chart-container {
      position: relative;
      height: 250px;
    }
    
    .chart-container.pie {
      height: 220px;
    }
    
    /* Individual Development Section */
    .indiv-dev-section {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-top: 2rem;
    }
    
    .indiv-dev-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .indiv-dev-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .indiv-dev-toggle input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .indiv-dev-actions {
      display: flex;
      gap: 8px;
    }
    
    .indiv-dev-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    
    .indiv-dev-content.show {
      padding: 1rem 1.5rem;
      max-height: 2000px;
    }
    
    .indiv-dev-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .indiv-dev-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      background: var(--bg-card-hover);
      border-bottom: 1px solid var(--border);
    }
    
    .indiv-dev-table td {
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }
    
    .indiv-dev-table tr:hover {
      background: var(--bg-card-hover);
    }
    
    .indiv-dev-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    /* Analytics Loading State */
    .analytics-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      color: var(--text-muted);
    }
    
    .analytics-loading i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

    .hidden { display: none !important; }

    /* Export Modal */
    .radio-group {
      display: flex;
      gap: 1rem;
      background: var(--bg-card-hover);
      padding: 0.75rem;
      border-radius: 0.5rem;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
    }

    /* IndivDev Box */
    .indiv-dev-box {
      background: #e8f0fe;
      border: 1px solid var(--secondary);
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .indiv-dev-box label { color: var(--secondary); font-weight: 600; cursor: pointer; margin: 0; }

    /* ============================================
       QR ATTENDANCE STYLES - Clean & Sophisticated
       ============================================ */
    
    /* Tab Bar */
    .qr-tab-bar {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-card);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }
    
    .qr-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qr-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    
    .qr-tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }
    
    .qr-tab i { font-size: 1.1rem; }
    
    .qr-tab-content {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Filters Bar */
    .qr-filters-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .qr-search-box {
      flex: 1;
      min-width: 200px;
      max-width: 320px;
      position: relative;
    }
    
    .qr-search-box i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1rem;
    }
    
    .qr-search-box input {
      width: 100%;
      padding: 10px 14px 10px 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .qr-search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .qr-filter-select {
      padding: 10px 32px 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      min-width: 140px;
    }
    
    .qr-icon-btn {
      width: 40px;
      height: 40px;
      display: grid;
      place-items: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qr-icon-btn:hover {
      background: var(--bg-hover);
      color: var(--primary);
      border-color: var(--primary);
    }
    
    /* Action Bar */
    .qr-action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1.25rem;
    }
    
    .qr-select-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .qr-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .qr-checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .qr-selected-count {
      font-size: 0.85rem;
      color: var(--text-muted);
      padding: 4px 12px;
      background: white;
      border-radius: 20px;
      border: 1px solid var(--border);
    }
    
    .qr-action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .qr-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qr-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .qr-action-btn.print {
      background: var(--primary);
      color: white;
    }
    
    .qr-action-btn.print:hover:not(:disabled) {
      background: #1d4ed8;
    }
    
    .qr-action-btn.email {
      background: white;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    .qr-action-btn.email:hover:not(:disabled) {
      background: var(--bg-hover);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* QR Cards Grid */
    .qr-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }
    
    /* QR Card - Clean Design without QR preview */
    .qr-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .qr-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .qr-card.selected {
      border-color: var(--primary);
      background: #eff6ff;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    
    .qr-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .qr-card-badge {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--primary);
      background: #eff6ff;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .qr-card-checkbox {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
      cursor: pointer;
    }
    
    .qr-card-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .qr-card-name {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .qr-card-id {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: monospace;
    }
    
    .qr-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 4px;
    }
    
    .qr-card-meta-item {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .qr-card-meta-item i {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    .qr-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .qr-card-action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qr-card-action-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Empty State */
    .qr-empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .qr-empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: var(--bg-card);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 2rem;
      color: var(--text-muted);
    }
    
    .qr-empty-state h3 {
      margin: 0 0 8px;
      color: var(--text-secondary);
    }
    
    .qr-empty-state p {
      margin: 0;
    }
    
    /* ============================================
       SCANNER TAB STYLES
       ============================================ */
    
    .scanner-session-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }
    
    .scanner-session-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .scanner-session-label i {
      color: var(--primary);
      font-size: 1.2rem;
    }
    
    .scanner-session-select {
      flex: 1;
      max-width: 400px;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
    }
    
    .scanner-session-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .scanner-layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }
    
    @media (max-width: 900px) {
      .scanner-layout {
        grid-template-columns: 1fr;
      }
    }
    
    .scanner-main {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .scanner-viewport {
      aspect-ratio: 4/3;
      background: #0f172a;
      position: relative;
    }
    
    .scanner-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #64748b;
      text-align: center;
      padding: 20px;
    }
    
    .scanner-placeholder-icon {
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      display: grid;
      place-items: center;
      margin-bottom: 20px;
    }
    
    .scanner-placeholder-icon i {
      font-size: 3rem;
      color: #475569;
    }
    
    .scanner-placeholder h3 {
      margin: 0 0 8px;
      color: #94a3b8;
      font-size: 1.25rem;
    }
    
    .scanner-placeholder p {
      margin: 0;
      font-size: 0.9rem;
    }
    
    .scanner-controls {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: #f8fafc;
      border-top: 1px solid var(--border);
    }
    
    .scanner-ctrl-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scanner-ctrl-btn:hover {
      background: #1d4ed8;
    }
    
    .scanner-ctrl-btn.stop {
      background: #dc2626;
    }
    
    .scanner-camera-select {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: white;
      font-size: 0.9rem;
    }
    
    /* Scanner Sidebar */
    .scanner-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .scanner-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .scanner-stat-card.highlight {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      border: none;
      color: white;
    }
    
    .scanner-stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .scanner-stat-label {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .scanner-stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .scanner-stat-mini {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    
    .scanner-stat-mini .label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .scanner-stat-mini .value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .scanner-recent {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }
    
    .scanner-recent-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .scanner-recent-list {
      flex: 1;
      overflow-y: auto;
      max-height: 300px;
    }
    
    .scanner-recent-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .scanner-recent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .scanner-recent-item:last-child {
      border-bottom: none;
    }
    
    .scanner-recent-item .avatar {
      width: 36px;
      height: 36px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .scanner-recent-item .info {
      flex: 1;
    }
    
    .scanner-recent-item .name {
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .scanner-recent-item .time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .scanner-recent-item .badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .scanner-recent-item .badge.new {
      background: #dcfce7;
      color: #166534;
    }
    
    .scanner-recent-item .badge.existing {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Scan Result Toast - BIG for in-class visibility */
    .scan-result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 60px 80px;
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
      border-radius: 32px;
      box-shadow: 0 20px 80px rgba(5, 150, 105, 0.5), 0 0 0 8px rgba(5, 150, 105, 0.2);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10000;
      text-align: center;
      min-width: 500px;
    }
    
    .scan-result-toast.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    
    .scan-result-toast.error {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 20px 80px rgba(220, 38, 38, 0.5), 0 0 0 8px rgba(220, 38, 38, 0.2);
    }
    
    .scan-result-toast.checking {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 20px 80px rgba(59, 130, 246, 0.5), 0 0 0 8px rgba(59, 130, 246, 0.2);
    }
    
    .scan-result-icon {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 4rem;
    }
    
    .scan-result-name {
      font-size: 3.5rem;
      font-weight: 800;
      letter-spacing: -1px;
    }
    
    .scan-result-message {
      font-size: 1.75rem;
      opacity: 0.9;
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      .scan-result-toast {
        min-width: 90vw;
        padding: 40px;
      }
      .scan-result-icon {
        width: 80px;
        height: 80px;
        font-size: 2.5rem;
      }
      .scan-result-name {
        font-size: 2rem;
      }
      .scan-result-message {
        font-size: 1.25rem;
      }
    }
    
    /* ============================================
       SORTABLE TABLES
       ============================================ */
    
    .sortable-table th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: background 0.15s;
    }
    
    .sortable-table th.sortable:hover {
      background: rgba(59, 130, 246, 0.1);
    }
    
    .sortable-table th.sortable .sort-icon {
      display: inline-flex;
      flex-direction: column;
      margin-left: 6px;
      vertical-align: middle;
      opacity: 0.3;
      font-size: 0.65rem;
      line-height: 0.5;
    }
    
    .sortable-table th.sortable:hover .sort-icon {
      opacity: 0.6;
    }
    
    .sortable-table th.sortable.asc .sort-icon,
    .sortable-table th.sortable.desc .sort-icon {
      opacity: 1;
      color: var(--primary);
    }
    
    .sortable-table th.sortable.asc .sort-icon .sort-asc,
    .sortable-table th.sortable.desc .sort-icon .sort-desc {
      color: var(--primary);
    }
    
    .sortable-table th.sortable .sort-icon .sort-asc,
    .sortable-table th.sortable .sort-icon .sort-desc {
      transition: color 0.15s;
    }
    
    .sortable-table th.sortable.asc .sort-icon .sort-desc,
    .sortable-table th.sortable.desc .sort-icon .sort-asc {
      opacity: 0.3;
    }
    
    /* ============================================
       HISTORY TAB STYLES
       ============================================ */
    
    .history-filters {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      background: var(--bg-card);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .history-filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 150px;
      max-width: 250px;
    }
    
    .history-filter-group.small {
      flex: 0 0 140px;
      min-width: 140px;
    }
    
    .history-filter-group label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .history-filter-select,
    .history-filter-date,
    .history-filter-input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-dark);
      font-size: 0.85rem;
      color: var(--text-primary);
      width: 100%;
    }
    
    .history-filter-select:focus,
    .history-filter-date:focus,
    .history-filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Searchable dropdown for history */
    .history-program-dropdown {
      position: relative;
    }
    
    .history-program-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .history-program-dropdown .dropdown-list.show {
      display: block;
    }
    
    .history-program-dropdown .dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }
    
    .history-program-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .history-program-dropdown .dropdown-item:hover {
      background: var(--primary);
      color: white;
    }
    
    .history-filter-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    .history-export-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .history-export-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .history-export-btn.icon-only {
      padding: 10px;
    }
    
    .history-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .history-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .history-stat {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .history-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 6px;
    }
    
    .history-stat-value.success { color: #059669; }
    .history-stat-value.warning { color: #d97706; }
    
    .history-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .history-table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .history-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
    }
    
    .history-table td {
      padding: 14px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    
    .history-table tr:last-child td {
      border-bottom: none;
    }
    
    .history-table tr:hover td {
      background: #fafbfc;
    }
    
    .history-table .history-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .history-emp-name {
      font-weight: 500;
    }
    
    .history-emp-id {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .history-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .history-status.enrolled {
      background: #dcfce7;
      color: #166534;
    }
    
    .history-status.existing {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Print Styles for QR Cards */
    @media print {
      body * { visibility: hidden; }
      #qrPrintArea, #qrPrintArea * { visibility: visible; }
      #qrPrintArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .qr-print-card {
        width: 3.5in;
        height: 2.2in;
        page-break-inside: avoid;
        display: inline-block;
        margin: 0.1in;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.2in;
        background: white;
        font-family: Arial, sans-serif;
        color: #1e293b;
      }
      .qr-print-card .qr-code {
        float: left;
        margin-right: 0.15in;
        padding: 0.05in;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
      }
      .qr-print-card .qr-code canvas,
      .qr-print-card .qr-code img {
        width: 1.4in !important;
        height: 1.4in !important;
        display: block;
      }
      .qr-print-card .info {
        overflow: hidden;
      }
      .qr-print-card .company {
        font-size: 8pt;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 6px;
      }
      .qr-print-card .name {
        font-size: 14pt;
        font-weight: bold;
        margin-bottom: 2px;
        color: #0f172a;
      }
      .qr-print-card .id {
        font-size: 10pt;
        color: #64748b;
        margin-bottom: 8px;
      }
      .qr-print-card .entity {
        font-size: 9pt;
        color: #475569;
      }
    }

    /* QR Session Filter Bar */
    .qr-session-filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: 10px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .qr-session-filter-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #0369a1;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .qr-date-filter {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .qr-date-filter label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #0369a1;
      font-weight: 600;
    }
    
    .qr-filter-date {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      font-size: 0.9rem;
      min-width: 150px;
    }
    
    .qr-clear-filter-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .qr-clear-filter-btn:hover {
      background: #fee2e2;
      border-color: #fecaca;
      color: #dc2626;
    }

    /* ============================================
       SCANNER SETUP PANEL STYLES
       ============================================ */

    /* Today's Sessions Container */
    .today-sessions-container {
      margin-top: 1.5rem;
    }
    
    .today-sessions-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    .today-sessions-loading i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    /* Session Card in List */
    .today-session-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .today-session-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
      transform: translateY(-2px);
    }
    
    .today-session-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .today-session-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .today-session-program {
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 500;
    }
    
    .today-session-badge {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .today-session-details {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .today-session-detail {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .today-session-detail i {
      color: var(--text-muted);
      font-size: 1rem;
    }
    
    .today-session-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
      color: var(--primary);
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .today-session-action i {
      font-size: 1.1rem;
    }
    
    /* No Sessions Message */
    .no-sessions-message {
      text-align: center;
      padding: 3rem 2rem;
      background: #f8fafc;
      border-radius: 12px;
      margin-top: 1.5rem;
    }
    
    .no-sessions-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
    }
    
    .no-sessions-icon i {
      font-size: 2.5rem;
      color: #ef4444;
    }
    
    .no-sessions-message h4 {
      font-size: 1.25rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .no-sessions-message p {
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    
    .no-sessions-hint {
      font-size: 0.85rem !important;
      font-style: italic;
    }
    
    .scanner-setup-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .scanner-setup-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .scanner-setup-icon {
      font-size: 2.5rem;
    }
    
    .scanner-setup-header h3 {
      margin: 0 0 4px;
      font-size: 1.25rem;
      color: var(--text-primary);
    }
    
    .scanner-setup-header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    /* Scanner Active Panel */
    .scanner-active-panel {
      animation: fadeIn 0.3s ease;
    }
    
    .scanner-active-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
      border: 1px solid #86efac;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    
    .scanner-active-session {
      font-weight: 600;
      font-size: 1.1rem;
      color: #166534;
    }
    
    .scanner-active-program {
      font-size: 0.85rem;
      color: #15803d;
    }
    
    .scanner-change-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: white;
      border: 1px solid #86efac;
      border-radius: 8px;
      color: #166534;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scanner-change-btn:hover {
      background: #f0fdf4;
    }
    
    /* Scanner Mode Toggle */
    .scanner-mode-toggle {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    
    .scanner-mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scanner-mode-btn:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    
    .scanner-mode-btn.active {
      background: var(--primary);
      color: white;
    }
    
    /* Reader Mode Container */
    .reader-mode-container {
      text-align: center;
      padding: 40px 20px;
    }
    
    .reader-mode-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-radius: 50%;
      display: grid;
      place-items: center;
    }
    
    .reader-mode-icon i {
      font-size: 2.5rem;
      color: var(--primary);
    }
    
    .reader-mode-container h3 {
      margin: 0 0 8px;
      color: var(--text-primary);
    }
    
    .reader-mode-container > p {
      margin: 0 0 24px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .reader-mode-input {
      width: 100%;
      max-width: 400px;
      padding: 16px 20px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 1.1rem;
      text-align: center;
      background: #eff6ff;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .reader-mode-input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }
    
    .reader-mode-input::placeholder {
      color: #93c5fd;
    }
    
    .reader-mode-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 16px;
      padding: 10px 16px;
      background: #fef3c7;
      border-radius: 8px;
      color: #92400e;
      font-size: 0.85rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ============================================
       EMAIL MODAL STYLES
       ============================================ */
    
    .email-preview-section {
      padding: 0;
    }
    
    .email-recipients-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #eff6ff;
      border-radius: 10px;
      margin-bottom: 16px;
      color: var(--primary);
    }
    
    .email-template-toggle {
      margin-bottom: 16px;
    }
    
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .toggle-label input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .email-preview-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .email-preview-header {
      padding: 12px 16px;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    
    .email-preview-body {
      padding: 16px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .email-preview-body p {
      margin: 0 0 12px;
    }
    
    .email-preview-qr {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .email-preview-trainings {
      padding: 12px;
      background: #f0fdf4;
      border-radius: 8px;
      color: #166534;
      margin-bottom: 12px;
    }
    
    .email-custom-section {
      padding: 16px;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .email-options {
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    /* GLOBAL Badge */
    .badge-global {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      font-size: 0.5rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 2px 5px;
      border-radius: 10px;
      text-transform: uppercase;
      box-shadow: 0 1px 2px rgba(99, 102, 241, 0.25);
      margin-left: 6px;
      vertical-align: middle;
      display: inline-block;
    }
    
    /* NEW Badge (green) */
    .badge-new {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 0.5rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 2px 5px;
      border-radius: 10px;
      text-transform: uppercase;
      box-shadow: 0 1px 2px rgba(34, 197, 94, 0.25);
      margin-left: 6px;
      vertical-align: middle;
      display: inline-block;
      animation: badge-pulse 2s ease-in-out infinite;
    }
    
    /* JUST MODIFIED Badge (orange) */
    .badge-modified {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      font-size: 0.5rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 2px 5px;
      border-radius: 10px;
      text-transform: uppercase;
      box-shadow: 0 1px 2px rgba(245, 158, 11, 0.25);
      margin-left: 6px;
      vertical-align: middle;
      display: inline-block;
      animation: badge-pulse 2s ease-in-out infinite;
    }
    
    @keyframes badge-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* View-only session modal */
    .view-only-notice {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .view-only-notice i {
      font-size: 1.2rem;
    }
    
    /* Clickable session count in program cards */
    .session-count-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s;
    }
    
    .session-count-link:hover {
      color: var(--primary-dark);
    }
    
    /* ==================== */
    /* WALKTHROUGH SYSTEM   */
    /* ==================== */
    
    .walkthrough-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .walkthrough-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .walkthrough-spotlight {
      position: fixed;
      background: transparent;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      border-radius: 12px;
      transition: all 0.4s ease;
      z-index: 9999;
      pointer-events: none;
      display: none;
    }
    
    .walkthrough-spotlight.active {
      display: block;
    }
    
    .walkthrough-tooltip {
      position: fixed;
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      width: 360px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      animation: tooltipIn 0.3s ease;
    }
    
    .walkthrough-tooltip.active {
      display: block;
    }
    
    @keyframes tooltipIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tooltip-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 0.75rem;
    }
    
    .tooltip-step-badge {
      width: 28px;
      height: 28px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
    }
    
    .tooltip-step-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tooltip-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .tooltip-desc {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 1.25rem;
    }
    
    .tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tooltip-progress {
      display: flex;
      gap: 6px;
    }
    
    .tooltip-progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s;
    }
    
    .tooltip-progress-dot.active {
      background: var(--primary);
      width: 20px;
      border-radius: 4px;
    }
    
    .tooltip-progress-dot.completed {
      background: var(--primary);
    }
    
    .tooltip-btns {
      display: flex;
      gap: 0.5rem;
    }
    
    .tooltip-btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .tooltip-btn.skip {
      background: transparent;
      color: var(--text-muted);
    }
    
    .tooltip-btn.skip:hover {
      color: var(--text-primary);
    }
    
    .tooltip-btn.prev {
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    .tooltip-btn.next {
      background: var(--primary);
      color: white;
    }
    
    .tooltip-btn.next:hover {
      background: var(--primary-dark);
    }
    
    .tooltip-arrow {
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      transform: rotate(45deg);
    }
    
    .tooltip-arrow.left { left: -8px; top: 30px; }
    .tooltip-arrow.right { right: -8px; top: 30px; }
    .tooltip-arrow.top { top: -8px; left: 30px; }
    .tooltip-arrow.bottom { bottom: -8px; left: 30px; }
    
    /* Welcome Modal */
    .welcome-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 20px;
      padding: 2.5rem;
      width: 500px;
      max-width: 90vw;
      text-align: center;
      z-index: 10001;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      display: none;
    }
    
    .welcome-modal.active {
      display: block;
      animation: modalIn 0.4s ease;
    }
    
    @keyframes modalIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    
    .welcome-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary) 0%, #22c55e 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2.5rem;
      color: white;
    }
    
    .welcome-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }
    
    .welcome-desc {
      font-size: 1rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }
    
    .welcome-features {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .welcome-feature {
      text-align: center;
    }
    
    .welcome-feature i {
      font-size: 1.75rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .welcome-feature span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .welcome-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    
    .welcome-btn {
      padding: 0.875rem 1.75rem;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .welcome-btn.primary {
      background: var(--primary);
      color: white;
    }
    
    .welcome-btn.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .welcome-btn.secondary {
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    /* Help Button */
    .help-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 1.2rem;
      transition: all 0.2s;
      position: relative;
    }
    
    .help-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .help-btn.pulse {
      animation: helpPulse 2s infinite;
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    @keyframes helpPulse {
      0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); }
      70% { box-shadow: 0 0 0 12px rgba(22, 163, 74, 0); }
      100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
    }
    
    /* Help Menu Dropdown */
    .help-menu {
      position: absolute;
      top: calc(100% + 10px);
      right: 0;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      width: 300px;
      padding: 1rem 0;
      display: none;
      z-index: 9000;
    }
    
    .help-menu.active {
      display: block;
      animation: menuIn 0.2s ease;
    }
    
    @keyframes menuIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .help-menu-header {
      padding: 0.5rem 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }
    
    .help-menu-header h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .help-menu-item {
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .help-menu-item:hover {
      background: var(--bg-card-hover);
    }
    
    .help-menu-item i {
      font-size: 1.25rem;
      color: var(--primary);
      width: 28px;
      text-align: center;
    }
    
    .help-menu-item-content {
      flex: 1;
    }
    
    .help-menu-item-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .help-menu-item-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .help-menu-item.highlight {
      background: linear-gradient(135deg, var(--primary) 0%, #15803d 100%);
      margin: 0 0.5rem 0.5rem;
      border-radius: 10px;
      padding: 1rem;
    }
    
    .help-menu-item.highlight i,
    .help-menu-item.highlight .help-menu-item-title,
    .help-menu-item.highlight .help-menu-item-desc {
      color: white !important;
    }
    
    .help-menu-item.highlight:hover {
      background: linear-gradient(135deg, #15803d 0%, #166534 100%);
    }
    
    .help-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 0.5rem 1rem;
    }
    
    .help-menu-section-title {
      padding: 0.5rem 1.25rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color: var(--text-secondary);" id="loadingText">Loading...</div>
  </div>
  
  <!-- Progress Modal for Bulk Operations -->
  <div id="progressModalContainer" style="display:none;">
    <div class="progress-modal-backdrop"></div>
    <div class="progress-modal">
      <div class="progress-header">
        <div class="progress-title" id="progressTitle">Processing...</div>
        <div class="progress-count"><span id="progressCurrent">0</span> of <span id="progressTotal">0</span></div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
      </div>
      <div class="progress-status">
        <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>
        <span id="progressStatusText">Initializing...</span>
      </div>
    </div>
  </div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i class="ri-graduation-cap-fill"></i>
          <span>Training Management System</span>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <div class="nav-item active" data-page="calendar">
            <i class="ri-calendar-line"></i>
            <span>Calendar</span>
          </div>
          <div class="nav-item" data-page="analytics">
            <i class="ri-bar-chart-box-line"></i>
            <span>Analytics</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Management</div>
          <div class="nav-item" data-page="programs">
            <i class="ri-book-2-line"></i>
            <span>Programs</span>
          </div>
          <div class="nav-item" data-page="sessions">
            <i class="ri-presentation-line"></i>
            <span>Sessions</span>
          </div>
          <div class="nav-item" data-page="participants">
            <i class="ri-team-line"></i>
            <span>Participants</span>
          </div>
          <div class="nav-item" data-page="qr-attendance">
            <i class="ri-qr-scan-2-line"></i>
            <span>QR Attendance</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Reports</div>
          <div class="nav-item" data-page="reports">
            <i class="ri-file-chart-line"></i>
            <span>Reports</span>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">--</div>
          <div class="user-details">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-role" id="userRole">--</div>
          </div>
          <button class="logout-btn" onclick="handleLogout()" title="Logout">
            <i class="ri-logout-box-r-line"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <h1 class="header-title" id="pageTitle">Training Calendar</h1>
        <div class="header-actions" id="headerActions">
          <button class="btn btn-primary" id="primaryAction" onclick="handlePrimaryAction()">
            <i class="ri-add-line"></i>
            <span id="primaryActionText">New Training</span>
          </button>
          <!-- Help Button -->
          <div style="position:relative;">
            <button class="help-btn" id="helpBtn" onclick="toggleHelpMenu(event)" title="Help & Guides">
              <i class="ri-question-line"></i>
            </button>
            <!-- Help Menu Dropdown -->
            <div class="help-menu" id="helpMenu">
              <div class="help-menu-header">
                <h3><i class="ri-book-open-line"></i> Help & Guides</h3>
              </div>
              <div class="help-menu-item highlight" onclick="startQuickTour()">
                <i class="ri-rocket-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Quick Tour</div>
                  <div class="help-menu-item-desc">Overview of all modules (2 min)</div>
                </div>
              </div>
              <div class="help-menu-section-title">Module Guides</div>
              <div class="help-menu-item" onclick="startGuide('calendar')">
                <i class="ri-calendar-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Calendar Guide</div>
                  <div class="help-menu-item-desc">5 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('analytics')">
                <i class="ri-bar-chart-box-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Analytics Guide</div>
                  <div class="help-menu-item-desc">4 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('programs')">
                <i class="ri-book-2-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Programs Guide</div>
                  <div class="help-menu-item-desc">4 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('sessions')">
                <i class="ri-calendar-event-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Sessions Guide</div>
                  <div class="help-menu-item-desc">8 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('participants')">
                <i class="ri-team-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Participants Guide</div>
                  <div class="help-menu-item-desc">4 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('qr')">
                <i class="ri-qr-scan-2-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">QR Attendance Guide</div>
                  <div class="help-menu-item-desc">6 steps</div>
                </div>
              </div>
              <div class="help-menu-item" onclick="startGuide('reports')">
                <i class="ri-file-chart-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Reports Guide</div>
                  <div class="help-menu-item-desc">3 steps</div>
                </div>
              </div>
              <div class="help-menu-divider"></div>
              <div class="help-menu-item" onclick="showTipsModal()">
                <i class="ri-lightbulb-line"></i>
                <div class="help-menu-item-content">
                  <div class="help-menu-item-title">Tips & Shortcuts</div>
                  <div class="help-menu-item-desc">Keyboard shortcuts & pro tips</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="content">
        <!-- Calendar Page (5-Month View + Monthly View) -->
        <section class="page-section active" id="page-calendar">
          <!-- Stats Cards - Full Width -->
          <div class="stats-grid" style="grid-template-columns:repeat(4, 1fr); gap:1rem; margin-bottom:1.5rem;">
            <div class="stat-card" style="padding:1rem;">
              <div class="stat-icon blue" style="width:36px; height:36px;"><i class="ri-presentation-line" style="font-size:1rem;"></i></div>
              <div class="stat-value" id="statTotalSessions">0</div>
              <div class="stat-label">Total Sessions</div>
            </div>
            <div class="stat-card" style="padding:1rem;">
              <div class="stat-icon green" style="width:36px; height:36px;"><i class="ri-check-double-line" style="font-size:1rem;"></i></div>
              <div class="stat-value" id="statCompleted">0</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card" style="padding:1rem;">
              <div class="stat-icon yellow" style="width:36px; height:36px;"><i class="ri-time-line" style="font-size:1rem;"></i></div>
              <div class="stat-value" id="statUpcoming">0</div>
              <div class="stat-label">Upcoming</div>
            </div>
            <div class="stat-card" style="padding:1rem;">
              <div class="stat-icon purple" style="width:36px; height:36px;"><i class="ri-team-line" style="font-size:1rem;"></i></div>
              <div class="stat-value" id="statParticipants">0</div>
              <div class="stat-label">Unique Participants</div>
            </div>
          </div>

          <!-- Calendar Navigation -->
          <div class="calendar-nav-container">
            <div style="display:flex; align-items:center; gap:1rem;">
              <div class="calendar-nav">
                <button class="nav-btn" onclick="changeYear(-1)" title="Previous Year">
                  <i class="ri-arrow-left-double-line"></i>
                </button>
                <button class="nav-btn" onclick="changeMonth(-1)" title="Previous Month">
                  <i class="ri-arrow-left-s-line"></i>
                </button>
                <div class="calendar-month-display" id="calendarMonthDisplay">Loading...</div>
                <button class="nav-btn" onclick="changeMonth(1)" title="Next Month">
                  <i class="ri-arrow-right-s-line"></i>
                </button>
                <button class="nav-btn" onclick="changeYear(1)" title="Next Year">
                  <i class="ri-arrow-right-double-line"></i>
                </button>
              </div>
              <button class="btn btn-secondary btn-sm" onclick="goToToday()">Today</button>
              <!-- Entity Filter -->
              <div class="calendar-filters" id="calendarFilters" style="display:none;">
                <select class="form-select" style="width:140px;" id="filterCalendarEntity" onchange="applyCalendarFilters()">
                  <option value="all">All Entities</option>
                </select>
              </div>
            </div>
            
            <div style="display:flex; gap:1rem; align-items:center;">
              <!-- View Toggle -->
              <div class="view-toggle">
                <button class="view-toggle-btn active" id="view5Month" onclick="switchCalendarView('5month')">
                  <i class="ri-layout-column-line"></i> 5-Month
                </button>
                <button class="view-toggle-btn" id="viewMonthly" onclick="switchCalendarView('monthly')">
                  <i class="ri-calendar-line"></i> Monthly
                </button>
              </div>
              
              <div class="search-container" style="width:200px;">
                <i class="ri-search-line search-icon"></i>
                <input type="text" class="search-input" id="calendarSearch" placeholder="Search programs..." oninput="filterCalendarPrograms()">
              </div>
            </div>
          </div>
          
          <!-- 5-Month View -->
          <div class="calendar-5month" id="calendar5Month"></div>
          
          <!-- Monthly Calendar View -->
          <div class="monthly-calendar hidden" id="monthlyCalendar">
            <div class="monthly-header">
              <div class="monthly-nav">
                <button class="monthly-nav-btn" onclick="changeMonth(-1)"><i class="ri-arrow-left-s-line"></i></button>
                <button class="monthly-nav-btn" onclick="changeMonth(1)"><i class="ri-arrow-right-s-line"></i></button>
              </div>
              <div class="monthly-title" id="monthlyTitle">December 2025</div>
              <div style="display:flex; gap:0.5rem;">
                <button class="btn btn-secondary btn-sm" onclick="goToToday()"><i class="ri-focus-line"></i> Today</button>
                <button class="btn btn-secondary btn-sm" onclick="downloadCalendarPDF()"><i class="ri-download-line"></i> PDF</button>
              </div>
            </div>
            <div class="monthly-weekdays">
              <div class="monthly-weekday">Sun</div>
              <div class="monthly-weekday">Mon</div>
              <div class="monthly-weekday">Tue</div>
              <div class="monthly-weekday">Wed</div>
              <div class="monthly-weekday">Thu</div>
              <div class="monthly-weekday">Fri</div>
              <div class="monthly-weekday">Sat</div>
            </div>
            <div class="monthly-days" id="monthlyDays"></div>
          </div>
        </section>

        <!-- Analytics Page -->
        <section class="page-section" id="page-analytics">
          <div class="analytics-container">
            <!-- Header with Filters -->
            <div class="analytics-header">
              <div class="analytics-title">
                <i class="ri-bar-chart-box-line"></i>
                Training Analytics
              </div>
              <div style="display:flex; align-items:center; gap:0.75rem;">
                <div class="cache-indicator" id="analyticsCacheIndicator" style="display:none;">
                  <div class="cache-dot"></div>
                  <span>Cached  <span id="analyticsCacheTime">Updated just now</span></span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="refreshAnalyticsData()" title="Refresh data">
                  <i class="ri-refresh-line"></i>
                </button>
              </div>
            </div>
            
            <!-- Filters Section -->
            <div class="analytics-filters-section">
              <div class="filters-row">
                <!-- Period Type Toggle -->
                <div class="filter-group">
                  <label>View By</label>
                  <div class="period-toggle">
                    <button type="button" class="period-toggle-btn" data-period="yearly" onclick="setPeriodType('yearly')">Yearly</button>
                    <button type="button" class="period-toggle-btn" data-period="quarterly" onclick="setPeriodType('quarterly')">Quarterly</button>
                    <button type="button" class="period-toggle-btn active" data-period="monthly" onclick="setPeriodType('monthly')">Monthly</button>
                  </div>
                </div>
                
                <!-- Year Dropdown -->
                <div class="filter-group">
                  <label>Year</label>
                  <select id="analyticsYear" onchange="onYearChange()">
                    <option value="2025">2025</option>
                  </select>
                </div>
                
                <!-- Period Dropdown (Quarter or Month based on toggle) -->
                <div class="filter-group" id="periodFilterGroup">
                  <label id="periodFilterLabel">Month</label>
                  <select id="analyticsPeriod" onchange="onAnalyticsFilterChange()">
                    <option value="12">December</option>
                  </select>
                </div>
                
                <!-- Entity Filter -->
                <div class="filter-group">
                  <label>Entity</label>
                  <select id="analyticsEntity" onchange="onAnalyticsFilterChange()">
                    <option value="">All Entities</option>
                  </select>
                </div>
                
                <!-- Function Filter -->
                <div class="filter-group">
                  <label>Function</label>
                  <select id="analyticsFunction" onchange="onAnalyticsFilterChange()">
                    <option value="">All Functions</option>
                  </select>
                </div>
                
                <!-- Sub-Function Filter -->
                <div class="filter-group">
                  <label>Sub-Function</label>
                  <select id="analyticsSubFunction" onchange="onAnalyticsFilterChange()">
                    <option value="">All Sub-Functions</option>
                  </select>
                </div>
                
                <!-- Job Band Filter -->
                <div class="filter-group">
                  <label>Job Band</label>
                  <select id="analyticsJobBand" onchange="onAnalyticsFilterChange()">
                    <option value="">All Job Bands</option>
                  </select>
                </div>
                
                <!-- Program Filter -->
                <div class="filter-group">
                  <label>Program</label>
                  <select id="analyticsProgram" onchange="onAnalyticsFilterChange()">
                    <option value="">All Programs</option>
                  </select>
                </div>
                
                <!-- Action Buttons -->
                <div class="filter-actions">
                  <button class="btn btn-secondary btn-sm" onclick="resetAnalyticsFilters()">
                    <i class="ri-refresh-line"></i> Reset
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="exportAnalyticsPDF()">
                    <i class="ri-file-pdf-line"></i> Export
                  </button>
                </div>
              </div>
            </div>

            <!-- KPI Cards Row 1 -->
            <div class="kpi-grid">
              <div class="kpi-card blue">
                <div class="kpi-icon"><i class="ri-time-line"></i></div>
                <div class="kpi-value" id="kpiTotalHours">--</div>
                <div class="kpi-label">Total Learning Hours</div>
              </div>
              <div class="kpi-card blue">
                <div class="kpi-icon"><i class="ri-user-line"></i></div>
                <div class="kpi-value" id="kpiAvgHoursPerEmp">--</div>
                <div class="kpi-label">Avg Hours / Employee</div>
              </div>
              <div class="kpi-card green">
                <div class="kpi-icon"><i class="ri-checkbox-circle-line"></i></div>
                <div class="kpi-value" id="kpiCompletionRate">--</div>
                <div class="kpi-label">Completion Rate</div>
              </div>
              <div class="kpi-card purple">
                <div class="kpi-icon"><i class="ri-group-line"></i></div>
                <div class="kpi-value" id="kpiUniqueLearners">--</div>
                <div class="kpi-label">Unique Learners</div>
              </div>
            </div>

            <!-- KPI Cards Row 2 (Cost-related - can be hidden) -->
            <div class="kpi-grid" id="costKPIRow">
              <div class="kpi-card orange">
                <div class="kpi-icon"><i class="ri-money-dollar-circle-line"></i></div>
                <div class="kpi-value" id="kpiTotalCost">--</div>
                <div class="kpi-label">Total Learning Cost</div>
              </div>
              <div class="kpi-card orange">
                <div class="kpi-icon"><i class="ri-user-star-line"></i></div>
                <div class="kpi-value" id="kpiAvgCostPerEmp">--</div>
                <div class="kpi-label">Avg Cost / Employee</div>
              </div>
              <div class="kpi-card orange">
                <div class="kpi-icon"><i class="ri-funds-line"></i></div>
                <div class="kpi-value" id="kpiBudgetUtil">--</div>
                <div class="kpi-label">Budget Utilization</div>
              </div>
              <div class="kpi-card purple">
                <div class="kpi-icon"><i class="ri-star-line"></i></div>
                <div class="kpi-value" id="kpiAvgSatisfaction">--</div>
                <div class="kpi-label">Avg Satisfaction</div>
              </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="charts-grid">
              <div class="chart-card">
                <div class="chart-title"><i class="ri-pie-chart-line"></i> Learning Hours by Category</div>
                <div class="chart-container pie" data-canvas-id="chartHoursByCategory">
                  <canvas id="chartHoursByCategory"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title"><i class="ri-pie-chart-line"></i> Learning Hours by Channel</div>
                <div class="chart-container pie" data-canvas-id="chartHoursByChannel">
                  <canvas id="chartHoursByChannel"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title"><i class="ri-bar-chart-horizontal-line"></i> Completion % by Category</div>
                <div class="chart-container" data-canvas-id="chartCompletionByCategory">
                  <canvas id="chartCompletionByCategory"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title"><i class="ri-bar-chart-horizontal-line"></i> Completion % by Entity</div>
                <div class="chart-container" data-canvas-id="chartCompletionByEntity">
                  <canvas id="chartCompletionByEntity"></canvas>
                </div>
              </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="charts-grid">
              <div class="chart-card">
                <div class="chart-title"><i class="ri-bar-chart-horizontal-line"></i> Learning Hours by Entity</div>
                <div class="chart-container" data-canvas-id="chartHoursByEntity">
                  <canvas id="chartHoursByEntity"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <div class="chart-title"><i class="ri-bar-chart-horizontal-line"></i> Learning Hours by Function</div>
                <div class="chart-container" data-canvas-id="chartHoursByFunction">
                  <canvas id="chartHoursByFunction"></canvas>
                </div>
              </div>
              <div class="chart-card" id="chartCardSpendByEntity">
                <div class="chart-title"><i class="ri-money-dollar-box-line"></i> Top Spend by Entity (USD)</div>
                <div class="chart-container" data-canvas-id="chartSpendByEntity">
                  <canvas id="chartSpendByEntity"></canvas>
                </div>
              </div>
              <div class="chart-card" id="chartCardBudgetByEntity">
                <div class="chart-title"><i class="ri-percent-line"></i> Top Budget Utilization by Entity</div>
                <div class="chart-container" data-canvas-id="chartBudgetByEntity">
                  <canvas id="chartBudgetByEntity"></canvas>
                </div>
              </div>
            </div>

            <!-- Individual Development Section -->
            <div class="indiv-dev-section">
              <div class="indiv-dev-header">
                <label class="indiv-dev-toggle">
                  <input type="checkbox" id="showIndivDev" onchange="toggleIndivDevTable()">
                  <i class="ri-user-star-line"></i>
                  Individual Development Records
                  <span id="indivDevCount" style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:0.75rem; margin-left:8px;">0</span>
                </label>
              </div>
              <div class="indiv-dev-content" id="indivDevContent">
                <table class="indiv-dev-table">
                  <thead>
                    <tr>
                      <th>Entity</th>
                      <th>Employee</th>
                      <th>Program</th>
                      <th>Session</th>
                      <th>Date</th>
                      <th>Currency</th>
                      <th>Cost</th>
                      <th>Cost (USD)</th>
                    </tr>
                  </thead>
                  <tbody id="indivDevTableBody">
                    <tr><td colspan="8" class="indiv-dev-empty">No individual development records</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Programs Page -->
        <section class="page-section" id="page-programs">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h2 style="margin:0; font-size:1.25rem; font-weight:600;">Training Programs</h2>
            <button id="newProgramBtn" class="btn btn-primary" onclick="openNewProgramModal()" style="display:none;">
              <i class="ri-add-line"></i> New Program
            </button>
          </div>
          <div id="programsGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:1.5rem;"></div>
        </section>

        <!-- Sessions Page -->
        <section class="page-section" id="page-sessions">
          <div style="background:white; border-radius:0.75rem; border:1px solid var(--border); overflow:hidden;">
            <div style="padding:1rem 1.5rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem;">
              <div style="font-weight:600;">All Sessions</div>
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <select class="form-select" style="width:100px;" id="filterYear" onchange="renderSessionsTable()">
                  <option value="">Year</option>
                </select>
                <select class="form-select" style="width:110px;" id="filterMonth" onchange="renderSessionsTable()">
                  <option value="">Month</option>
                  <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                  <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                  <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
                  <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>
                <div class="search-container" style="width:200px;">
                  <i class="ri-search-line search-icon"></i>
                  <input type="text" class="search-input" id="filterProgramSearch" placeholder="Search program..." oninput="renderSessionsTable()">
                </div>
                <select class="form-select" style="width:130px;" id="filterStatus" onchange="renderSessionsTable()">
                  <option value="">All Status</option>
                  <option value="Open">Open</option>
                  <option value="Completed">Completed</option>
                </select>
                <button class="btn btn-secondary btn-sm btn-icon" onclick="clearSessionFilters()" title="Clear filters"><i class="ri-filter-off-line"></i></button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="sortable-table" id="sessionsTable" style="width:100%; border-collapse:collapse; min-width:900px;">
                <thead>
                  <tr style="background:var(--bg-card-hover);">
                    <th class="sortable" data-sort="name" onclick="sortSessionsTable('name')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Session <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="programName" onclick="sortSessionsTable('programName')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Program <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="entity" onclick="sortSessionsTable('entity')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Entity <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="type" onclick="sortSessionsTable('type')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Type <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="date" onclick="sortSessionsTable('date')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Date <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="participants" onclick="sortSessionsTable('participants')" style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Participants <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="status" onclick="sortSessionsTable('status')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Status <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted); width:100px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="sessionsTableBody"></tbody>
              </table>
            </div>
            <!-- Sessions Pagination -->
            <div class="pagination-container" id="sessionsPagination">
              <div class="pagination-info">
                Showing <strong><span id="sessionsShowingStart">0</span>-<span id="sessionsShowingEnd">0</span></strong> of <strong><span id="sessionsTotalCount">0</span></strong> sessions
              </div>
              <div class="pagination-controls">
                <button class="page-btn" id="sessionsPrevBtn" onclick="changeSessionsPage(-1)" title="Previous"><i class="ri-arrow-left-s-line"></i></button>
                <div id="sessionsPageNumbers"></div>
                <button class="page-btn" id="sessionsNextBtn" onclick="changeSessionsPage(1)" title="Next"><i class="ri-arrow-right-s-line"></i></button>
                <select class="page-size-select" id="sessionsPageSize" onchange="changeSessionsPageSize()">
                  <option value="25">25 / page</option>
                  <option value="50" selected>50 / page</option>
                  <option value="100">100 / page</option>
                  <option value="200">200 / page</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- Participants Page -->
        <section class="page-section" id="page-participants">
          <div style="background:white; border-radius:0.75rem; border:1px solid var(--border); overflow:hidden;">
            <div style="padding:1rem 1.5rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem;">
              <div style="font-weight:600;">All Participants</div>
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <div class="search-container" style="width:180px;">
                  <i class="ri-search-line search-icon"></i>
                  <input type="text" class="search-input" id="participantsSearch" placeholder="Search name/ID..." oninput="filterParticipantsTable()">
                </div>
                <select class="form-select" style="width:140px;" id="filterParticipantEntity" onchange="filterParticipantsTable()">
                  <option value="">All Entities</option>
                </select>
                <select class="form-select" style="width:160px;" id="filterParticipantFunction" onchange="filterParticipantsTable()">
                  <option value="">All Functions</option>
                </select>
                <select class="form-select" style="width:140px;" id="filterParticipantJobBand" onchange="filterParticipantsTable()">
                  <option value="">All Job Bands</option>
                </select>
                <button class="btn btn-secondary btn-sm btn-icon" onclick="clearParticipantFilters()" title="Clear filters"><i class="ri-filter-off-line"></i></button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="sortable-table" id="participantsPageTable" style="width:100%; border-collapse:collapse; min-width:1000px;">
                <thead>
                  <tr style="background:var(--bg-card-hover);">
                    <th class="sortable" data-sort="name" onclick="sortParticipantsPageTable('name')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Employee <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="entity" onclick="sortParticipantsPageTable('entity')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Entity <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="jobBand" onclick="sortParticipantsPageTable('jobBand')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Job Band <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="function" onclick="sortParticipantsPageTable('function')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Function <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="subFunction" onclick="sortParticipantsPageTable('subFunction')" style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Sub-Function <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Email</th>
                    <th class="sortable" data-sort="sessionCount" onclick="sortParticipantsPageTable('sessionCount')" style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Sessions <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th class="sortable" data-sort="totalHours" onclick="sortParticipantsPageTable('totalHours')" style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Hours <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span></th>
                    <th style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">View</th>
                  </tr>
                </thead>
                <tbody id="participantsPageTableBody"></tbody>
              </table>
            </div>
            <!-- Participants Pagination -->
            <div class="pagination-container" id="participantsPagination">
              <div class="pagination-info">
                Showing <strong><span id="participantsShowingStart">0</span>-<span id="participantsShowingEnd">0</span></strong> of <strong><span id="participantsTotalCount">0</span></strong> participants
              </div>
              <div class="pagination-controls">
                <button class="page-btn" id="participantsPrevBtn" onclick="changeParticipantsPage(-1)" title="Previous"><i class="ri-arrow-left-s-line"></i></button>
                <div id="participantsPageNumbers"></div>
                <button class="page-btn" id="participantsNextBtn" onclick="changeParticipantsPage(1)" title="Next"><i class="ri-arrow-right-s-line"></i></button>
                <select class="page-size-select" id="participantsPageSize" onchange="changeParticipantsPageSize()">
                  <option value="25">25 / page</option>
                  <option value="50" selected>50 / page</option>
                  <option value="100">100 / page</option>
                  <option value="200">200 / page</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- QR Attendance Page -->
        <section class="page-section" id="page-qr-attendance">
          <!-- QR Tabs - Clean Tab Bar -->
          <div class="qr-tab-bar">
            <button class="qr-tab active" id="qrTabCards" onclick="switchQRTab('cards')">
              <i class="ri-id-card-line"></i>
              <span>QR Cards</span>
            </button>
            <button class="qr-tab" id="qrTabScanner" onclick="switchQRTab('scanner')">
              <i class="ri-camera-line"></i>
              <span>Scanner</span>
            </button>
            <button class="qr-tab" id="qrTabHistory" onclick="switchQRTab('history')">
              <i class="ri-history-line"></i>
              <span>History</span>
            </button>
          </div>

          <!-- Tab: Employee QR Cards -->
          <div id="qrCardsTab" class="qr-tab-content">
            <!-- Filters Row -->
            <div class="qr-filters-bar">
              <div class="qr-search-box">
                <i class="ri-search-line"></i>
                <input type="text" id="qrSearchInput" placeholder="Search by name or ID..." oninput="filterQRCards()">
              </div>
              <select class="qr-filter-select" id="qrEntityFilter" onchange="filterQRCards()">
                <option value="all">All Entities</option>
              </select>
              <select class="qr-filter-select" id="qrFunctionFilter" onchange="filterQRCards()">
                <option value="all">All Functions</option>
              </select>
              <button class="qr-icon-btn" onclick="loadQRCards()" title="Refresh">
                <i class="ri-refresh-line"></i>
              </button>
            </div>

            <!-- Action Bar -->
            <div class="qr-action-bar">
              <div class="qr-select-info">
                <label class="qr-checkbox-label">
                  <input type="checkbox" id="selectAllQRCards" onchange="toggleSelectAllQRCards()">
                  <span>Select All</span>
                </label>
                <div class="qr-selected-count" id="qrSelectedCount">0 selected</div>
              </div>
              <div class="qr-action-buttons">
                <button class="qr-action-btn print" id="downloadSelectedBtn" onclick="downloadSelectedQRCards()" disabled>
                  <i class="ri-download-line"></i>
                  <span>Download</span>
                </button>
                <button class="qr-action-btn email" id="emailSelectedBtn" onclick="emailSelectedQRCards()" disabled>
                  <i class="ri-mail-send-line"></i>
                  <span>Email</span>
                </button>
              </div>
            </div>

            <!-- QR Cards Grid -->
            <div id="qrCardsGrid" class="qr-cards-grid"></div>
            
            <!-- Empty State -->
            <div id="qrCardsEmpty" class="qr-empty-state" style="display:none;">
              <div class="qr-empty-icon"><i class="ri-qr-code-line"></i></div>
              <h3>No Employees Found</h3>
              <p>Adjust your filters or add employees to the system.</p>
            </div>
          </div>

          <!-- Tab: Live Scanner -->
          <div id="qrScannerTab" class="qr-tab-content" style="display:none;">
            <!-- Today's Sessions Panel -->
            <div class="scanner-setup-panel" id="scannerSetupPanel">
              <div class="scanner-setup-header">
                <div class="scanner-setup-icon"></div>
                <div>
                  <h3>Today's Training Sessions</h3>
                  <p id="scannerTodayDate">Loading...</p>
                </div>
              </div>
              
              <!-- Today's Sessions List -->
              <div class="today-sessions-container" id="todaySessionsContainer">
                <div class="today-sessions-loading">
                  <i class="ri-loader-4-line ri-spin"></i>
                  <span>Loading today's sessions...</span>
                </div>
              </div>
              
              <!-- No Sessions Message -->
              <div class="no-sessions-message" id="noSessionsMessage" style="display:none;">
                <div class="no-sessions-icon">
                  <i class="ri-calendar-close-line"></i>
                </div>
                <h4>No Sessions Today</h4>
                <p>There are no training sessions scheduled for today.</p>
                <p class="no-sessions-hint">Sessions can only be scanned on their scheduled date.</p>
              </div>
            </div>

            <!-- Active Scanner Panel (shown after confirmation) -->
            <div class="scanner-active-panel" id="scannerActivePanel" style="display:none;">
              <!-- Active Session Header -->
              <div class="scanner-active-header">
                <div class="scanner-active-info">
                  <div class="scanner-active-session" id="activeScannerSession">-</div>
                  <div class="scanner-active-program" id="activeScannerProgram">-</div>
                </div>
                <button class="scanner-change-btn" onclick="changeScannerSession()">
                  <i class="ri-refresh-line"></i> Change Session
                </button>
              </div>

              <!-- Scanner Mode Toggle -->
              <div class="scanner-mode-toggle">
                <button class="scanner-mode-btn active" id="modeCameraBtn" onclick="switchScannerMode('camera')">
                  <i class="ri-camera-line"></i>
                  Camera
                </button>
                <button class="scanner-mode-btn" id="modeReaderBtn" onclick="switchScannerMode('reader')">
                  <i class="ri-barcode-line"></i>
                  USB/Bluetooth Reader
                </button>
              </div>

              <!-- Scanner Layout -->
              <div class="scanner-layout">
                <!-- Left: Scanner -->
                <div class="scanner-main">
                  <!-- Camera Mode -->
                  <div id="cameraModePanel">
                    <div class="scanner-viewport" id="scannerViewport">
                      <div id="qrReader"></div>
                    </div>
                    <div class="scanner-controls">
                      <button class="scanner-ctrl-btn" id="scannerStartStop" onclick="toggleEmbeddedScanner()">
                        <i class="ri-play-fill"></i>
                        <span>Start Camera</span>
                      </button>
                      <select class="scanner-camera-select" id="scannerCameraSelect"></select>
                    </div>
                  </div>
                  
                  <!-- Reader Mode -->
                  <div id="readerModePanel" style="display:none;">
                    <div class="reader-mode-container">
                      <div class="reader-mode-icon">
                        <i class="ri-barcode-box-line"></i>
                      </div>
                      <h3>External Scanner Mode</h3>
                      <p>Connect your USB or Bluetooth barcode/QR scanner and scan directly</p>
                      <input type="text" 
                             class="reader-mode-input" 
                             id="readerInput" 
                             placeholder="Click here, then scan QR code..."
                             autocomplete="off"
                             autocapitalize="off"
                             spellcheck="false"
                             onkeydown="handleReaderKeydown(event)"
                             oninput="handleReaderInput()">
                      <div class="reader-mode-hint">
                        <i class="ri-information-line"></i>
                        Keep this input focused. Scanner will auto-submit after scanning.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Right: Stats & Recent -->
                <div class="scanner-sidebar">
                  <div class="scanner-stat-card highlight">
                    <div class="scanner-stat-value"><span id="scannerCheckedIn">0</span> / <span id="scannerTarget">0</span></div>
                    <div class="scanner-stat-label">Checked In / Target</div>
                  </div>
                  <div class="scanner-stat-row">
                    <div class="scanner-stat-mini">
                      <span class="label">Last Scan</span>
                      <span class="value" id="scannerLastScan">--</span>
                    </div>
                  </div>
                  <div class="scanner-recent">
                    <div class="scanner-recent-header">
                      <i class="ri-time-line"></i>
                      <span>Recent Scans</span>
                    </div>
                    <div class="scanner-recent-list" id="recentScansContainer">
                      <div class="scanner-recent-empty">No scans yet</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scan Result Toast -->
            <div class="scan-result-toast" id="scanResultToast">
              <div class="scan-result-icon"><i class="ri-check-line"></i></div>
              <div class="scan-result-content">
                <div class="scan-result-name" id="scanResultName">-</div>
                <div class="scan-result-message" id="scanResultMessage">-</div>
              </div>
            </div>
          </div>

          <!-- Tab: Scan History -->
          <div id="qrHistoryTab" class="qr-tab-content" style="display:none;">
            <!-- Filters -->
            <div class="history-filters">
              <div class="history-filter-group history-program-dropdown">
                <label>Program</label>
                <input type="text" class="history-filter-input" id="historyProgramSearch" 
                       placeholder="All Programs" 
                       onfocus="showHistoryProgramDropdown()" 
                       onblur="hideHistoryProgramDropdown()"
                       oninput="filterHistoryPrograms(this.value)">
                <input type="hidden" id="historyProgramId" value="">
                <div class="dropdown-list" id="historyProgramDropdown"></div>
              </div>
              <div class="history-filter-group small">
                <label>Date</label>
                <input type="date" class="history-filter-date" id="historyDateFilter" onchange="loadScanHistory()">
              </div>
              <div class="history-filter-group">
                <label>Session</label>
                <select class="history-filter-select" id="historySessionFilter" onchange="loadScanHistory()">
                  <option value="">All Sessions</option>
                </select>
              </div>
              <div class="history-filter-actions">
                <button class="history-export-btn icon-only" onclick="clearHistoryFilters()" title="Clear Filters">
                  <i class="ri-filter-off-line"></i>
                </button>
                <button class="history-export-btn icon-only" onclick="loadScanHistory()" title="Refresh">
                  <i class="ri-refresh-line"></i>
                </button>
                <button class="history-export-btn" onclick="exportScanHistory()">
                  <i class="ri-download-2-line"></i>
                  Export
                </button>
              </div>
            </div>

            <!-- Stats Row -->
            <div class="history-stats">
              <div class="history-stat">
                <div class="history-stat-value" id="historyTotalScans">0</div>
                <div class="history-stat-label">Total Scans</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value" id="historyUniqueEmployees">0</div>
                <div class="history-stat-label">Unique Employees</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value success" id="historyEnrolled">0</div>
                <div class="history-stat-label">New Enrollments</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value warning" id="historyDuplicates">0</div>
                <div class="history-stat-label">Already Enrolled</div>
              </div>
            </div>

            <!-- History Table -->
            <div class="history-table-container">
              <table class="history-table sortable-table" id="historyTable">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="scannedAt" data-type="date" onclick="sortHistoryTable('scannedAt', 'date')">
                      Time <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span>
                    </th>
                    <th class="sortable" data-sort="employeeName" data-type="string" onclick="sortHistoryTable('employeeName', 'string')">
                      Employee <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span>
                    </th>
                    <th class="sortable" data-sort="sessionId" data-type="string" onclick="sortHistoryTable('sessionId', 'string')">
                      Session <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span>
                    </th>
                    <th class="sortable" data-sort="action" data-type="string" onclick="sortHistoryTable('action', 'string')">
                      Status <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span>
                    </th>
                    <th class="sortable" data-sort="scannedBy" data-type="string" onclick="sortHistoryTable('scannedBy', 'string')">
                      Scanned By <span class="sort-icon"><span class="sort-asc"></span><span class="sort-desc"></span></span>
                    </th>
                  </tr>
                </thead>
                <tbody id="scanHistoryTableBody">
                  <tr><td colspan="5" class="history-empty">No scan history found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Reports Page -->
        <section class="page-section" id="page-reports">
          <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-card" style="cursor:pointer;" onclick="openExportModal('program')">
              <div class="stat-icon blue"><i class="ri-file-chart-line"></i></div>
              <div class="stat-value" style="font-size:1.25rem;">Program Report</div>
              <div class="stat-label">Export training calendar PDF</div>
            </div>
            <div class="stat-card" style="cursor:pointer;" onclick="openExportModal('employee')">
              <div class="stat-icon green"><i class="ri-user-line"></i></div>
              <div class="stat-value" style="font-size:1.25rem;">Employee Report</div>
              <div class="stat-label">Export training history PDF</div>
            </div>
            <div class="stat-card" style="cursor:pointer;" onclick="openExportModal('session')">
              <div class="stat-icon" style="background:var(--purple-light, #EDE9FE); color:var(--purple, #7C3AED);"><i class="ri-calendar-event-line"></i></div>
              <div class="stat-value" style="font-size:1.25rem;">Session Report</div>
              <div class="stat-label">Export session attendance PDF</div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Session Form Modal -->
  <div class="modal-overlay" id="sessionModal">
    <div class="modal xlarge">
      <div class="modal-header">
        <div style="display:flex; align-items:center; gap:1rem;">
          <h2 class="modal-title" id="sessionModalTitle">New Training Session</h2>
          <!-- Session ID badge hidden but kept for internal use -->
          <span class="session-badge" id="currentSessionId" style="display:none;">New</span>
        </div>
        <button class="modal-close" onclick="closeSessionModal()"><i class="ri-close-line"></i></button>
      </div>
      
      <!-- Stepper Navigation -->
      <div class="stepper-nav">
        <div class="stepper-item active" id="step1">
          <div class="stepper-circle">1</div>
          <span class="stepper-label">Session Details</span>
        </div>
        <span class="stepper-or">OR</span>
        <div class="stepper-item" id="step2">
          <div class="stepper-circle">2</div>
          <span class="stepper-label">Bulk Create</span>
        </div>
        <div class="stepper-line" id="stepLine1"></div>
        <div class="stepper-item disabled" id="step3">
          <div class="stepper-circle">3</div>
          <span class="stepper-label">Record Attendance</span>
        </div>
        <div class="stepper-line" id="stepLine2"></div>
        <div class="stepper-item disabled" id="step4">
          <div class="stepper-circle">4</div>
          <span class="stepper-label">Survey</span>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="tabs">
          <button class="tab active" data-tab="details" onclick="switchSessionTab('details')" style="display:flex; align-items:center; justify-content:center; gap:6px;">
            <i class="ri-file-list-3-line"></i> Session Details
          </button>
          <button class="tab" data-tab="bulk" onclick="switchSessionTab('bulk')" style="display:flex; align-items:center; justify-content:center; gap:6px;">
            <i class="ri-stack-line"></i> Bulk Create
          </button>
          <button class="tab" data-tab="participants" id="participantsTab" onclick="switchSessionTab('participants')" disabled style="opacity:0.5; display:flex; align-items:center; justify-content:center; gap:6px;">
            <i class="ri-user-follow-line"></i> Record Attendance
          </button>
          <button class="tab" data-tab="survey" id="surveyTab" onclick="switchSessionTab('survey')" disabled style="opacity:0.5; display:flex; align-items:center; justify-content:center; gap:6px;">
            <i class="ri-survey-line"></i> Survey
          </button>
        </div>

        <!-- Details Tab -->
        <div id="tab-details">
          <!-- View-Only Notice (hidden by default) -->
          <div id="viewOnlyNotice" class="view-only-notice" style="display:none;">
            <i class="ri-eye-line"></i>
            <span>You are viewing this session in read-only mode. You don't have permission to edit this session.</span>
          </div>
          
          <div class="form-group">
            <label class="form-label">Program *</label>
            <div style="display:flex; gap:0.5rem;">
              <div style="flex:1; position:relative;">
                <input type="text" class="form-input" id="sessionProgramSearch" placeholder="Search programs..." oninput="filterSessionPrograms()" onfocus="showSessionProgramDropdown()" autocomplete="off" required>
                <input type="hidden" id="sessionProgram" value="">
                <div id="sessionProgramDropdown" style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                  <!-- Populated dynamically -->
                </div>
              </div>
              <button type="button" class="btn btn-secondary btn-sm" onclick="clearSessionProgram()" title="Clear program selection" style="padding:0.5rem 0.75rem;">
                <i class="ri-refresh-line"></i>
              </button>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Session Name *</label>
              <input type="text" class="form-input" id="sessionName" placeholder="e.g., Q1 Leadership Training" required>
            </div>
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="sessionDate" required onchange="autoSetStatus()">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Type *</label>
              <select class="form-select" id="sessionType">
                <option value="Classroom">Classroom</option>
                <option value="E-Learning">E-Learning</option>
                <option value="Online">Online</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status *</label>
              <select class="form-select" id="sessionStatus" disabled style="background:#f1f3f4;">
                <option value="Open">Open</option>
                <option value="Completed">Completed</option>
              </select>
              <div style="font-size:0.7rem; color:var(--text-muted); margin-top:0.25rem;">* Auto-set based on date</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Provider *</label>
              <select class="form-select" id="sessionProvider" onchange="toggleIndivDev()">
                <option value="Internal">Internal</option>
                <option value="External">External</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Entity *</label>
              <select class="form-select" id="sessionEntity" required>
                <option value="">Select Entity...</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Location / Platform</label>
            <input type="text" class="form-input" id="sessionLocation" placeholder="Meeting Room, Zoom, etc.">
          </div>

          <div id="indivDevWrapper" class="form-group hidden">
            <div class="indiv-dev-box">
              <input type="checkbox" id="sessionIndivDev" style="width:auto;">
              <label for="sessionIndivDev">Is this for Individual Development?</label>
              <span style="font-size:0.7rem; color:var(--text-muted); margin-left:auto;">(Enables Cost tracking)</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Duration *</label>
              <div class="stepper-group">
                <button type="button" class="stepper-btn" onclick="adjustDuration(-30)"></button>
                <input type="text" class="form-input stepper-input" id="sessionDuration" value="1:00" readonly>
                <button type="button" class="stepper-btn" onclick="adjustDuration(30)">+</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Avg Satisfaction Score (1-5)</label>
              <div class="score-wrapper">
                <div class="score-stepper" id="scoreStepperContainer">
                  <button type="button" class="score-btn" onclick="adjustScore(-0.5)"></button>
                  <input type="number" class="form-input score-input" id="sessionScore" value="0" step="0.01" min="0" max="5" oninput="updateScoreBar()">
                  <button type="button" class="score-btn" onclick="adjustScore(0.5)">+</button>
                  <div class="score-bar-bg"><div id="scoreBarFill" class="score-bar-fill"></div></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Audit Info (shown only when editing) -->
          <div id="auditInfoGroup" class="form-row" style="display:none; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);">
            <div class="form-group">
              <label class="form-label" style="color:var(--text-muted); font-size:0.75rem;">Last Modified By</label>
              <input type="text" class="form-input" id="sessionCreatedBy" readonly style="background:#f8fafc; color:var(--text-muted); font-size:0.85rem;">
            </div>
            <div class="form-group">
              <label class="form-label" style="color:var(--text-muted); font-size:0.75rem;">Last Modified On</label>
              <input type="text" class="form-input" id="sessionCreatedOn" readonly style="background:#f8fafc; color:var(--text-muted); font-size:0.85rem;">
            </div>
          </div>
        </div>

        <!-- Bulk Create Tab -->
        <div id="tab-bulk" class="hidden">
          <div style="margin-bottom:1rem;">
            <label class="form-label">Program for Bulk Sessions *</label>
            <div style="display:flex; gap:0.5rem;">
              <div style="flex:1; position:relative;">
                <input type="text" class="form-input" id="bulkProgramSearch" placeholder="Search programs..." oninput="filterBulkPrograms()" onfocus="showBulkProgramDropdown()" autocomplete="off">
                <input type="hidden" id="bulkProgram" value="">
                <div id="bulkProgramDropdown" style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid var(--border); border-radius:8px; max-height:200px; overflow-y:auto; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                  <!-- Populated dynamically -->
                </div>
              </div>
              <button type="button" class="btn btn-secondary btn-sm" onclick="clearBulkProgram()" title="Clear program selection" style="padding:0.5rem 0.75rem;">
                <i class="ri-refresh-line"></i>
              </button>
            </div>
          </div>
          <div class="bulk-grid">
            <div class="bulk-header">
              <div class="center" style="display:none;">ID</div>
              <div>Name *</div>
              <div>Status *</div>
              <div>Type *</div>
              <div>Provider *</div>
              <div>Entity *</div>
              <div class="center">Indiv?</div>
              <div>Date *</div>
              <div>Location / Platform</div>
              <div class="center">Duration *</div>
              <div class="center">Avg Satis</div>
              <div></div>
            </div>
            <div id="bulkRows"></div>
          </div>
          <button type="button" class="btn btn-secondary" style="width:100%; margin-top:0.75rem; padding:0.6rem;" onclick="addBulkRow()">
            <i class="ri-add-line"></i> Add Row
          </button>
        </div>

        <!-- Participants Tab -->
        <div id="tab-participants" class="hidden">
          <div style="display:grid; grid-template-columns:0.7fr 1.3fr; gap:1.5rem;">
            <!-- Left: Add Participants (narrower) -->
            <div>
              <div style="font-weight:600; margin-bottom:0.75rem; font-size:0.9rem;">Add Participants</div>
              <input type="text" class="form-input" id="employeeSearch" placeholder="Search by name or ID..." oninput="filterEmployees()" style="margin-bottom:0.75rem;">
              <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem;">
                <select class="form-select" id="filterFunction" onchange="filterEmployees()" style="flex:1;">
                  <option value="">All Functions</option>
                </select>
                <select class="form-select" id="filterSubFunction" onchange="filterEmployees()" style="flex:1;">
                  <option value="">All Sub-Functions</option>
                </select>
              </div>
              <!-- Select All Header -->
              <div id="selectAllEmployeesRow" style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:#f8fafc; border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; font-size:0.8rem;">
                <input type="checkbox" id="selectAllEmployees" onchange="toggleSelectAllEmployees()" style="width:16px; height:16px; cursor:pointer;">
                <label for="selectAllEmployees" style="cursor:pointer; color:var(--secondary); flex:1;">Select All (<span id="filteredEmployeeCount">0</span>)</label>
              </div>
              <div class="employee-list" id="employeeList" style="border-radius:0 0 8px 8px;"></div>
              <div style="margin-top:0.75rem; text-align:center;">
                <button type="button" class="btn btn-primary" id="addParticipantsBtn" onclick="addSelectedParticipants()" disabled style="min-width:150px;">Add Selected (0)</button>
              </div>
              <div style="text-align:center; margin-top:0.75rem;">
                <button type="button" style="background:none; border:none; color:var(--secondary); cursor:pointer; text-decoration:underline; font-size:0.8rem;" onclick="toggleManualAdd()">Manual Add</button>
              </div>
              <div id="manualAddForm" class="hidden" style="margin-top:0.75rem; padding:1rem; background:var(--bg-card-hover); border-radius:0.5rem; border:1px dashed var(--border);">
                <div style="font-weight:600; margin-bottom:0.5rem; color:var(--secondary);">Manual Add</div>
                <select class="form-select" id="manualEntity" style="margin-bottom:0.5rem; font-size:0.8rem;">
                  <option value="">Select Entity...</option>
                </select>
                <input type="text" class="form-input" id="manualId" placeholder="Employee ID" style="margin-bottom:0.5rem; font-size:0.8rem;">
                <input type="text" class="form-input" id="manualName" placeholder="Full Name" style="margin-bottom:0.5rem; font-size:0.8rem;">
                <input type="email" class="form-input" id="manualEmail" placeholder="Email" style="margin-bottom:0.5rem; font-size:0.8rem;">
                <select class="form-select" id="manualFunction" style="margin-bottom:0.5rem; font-size:0.8rem;">
                  <option value="">Select Function...</option>
                </select>
                <select class="form-select" id="manualSubFunction" style="margin-bottom:0.75rem; font-size:0.8rem;">
                  <option value="">Select Sub-Function...</option>
                </select>
                <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
                  <button type="button" class="btn btn-secondary btn-sm" onclick="toggleManualAdd()">Cancel</button>
                  <button type="button" class="btn btn-primary btn-sm" onclick="saveManualParticipant()">Save</button>
                </div>
              </div>
            </div>
            <!-- Right: Current Participants (wider) -->
            <div>
              <!-- Track Attendance via QR Toggle -->
              <div id="trackQRContainer" style="display:flex; align-items:center; gap:12px; padding:10px 14px; background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:1px solid #93c5fd; border-radius:10px; margin-bottom:0.75rem;">
                <input type="checkbox" id="sessionTrackQR" style="width:18px; height:18px; accent-color:#2563eb; cursor:pointer;" onchange="onTrackQRChange()">
                <label for="sessionTrackQR" style="flex:1; cursor:pointer;">
                  <span style="font-weight:600; color:#1e40af; font-size:0.85rem;">Track Attendance via QR</span>
                  <span style="font-size:0.7rem; color:#3b82f6; display:block;">Enable QR code scanning for this session</span>
                </label>
                <i class="ri-qr-scan-2-line" style="font-size:1.25rem; color:#3b82f6;"></i>
              </div>
              
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                <div style="font-weight:600; font-size:0.9rem;">Current Participants (<span id="participantCount">0</span>)</div>
                <div style="display:flex; gap:0.5rem;">
                  <button type="button" class="btn btn-secondary btn-sm" id="btnDownloadQR" onclick="downloadParticipantsQR()" title="Download QR codes for selected participants" style="display:none;">
                    <i class="ri-qr-code-line"></i> Download QR
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" id="btnEmailQR" onclick="emailParticipantsQR()" title="Email QR codes to selected participants" style="display:none;">
                    <i class="ri-mail-send-line"></i> Email QR
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" onclick="openUploadModal()">
                    <i class="ri-upload-2-line"></i> Mass Upload
                  </button>
                  <button type="button" class="btn btn-danger btn-sm" id="removeSelectedBtn" onclick="removeSelectedParticipants()" disabled>Remove</button>
                </div>
              </div>
              <!-- Table-based layout matching working code -->
              <div class="participants-table-container">
                <table class="participants-table">
                  <thead>
                    <tr>
                      <th style="width:30px; text-align:center;"><input type="checkbox" id="selectAllParticipants" onchange="toggleSelectAllParticipants()"></th>
                      <th style="width:35%;">Name</th>
                      <th style="width:20%;">Function</th>
                      <th style="width:20%;">Sub-Function</th>
                      <th id="colCurrency" class="hidden" style="width:60px;">Curr</th>
                      <th id="colCost" class="hidden" style="width:80px;">Cost</th>
                      <th style="width:80px; text-align:center;">Status</th>
                    </tr>
                  </thead>
                  <tbody id="participantsTableBody">
                    <tr><td colspan="5" style="text-align:center; color:#888; padding:20px;">No participants yet.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      
        <!-- Survey Tab -->
        <div id="tab-survey" class="hidden">
          <div style="padding:1rem;">
          <!-- Survey Header -->
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <div>
              <h3 style="font-size:1.1rem; font-weight:600; color:var(--text-primary); margin:0;">Session Surveys & Assessments</h3>
              <p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Create or link Google Forms to collect feedback and assess learning</p>
            </div>
            <button type="button" class="btn btn-sm" onclick="refreshSurveyData()" style="background:#f3f4f6; color:#374151; border:none; display:flex; align-items:center; gap:4px;">
              <i class="ri-refresh-line"></i> Refresh
            </button>
          </div>
          
          <!-- Survey Cards Grid -->
          <div style="display:grid; gap:1rem;">
            
            <!-- Post-Training Feedback Card -->
            <div class="survey-card" id="feedbackCard" style="background:white; border:1px solid var(--border); border-radius:12px; overflow:hidden;">
              <div style="padding:1.25rem;">
                <div style="display:flex; align-items:flex-start; gap:1rem;">
                  <div style="width:48px; height:48px; background:linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%); border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                    <i class="ri-star-smile-line" style="font-size:1.5rem; color:#b45309;"></i>
                  </div>
                  <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                      <h4 style="font-size:0.95rem; font-weight:600; margin:0;">Post-Training Feedback</h4>
                      <span style="font-size:0.65rem; padding:2px 8px; background:#fef3c7; color:#92400e; border-radius:10px; font-weight:500;">Recommended</span>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin:0;">Collect satisfaction scores and feedback from participants after training</p>
                  </div>
                  <div id="feedbackScore" style="display:none; text-align:center; padding:8px 16px; background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius:10px;">
                    <div style="font-size:1.5rem; font-weight:700; color:#059669;">--</div>
                    <div style="font-size:0.65rem; color:#047857;">avg score</div>
                  </div>
                </div>
                
                <!-- Important Q1 Guideline -->
                <div style="margin-top:0.75rem; padding:10px 12px; background:#fef3c7; border-radius:8px; border-left:3px solid #f59e0b;">
                  <div style="display:flex; align-items:flex-start; gap:8px;">
                    <i class="ri-error-warning-line" style="color:#b45309; font-size:1rem; margin-top:1px;"></i>
                    <div style="font-size:0.75rem; color:#92400e; line-height:1.4;">
                      <strong>Important:</strong> Question #1 must remain as the overall satisfaction question (1-5 scale) for auto-scoring to work. You can edit the question text/language, but keep it as the first question.
                    </div>
                  </div>
                </div>
                
                <!-- Form Not Linked State -->
                <div id="feedbackNotLinked" style="margin-top:1rem; padding:1rem; background:#f9fafb; border-radius:8px; border:2px dashed #e5e7eb;">
                  <div style="text-align:center;">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">No feedback form created yet</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="createSurveyForm('feedback')" style="display:flex; align-items:center; gap:6px; margin:0 auto;">
                      <i class="ri-magic-line"></i> Create Feedback Form
                    </button>
                  </div>
                </div>
                
                <!-- Form Linked State -->
                <div id="feedbackLinked" style="display:none; margin-top:1rem;">
                  <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius:8px; border:1px solid #86efac;">
                    <div style="display:flex; align-items:center; gap:10px;">
                      <i class="ri-checkbox-circle-fill" style="color:#16a34a; font-size:1.25rem;"></i>
                      <div>
                        <div style="font-size:0.85rem; font-weight:500; color:#166534;">Form Created</div>
                        <div style="font-size:0.7rem; color:#15803d;" id="feedbackResponseCount">0 responses</div>
                      </div>
                    </div>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                      <button type="button" class="btn btn-sm" onclick="openSurveyForm('feedback')" style="background:#e0f2fe; color:#0369a1; border:none; display:flex; align-items:center; gap:4px;" title="Open form (respondent view)">
                        <i class="ri-external-link-line"></i> Open
                      </button>
                      <button type="button" class="btn btn-sm" onclick="editSurveyForm('feedback')" style="background:#fef3c7; color:#b45309; border:none; display:flex; align-items:center; gap:4px;" title="Edit form & view responses">
                        <i class="ri-edit-line"></i> Edit
                      </button>
                      <button type="button" class="btn btn-sm" onclick="sendFormToParticipants('feedback')" style="background:#ede9fe; color:#6d28d9; border:none; display:flex; align-items:center; gap:4px;" title="Send form to participants">
                        <i class="ri-send-plane-line"></i> Send
                      </button>
                      <button type="button" class="btn btn-sm" onclick="unlinkForm('feedback')" style="background:#fee2e2; color:#dc2626; border:none;" title="Delete form">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Pre-Training Survey Card -->
            <div class="survey-card" id="surveyCard" style="background:white; border:1px solid var(--border); border-radius:12px; overflow:hidden;">
              <div style="padding:1.25rem;">
                <div style="display:flex; align-items:flex-start; gap:1rem;">
                  <div style="width:48px; height:48px; background:linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                    <i class="ri-questionnaire-line" style="font-size:1.5rem; color:#1d4ed8;"></i>
                  </div>
                  <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                      <h4 style="font-size:0.95rem; font-weight:600; margin:0;">Pre-Training Survey</h4>
                      <span style="font-size:0.65rem; padding:2px 8px; background:#f3f4f6; color:#6b7280; border-radius:10px; font-weight:500;">Optional</span>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin:0;">Understand participant expectations and learning goals before training</p>
                  </div>
                </div>
                
                <!-- Form Not Linked State -->
                <div id="surveyNotLinked" style="margin-top:1rem; padding:1rem; background:#f9fafb; border-radius:8px; border:2px dashed #e5e7eb;">
                  <div style="text-align:center;">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">No survey form created yet</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="createSurveyForm('survey')" style="display:flex; align-items:center; gap:6px; margin:0 auto;">
                      <i class="ri-magic-line"></i> Create Survey Form
                    </button>
                  </div>
                </div>
                
                <!-- Form Linked State -->
                <div id="surveyLinked" style="display:none; margin-top:1rem;">
                  <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius:8px; border:1px solid #93c5fd;">
                    <div style="display:flex; align-items:center; gap:10px;">
                      <i class="ri-checkbox-circle-fill" style="color:#2563eb; font-size:1.25rem;"></i>
                      <div>
                        <div style="font-size:0.85rem; font-weight:500; color:#1e40af;">Form Created</div>
                        <div style="font-size:0.7rem; color:#3b82f6;" id="surveyResponseCount">0 responses</div>
                      </div>
                    </div>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                      <button type="button" class="btn btn-sm" onclick="openSurveyForm('survey')" style="background:#e0f2fe; color:#0369a1; border:none; display:flex; align-items:center; gap:4px;" title="Open form (respondent view)">
                        <i class="ri-external-link-line"></i> Open
                      </button>
                      <button type="button" class="btn btn-sm" onclick="editSurveyForm('survey')" style="background:#fef3c7; color:#b45309; border:none; display:flex; align-items:center; gap:4px;" title="Edit form & view responses">
                        <i class="ri-edit-line"></i> Edit
                      </button>
                      <button type="button" class="btn btn-sm" onclick="sendFormToParticipants('survey')" style="background:#ede9fe; color:#6d28d9; border:none; display:flex; align-items:center; gap:4px;" title="Send form to participants">
                        <i class="ri-send-plane-line"></i> Send
                      </button>
                      <button type="button" class="btn btn-sm" onclick="unlinkForm('survey')" style="background:#fee2e2; color:#dc2626; border:none;" title="Delete form">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Assessment Quiz Card -->
            <div class="survey-card" id="assessmentCard" style="background:white; border:1px solid var(--border); border-radius:12px; overflow:hidden;">
              <div style="padding:1.25rem;">
                <div style="display:flex; align-items:flex-start; gap:1rem;">
                  <div style="width:48px; height:48px; background:linear-gradient(135deg, #fce7f3 0%, #f9a8d4 100%); border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                    <i class="ri-file-list-3-line" style="font-size:1.5rem; color:#be185d;"></i>
                  </div>
                  <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                      <h4 style="font-size:0.95rem; font-weight:600; margin:0;">Assessment Quiz</h4>
                      <span style="font-size:0.65rem; padding:2px 8px; background:#f3f4f6; color:#6b7280; border-radius:10px; font-weight:500;">Optional</span>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin:0;">Test knowledge retention and learning outcomes after training</p>
                  </div>
                </div>
                
                <!-- Form Not Linked State -->
                <div id="assessmentNotLinked" style="margin-top:1rem; padding:1rem; background:#f9fafb; border-radius:8px; border:2px dashed #e5e7eb;">
                  <div style="text-align:center;">
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">No assessment form created yet</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="createSurveyForm('assessment')" style="display:flex; align-items:center; gap:6px; margin:0 auto;">
                      <i class="ri-magic-line"></i> Create Assessment Form
                    </button>
                  </div>
                </div>
                
                <!-- Form Linked State -->
                <div id="assessmentLinked" style="display:none; margin-top:1rem;">
                  <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); border-radius:8px; border:1px solid #f9a8d4;">
                    <div style="display:flex; align-items:center; gap:10px;">
                      <i class="ri-checkbox-circle-fill" style="color:#db2777; font-size:1.25rem;"></i>
                      <div>
                        <div style="font-size:0.85rem; font-weight:500; color:#9d174d;">Form Created</div>
                        <div style="font-size:0.7rem; color:#db2777;" id="assessmentResponseCount">0 responses</div>
                      </div>
                    </div>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                      <button type="button" class="btn btn-sm" onclick="openSurveyForm('assessment')" style="background:#e0f2fe; color:#0369a1; border:none; display:flex; align-items:center; gap:4px;" title="Open form (respondent view)">
                        <i class="ri-external-link-line"></i> Open
                      </button>
                      <button type="button" class="btn btn-sm" onclick="editSurveyForm('assessment')" style="background:#fef3c7; color:#b45309; border:none; display:flex; align-items:center; gap:4px;" title="Edit form & view responses">
                        <i class="ri-edit-line"></i> Edit
                      </button>
                      <button type="button" class="btn btn-sm" onclick="sendFormToParticipants('assessment')" style="background:#ede9fe; color:#6d28d9; border:none; display:flex; align-items:center; gap:4px;" title="Send form to participants">
                        <i class="ri-send-plane-line"></i> Send
                      </button>
                      <button type="button" class="btn btn-sm" onclick="unlinkForm('assessment')" style="background:#fee2e2; color:#dc2626; border:none;" title="Delete form">
                        <i class="ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- Info Box -->
          <div style="margin-top:1.5rem; padding:1rem; background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:1px solid #93c5fd; border-radius:10px;">
            <div style="display:flex; align-items:flex-start; gap:10px;">
              <i class="ri-information-line" style="color:#2563eb; font-size:1.25rem; margin-top:2px;"></i>
              <div style="font-size:0.8rem; color:#1e40af; line-height:1.6;">
                <strong>Tips:</strong>
                <ul style="margin:6px 0 0 0; padding-left:1.1rem;">
                  <li><strong>Create Form:</strong> Auto-generates a form with standard questions you can customize</li>
                  <li><strong>Auto-scoring:</strong> Feedback forms automatically calculate satisfaction score from Q1</li>
                  <li><strong>Auto-organized:</strong> Forms are saved to a central folder for easy handover</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
      
      <!-- Send Form Modal -->
      <div id="sendFormModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; width:90%; max-width:500px; max-height:80vh; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <div style="padding:1.25rem; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:1rem; font-weight:600;" id="sendFormModalTitle">Send Form</h3>
            <button onclick="closeSendFormModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#6b7280; line-height:1;">&times;</button>
          </div>
          <div style="padding:1.25rem;">
            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">Select recipients for this form:</p>
            
            <!-- Send Options -->
            <div style="display:flex; flex-direction:column; gap:0.75rem; margin-bottom:1rem;">
              <label style="display:flex; align-items:center; gap:10px; padding:12px; background:#f9fafb; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s;" class="send-option" onclick="selectSendOption('all')">
                <input type="radio" name="sendOption" value="all" checked style="width:18px; height:18px;">
                <div>
                  <div style="font-weight:500; font-size:0.9rem;">Send to All Participants</div>
                  <div style="font-size:0.75rem; color:#6b7280;" id="sendAllCount">0 participants with email</div>
                </div>
              </label>
              <label style="display:flex; align-items:center; gap:10px; padding:12px; background:#f9fafb; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s;" class="send-option" onclick="selectSendOption('selected')">
                <input type="radio" name="sendOption" value="selected" style="width:18px; height:18px;">
                <div>
                  <div style="font-weight:500; font-size:0.9rem;">Select Specific Participants</div>
                  <div style="font-size:0.75rem; color:#6b7280;">Choose who receives the form</div>
                </div>
              </label>
            </div>
            
            <!-- Participant Selection List (hidden by default) -->
            <div id="participantSelectionList" style="display:none; max-height:250px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:1rem;">
              <div style="padding:8px 12px; background:#f9fafb; border-bottom:1px solid #e5e7eb; position:sticky; top:0;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.85rem;">
                  <input type="checkbox" id="selectAllFormRecipients" onchange="toggleAllFormRecipients()" style="width:16px; height:16px;">
                  <span>Select All</span>
                </label>
              </div>
              <div id="formRecipientsList"></div>
            </div>
            
            <div id="selectedRecipientsCount" style="font-size:0.8rem; color:#6b7280; margin-bottom:1rem; display:none;">
              <i class="ri-mail-line"></i> <span>0</span> recipient(s) selected
            </div>
          </div>
          <div style="padding:1rem 1.25rem; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:0.75rem; background:#f9fafb;">
            <button type="button" class="btn btn-secondary" onclick="closeSendFormModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmSendForm()" style="display:flex; align-items:center; gap:6px;">
              <i class="ri-send-plane-line"></i> Send Form
            </button>
          </div>
        </div>
      </div>
      
      <!-- Footer for Session Details -->
      <div class="modal-footer" id="footerSessionDetails" style="justify-content:flex-end;">
        <div style="display:flex; gap:0.5rem;">
          <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Close</button>
          <button type="button" class="btn btn-danger" id="deleteSessionBtn" onclick="deleteCurrentSession()" style="display:none;">Delete</button>
          <button type="button" class="btn btn-primary" id="saveSessionBtn" onclick="saveSession()">Save Session</button>
        </div>
      </div>
      <!-- Footer for Participants (auto-save notification) -->
      <div class="modal-footer hidden" id="footerParticipants" style="justify-content:space-between; align-items:center;">
        <div id="participantNotification" style="color:var(--text-muted); font-size:0.85rem; display:flex; align-items:center; gap:0.5rem;">
          <i class="ri-information-line"></i> <span id="participantNotificationText">Changes are saved automatically</span>
        </div>
        <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Close</button>
      </div>
      <!-- Footer for Survey -->
      <div class="modal-footer hidden" id="footerSurvey" style="justify-content:space-between; align-items:center;">
        <div style="color:var(--text-muted); font-size:0.85rem; display:flex; align-items:center; gap:0.5rem;">
          <i class="ri-information-line"></i> Forms are linked to this session and saved automatically
        </div>
        <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Close</button>
      </div>
      
      <!-- Currency Datalist for Cost Inputs -->
      <datalist id="currencyList">
        <option value="BDT">
        <option value="BRL">
        <option value="CNY">
        <option value="EUR">
        <option value="GTQ">
        <option value="INR">
        <option value="KES">
        <option value="MMK">
        <option value="MXN">
        <option value="MYR">
        <option value="NGN">
        <option value="PEN">
        <option value="PHP">
        <option value="RWF">
        <option value="SGD">
        <option value="THB">
        <option value="TZS">
        <option value="UGX">
        <option value="USD">
        <option value="VND">
        <option value="XOF">
      </datalist>
    </div>
  </div>

  <!-- Program Modal -->
  <div class="modal-overlay" id="programModal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="programModalTitle">New Program</h2>
        <button class="modal-close" onclick="closeProgramModal()"><i class="ri-close-line"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="programId">
        <!-- Program ID hidden but kept for internal use -->
        <input type="hidden" id="programIdDisplay" value="Auto">
        <div class="form-group">
          <label class="form-label">Program Name *</label>
          <input type="text" class="form-input" id="programName" required>
        </div>
        <div class="form-group">
          <label class="form-label">Category *</label>
          <select class="form-select" id="programCategory" required>
            <option value="">Select Category...</option>
            <option value="Business Essentials">Business Essentials</option>
            <option value="Culture">Culture</option>
            <option value="Functional Capability">Functional Capability</option>
            <option value="Leadership Development">Leadership Development</option>
            <option value="Safety & Compliance">Safety & Compliance</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="programDescription" placeholder="Brief description..."></textarea>
        </div>
        
        <!-- Audit Info (shown only when editing) -->
        <div id="programAuditGroup" class="form-row" style="display:none; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);">
          <div class="form-group">
            <label class="form-label" style="color:var(--text-muted); font-size:0.75rem;">Last Modified By</label>
            <input type="text" class="form-input" id="programCreatedBy" readonly style="background:#f8fafc; color:var(--text-muted); font-size:0.85rem;">
          </div>
          <div class="form-group">
            <label class="form-label" style="color:var(--text-muted); font-size:0.75rem;">Last Modified On</label>
            <input type="text" class="form-input" id="programCreatedOn" readonly style="background:#f8fafc; color:var(--text-muted); font-size:0.85rem;">
          </div>
        </div>
      </div>
      <div class="modal-footer" id="programModalFooter">
        <button type="button" id="deleteProgramBtn" class="btn" style="background:none; color:var(--danger); margin-right:auto;" onclick="deleteProgram()">
          <i class="ri-delete-bin-line"></i> Delete
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeProgramModal()">Cancel</button>
        <button type="button" id="saveProgramBtn" class="btn btn-primary" onclick="saveProgram()">Save Program</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h2 class="modal-title">Export PDF Report</h2>
        <button class="modal-close" onclick="closeExportModal()"><i class="ri-close-line"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Export Type</label>
          <div class="radio-group">
            <label><input type="radio" name="exportType" value="program" checked onchange="toggleExportFilter()"> By Program</label>
            <label><input type="radio" name="exportType" value="employee" onchange="toggleExportFilter()"> By Employee</label>
            <label><input type="radio" name="exportType" value="session" onchange="toggleExportFilter()"> By Session</label>
          </div>
        </div>
        
        <!-- Program/Employee Mode Fields -->
        <div id="exportProgramEmployeeFields">
          <div class="form-group">
            <label class="form-label">Year</label>
            <select class="form-select" id="exportYear"></select>
          </div>
          <div class="form-group" id="exportEntityGroup">
            <label class="form-label">Event Entity</label>
            <select class="form-select" id="exportEntity">
              <option value="All">All Entities</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" id="exportFilterLabel">Filter (Optional)</label>
            <input list="exportFilterList" class="form-input" id="exportFilter" placeholder="Type to search...">
            <datalist id="exportFilterList"></datalist>
          </div>
        </div>
        
        <!-- Session Mode Fields -->
        <div id="exportSessionFields" style="display:none;">
          <div class="form-group">
            <label class="form-label">Select Program *</label>
            <select class="form-select" id="exportSessionProgram" onchange="loadSessionsForExport()">
              <option value="">-- Select Program --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Select Session *</label>
            <select class="form-select" id="exportSessionSelect" disabled>
              <option value="">-- Select Program First --</option>
            </select>
          </div>
        </div>
        
        <div id="exportStatus" style="font-size:0.8rem; margin-top:0.5rem;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Mass Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h2 class="modal-title">Mass Upload Participants</h2>
        <button class="modal-close" onclick="closeUploadModal()"><i class="ri-close-line"></i></button>
      </div>
      <div class="modal-body">
        <div style="background:var(--bg-card-hover); padding:1rem; border-radius:0.5rem; margin-bottom:1rem;">
          <div style="font-weight:600; margin-bottom:0.5rem;">1. Download Template</div>
          <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.75rem;">CSV with Program & Session info. Use Employee ID or Email.</p>
          <button type="button" class="btn btn-primary btn-sm" onclick="downloadUploadTemplate()">Download Template</button>
        </div>
        <div style="background:var(--bg-card-hover); padding:1rem; border-radius:0.5rem;">
          <div style="font-weight:600; margin-bottom:0.5rem;">2. Upload Filled Template</div>
          <input type="file" id="uploadFile" accept=".csv" style="margin-bottom:0.75rem;">
          <button type="button" class="btn btn-secondary" id="previewUploadBtn" onclick="previewUpload()" disabled>Preview & Verify</button>
        </div>
        <div id="uploadPreview" class="hidden" style="margin-top:1rem;">
          <div style="font-weight:600; margin-bottom:0.5rem;">Preview Results</div>
          <div id="uploadSummary" style="background:#e8f0fe; color:var(--secondary); padding:0.5rem; border-radius:0.375rem; font-size:0.8rem; margin-bottom:0.5rem;"></div>
          <div style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:0.5rem;">
            <table style="width:100%; border-collapse:collapse; font-size:0.75rem;">
              <thead>
                <tr style="background:var(--bg-card-hover);">
                  <th style="padding:0.5rem; text-align:left;">Status</th>
                  <th style="padding:0.5rem; text-align:left;">Input</th>
                  <th style="padding:0.5rem; text-align:left;">Matched Name</th>
                </tr>
              </thead>
              <tbody id="uploadPreviewBody"></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-primary" style="width:100%; margin-top:0.75rem;" id="confirmUploadBtn" onclick="confirmUpload()" disabled>Confirm & Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Participant Detail Modal -->
  <div class="modal-overlay" id="participantDetailModal">
    <div class="modal large">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" id="participantDetailName">Employee Name</h2>
          <div style="font-size:0.8rem; color:var(--text-muted);" id="participantDetailInfo">ID  Function</div>
        </div>
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <button type="button" class="btn btn-secondary btn-sm" onclick="exportParticipantHistoryPDF()" title="Export PDF" style="padding:0.5rem 0.75rem;">
            <i class="ri-file-pdf-line"></i> Export PDF
          </button>
          <button class="modal-close" onclick="closeParticipantDetailModal()"><i class="ri-close-line"></i></button>
        </div>
      </div>
      <div class="modal-body">
        <!-- Summary Cards -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem;">
          <div class="stat-card" style="padding:1rem;">
            <div class="stat-icon blue" style="width:40px; height:40px; font-size:1.25rem; margin-bottom:0.5rem;"><i class="ri-presentation-line"></i></div>
            <div class="stat-value" style="font-size:1.5rem;" id="participantTotalSessions">0</div>
            <div class="stat-label">Total Sessions</div>
          </div>
          <div class="stat-card" style="padding:1rem;">
            <div class="stat-icon green" style="width:40px; height:40px; font-size:1.25rem; margin-bottom:0.5rem;"><i class="ri-time-line"></i></div>
            <div class="stat-value" style="font-size:1.5rem;" id="participantTotalHours">0:00</div>
            <div class="stat-label">Total Hours</div>
          </div>
        </div>
        
        <!-- Sessions List -->
        <div style="font-weight:600; margin-bottom:0.75rem;">Training History</div>
        <div style="border:1px solid var(--border); border-radius:0.5rem; overflow:hidden;">
          <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
            <thead>
              <tr style="background:var(--bg-card-hover);">
                <th style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Date</th>
                <th style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Program</th>
                <th style="padding:0.75rem 1rem; text-align:left; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Session</th>
                <th style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Hours</th>
                <th style="padding:0.75rem 1rem; text-align:center; font-size:0.7rem; text-transform:uppercase; color:var(--text-muted);">Status</th>
              </tr>
            </thead>
            <tbody id="participantSessionsBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeParticipantDetailModal()">Close</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    // User data from server
    const currentUser = {
      email: <?!= JSON.stringify(userEmail) ?>,
      name: <?!= JSON.stringify(userName) ?>,
      role: <?!= JSON.stringify(userRole) ?>,
      countries: <?!= userCountries ?>,
      primaryEntity: <?!= JSON.stringify(primaryEntity) ?>
    };
    const sessionToken = <?!= JSON.stringify(sessionToken) ?>;

    // App state
    let programs = [];
    let sessions = [];
    let enrollments = [];
    let employees = [];
    let currentMonth = new Date();
    let currentPage = 'calendar';
    let editingSessionId = null;
    let currentProgramId = null;
    let selectedEmployeeIds = new Set();
    let currentParticipants = [];
    let bulkRows = [];
    let uploadValidIds = [];
    
    // New state for entities and calendar
    let entityOptions = [];       // Options for dropdown when creating sessions
    let availableEntities = [];   // All entities user can see (for filters)
    let monthlyEvents = [];
    let calendarView = '5month'; // '5month' or 'monthly'
    let calendarFilterEntity = 'all';
    let canManagePrograms = false; // Whether user can create/edit/delete programs
    
    // Pagination state
    let sessionsCurrentPage = 1;
    let sessionsPageSize = 50;
    let sessionsFilteredData = [];
    let participantsCurrentPage = 1;
    let participantsPageSize = 50;
    let participantsFilteredData = [];
    
    // Analytics caching
    let analyticsCache = {
      data: null,
      timestamp: null,
      filters: null,
      CACHE_DURATION: 5 * 60 * 1000 // 5 minutes
    };
    
    // Participants summary for caching
    let participantsSummary = [];
    
    // Track newly created and modified sessions for highlighting
    let newlyCreatedSessionIds = new Set();
    let justModifiedSessionId = null;
    let highlightProgramFilter = null; // Auto-filter by program after create/edit

    // Initialize - FAST startup
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        updateUserDisplay();
        setupNavigation();
        setupKeyboardShortcuts();
        hideLoading();
        loadInitialData();
        // Check for first-time user tour
        setTimeout(checkFirstLogin, 2500);
      } catch (e) {
        console.error('Init error:', e);
        hideLoading();
      }
    });
    
    // Keyboard shortcuts for power users
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Don't trigger if typing in input/textarea/select
        if (e.target.matches('input, textarea, select')) return;
        
        // Don't trigger if modal is open and not Escape
        const modalOpen = document.querySelector('.modal-overlay.active');
        
        if (e.key === 'Escape') {
          // Close walkthrough if active
          const walkthroughActive = document.getElementById('walkthroughOverlay')?.classList.contains('active');
          if (walkthroughActive) {
            e.preventDefault();
            endTour();
            return;
          }
          // Close any open modal
          if (modalOpen) {
            e.preventDefault();
            const closeBtn = modalOpen.querySelector('.modal-close');
            if (closeBtn) closeBtn.click();
          }
          return;
        }
        
        // Don't process other shortcuts if modal is open
        if (modalOpen) return;
        
        // Shortcuts without modifiers
        switch(e.key.toLowerCase()) {
          case 'n':
            // New Training (if on calendar or sessions page)
            if (['calendar', 'sessions'].includes(currentPage)) {
              e.preventDefault();
              openSessionModal();
            }
            break;
          case 'c':
            // Go to Calendar
            e.preventDefault();
            navigateTo('calendar');
            break;
          case 's':
            // Go to Sessions
            e.preventDefault();
            navigateTo('sessions');
            break;
          case 'p':
            // Go to Participants
            e.preventDefault();
            navigateTo('participants');
            break;
          case 'a':
            // Go to Analytics
            e.preventDefault();
            navigateTo('analytics');
            break;
          case '?':
            // Show shortcuts help
            e.preventDefault();
            showShortcutsHelp();
            break;
        }
      });
    }
    
    function showShortcutsHelp() {
      const shortcuts = `
Keyboard Shortcuts:

N     New Training Session
C     Go to Calendar
S     Go to Sessions  
P     Go to Participants
A     Go to Analytics
Esc   Close modal
?     Show this help
      `.trim();
      
      alert(shortcuts);
    }

    function hideLoading() { 
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.add('hidden');
    }
    
    function showLoading(text) { 
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      if (overlay) overlay.classList.remove('hidden');
      if (loadingText && text) loadingText.textContent = text;
    }

    function updateUserDisplay() {
      const userNameEl = document.getElementById('userName');
      const userRoleEl = document.getElementById('userRole');
      const userAvatarEl = document.getElementById('userAvatar');
      
      if (userNameEl) userNameEl.textContent = currentUser?.name || currentUser?.email || 'Unknown';
      if (userRoleEl) userRoleEl.textContent = currentUser?.role || 'User';
      
      const nameStr = currentUser?.name || currentUser?.email || 'U';
      const initials = nameStr.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      if (userAvatarEl) userAvatarEl.textContent = initials;
    }

    // API Wrapper - simplified
    function api(fn, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((result) => {
            // Check for session expiry in response
            if (result && result.sessionExpired) {
              showSessionExpiredModal();
              reject(new Error('Session expired'));
              return;
            }
            resolve(result);
          })
          .withFailureHandler((error) => {
            // Check if error indicates session expiry
            const errorMsg = error?.message || String(error) || '';
            if (errorMsg.includes('Session') && (errorMsg.includes('expired') || errorMsg.includes('invalid'))) {
              showSessionExpiredModal();
            }
            reject(error);
          })
          [fn](sessionToken, ...args);
      });
    }
    
    function showSessionExpiredModal() {
      // Prevent multiple modals
      if (document.getElementById('sessionExpiredModal')) return;
      
      const modal = document.createElement('div');
      modal.id = 'sessionExpiredModal';
      modal.className = 'modal-overlay active';
      modal.style.zIndex = '10000';
      modal.innerHTML = `
        <div class="modal" style="max-width:400px; text-align:center;">
          <div class="modal-body" style="padding:2rem;">
            <div style="width:60px; height:60px; background:var(--danger-light, #fee2e2); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1rem;">
              <i class="ri-time-line" style="font-size:1.5rem; color:var(--danger, #dc2626);"></i>
            </div>
            <h3 style="margin-bottom:0.5rem; color:var(--text-primary);">Session Expired</h3>
            <p style="color:var(--text-secondary); margin-bottom:1.5rem;">Your session has expired for security reasons. Please log in again to continue.</p>
            <button class="btn btn-primary" onclick="window.location.reload()" style="width:100%;">
              <i class="ri-login-box-line"></i> Log In Again
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Flags to track what's loaded
    let dataLoaded = { programs: false, calendar: false, sessions: false, employees: false, stats: false, participants: false };

    async function loadInitialData() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      
      // Update calendar header immediately
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      document.getElementById('calendarMonthDisplay').textContent = `${monthNames[currentMonth.getMonth()]} ${year}`;
      document.getElementById('monthlyTitle').textContent = `${monthNames[currentMonth.getMonth()]} ${year}`;
      
      try {
        // ONE API call gets programs + calendar + stats + entities
        const data = await api('getInitialData', year, month, calendarFilterEntity);
        
        programs = data.programs || [];
        dataLoaded.programs = true;
        
        // Store entity/function data
        entityOptions = data.entityOptions || [];
        availableEntities = data.availableEntities || [];
        monthlyEvents = data.monthlyEvents || [];
        canManagePrograms = data.canManagePrograms || false;
        
        populateProgramDropdowns();
        populateEntityDropdowns();
        setupCalendarFilters();
        
        renderCalendar5Month(data.calendar);
        renderMonthlyCalendar();
        dataLoaded.calendar = true;
        
        // Stats included in same response
        if (data.stats) {
          updateStats(data.stats);
          dataLoaded.stats = true;
        }
        
        // Update permission-based UI
        updatePermissionBasedUI();
        
        // Background preload: Sessions & Participants (non-blocking)
        setTimeout(() => preloadInBackground(), 500);
        
      } catch (e) {
        console.error('Initial load error:', e);
        showToast('Error loading data', 'error');
      }
    }
    
    // Background preloading for faster page switches
    async function preloadInBackground() {
      try {
        console.log('Background preload starting...');
        
        // Preload sessions if not already loaded
        if (!dataLoaded.sessions) {
          const sessionsData = await api('getSessionsList');
          sessions = sessionsData || [];
          dataLoaded.sessions = true;
          console.log('Background: Sessions loaded (' + sessions.length + ')');
        }
        
        // Preload participants summary if not already loaded
        if (!dataLoaded.participants) {
          const data = await api('getParticipantsSummary');
          participantsSummary = data?.participants || [];
          participantFilters = data?.filters || { entities: [], functions: [], jobBands: [] };
          dataLoaded.participants = true;
          console.log('Background: Participants loaded (' + participantsSummary.length + ')');
        }
        
        console.log('Background preload complete');
      } catch (e) {
        // Silent fail - will load on-demand as fallback
        console.log('Background preload skipped:', e.message);
      }
    }
    
    function updatePermissionBasedUI() {
      // Permission-based UI updates (reserved for future use)
    }

    function populateEntityDropdowns() {
      // Session Entity dropdown - uses entityOptions (for creating sessions)
      const sessionEntity = document.getElementById('sessionEntity');
      
      let options = '<option value="">Select Entity...</option>';
      entityOptions.forEach(e => {
        options += `<option value="${e}">${e}</option>`;
      });
      
      if (sessionEntity) {
        sessionEntity.innerHTML = options;
        // Default to primary entity
        if (currentUser.primaryEntity) {
          sessionEntity.value = currentUser.primaryEntity;
        } else if (entityOptions.length === 1) {
          sessionEntity.value = entityOptions[0];
        }
      }
    }

    function setupCalendarFilters() {
      // Show filters only for roles that can filter
      const filterContainer = document.getElementById('calendarFilters');
      if (!filterContainer) {
        console.error('calendarFilters element not found');
        return;
      }
      
      const role = currentUser?.role;
      
      if (role === 'Developer' || role === 'Global Talent CoE' || role === 'Regional Talent CoE' || role === 'Global HRBP' || role === 'Country HRBP') {
        filterContainer.style.display = 'flex';
        
        // Populate entity filter with availableEntities
        const entityFilter = document.getElementById('filterCalendarEntity');
        if (entityFilter) {
          let entityOpts = '<option value="all">All Entities</option>';
          availableEntities.forEach(e => {
            entityOpts += `<option value="${e}">${e}</option>`;
          });
          entityFilter.innerHTML = entityOpts;
        }
      } else {
        filterContainer.style.display = 'none';
      }
    }

    async function applyCalendarFilters() {
      calendarFilterEntity = document.getElementById('filterCalendarEntity').value;
      
      // Reload calendar data with filters
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      
      try {
        showLoading('Filtering...');
        const data = await api('getInitialData', year, month, calendarFilterEntity);
        monthlyEvents = data.monthlyEvents || [];
        
        // Update stats
        updateStats(data.stats);
        
        renderCalendar5Month(data.calendar);
        renderMonthlyCalendar();
      } catch (e) {
        showToast('Error applying filters', 'error');
      } finally {
        hideLoading();
      }
    }

    // Calendar View Toggle
    function switchCalendarView(view) {
      calendarView = view;
      document.getElementById('view5Month').classList.toggle('active', view === '5month');
      document.getElementById('viewMonthly').classList.toggle('active', view === 'monthly');
      document.getElementById('calendar5Month').classList.toggle('hidden', view !== '5month');
      document.getElementById('monthlyCalendar').classList.toggle('hidden', view !== 'monthly');
      
      if (view === 'monthly') {
        renderMonthlyCalendar();
      }
    }

    // Monthly Calendar Rendering
    function renderMonthlyCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      document.getElementById('monthlyTitle').textContent = `${monthNames[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
      const todayDate = today.getDate();
      
      // Filter events for this month
      const thisMonthEvents = monthlyEvents.filter(e => e.year === year && e.month === month + 1);
      
      // Group events by day
      const eventsByDay = {};
      thisMonthEvents.forEach(e => {
        if (!eventsByDay[e.day]) eventsByDay[e.day] = [];
        eventsByDay[e.day].push(e);
      });
      
      let html = '';
      
      // Previous month days
      const prevMonth = new Date(year, month, 0);
      const prevMonthDays = prevMonth.getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        html += `<div class="monthly-day other-month"><div class="monthly-day-number">${day}</div></div>`;
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const isToday = isCurrentMonth && day === todayDate;
        const dayEvents = eventsByDay[day] || [];
        
        html += `<div class="monthly-day ${isToday ? 'today' : ''}">
          <div class="monthly-day-number">${day}</div>`;
        
        // Show up to 3 events
        dayEvents.slice(0, 3).forEach(e => {
          const statusClass = (e.status || 'Open').replace(/\s+/g, '');
          const globalIndicator = e.isGlobal ? '<span style="background:#6366f1; color:white; font-size:0.5rem; padding:1px 3px; border-radius:3px; margin-right:3px;">G</span>' : '';
          html += `<div class="monthly-event status-${statusClass}" onclick="openSessionForEdit('${e.sessionId}')" title="${e.name}${e.isGlobal ? ' (Global)' : ''}">${globalIndicator}${e.name}</div>`;
        });
        
        if (dayEvents.length > 3) {
          html += `<div class="monthly-more">+${dayEvents.length - 3} more</div>`;
        }
        
        html += '</div>';
      }
      
      // Next month days
      const totalCells = startDayOfWeek + daysInMonth;
      const remaining = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="monthly-day other-month"><div class="monthly-day-number">${i}</div></div>`;
      }
      
      document.getElementById('monthlyDays').innerHTML = html;
    }

    // Lazy load sessions using fast API
    async function ensureSessionsLoaded() {
      if (dataLoaded.sessions) return;
      try {
        sessions = await api('getSessionsList') || [];
        dataLoaded.sessions = true;
      } catch (e) {
        sessions = [];
      }
    }

    // Lazy load employees only when needed
    async function ensureEmployeesLoaded() {
      if (dataLoaded.employees) return;
      try {
        employees = await api('getEmployees') || [];
        dataLoaded.employees = true;
      } catch (e) {
        employees = [];
      }
    }

    // Lazy load participants summary
    async function ensureParticipantsLoaded() {
      if (dataLoaded.participants) return;
      try {
        const data = await api('getParticipantsSummary') || {};
        participantsSummary = data.participants || [];
        participantFilters = data.filters || { entities: [], functions: [], jobBands: [] };
        dataLoaded.participants = true;
      } catch (e) {
        participantsSummary = [];
        participantFilters = { entities: [], functions: [], jobBands: [] };
      }
    }

    async function loadCalendarData() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      document.getElementById('calendarMonthDisplay').textContent = `${monthNames[currentMonth.getMonth()]} ${year}`;
      document.getElementById('monthlyTitle').textContent = `${monthNames[currentMonth.getMonth()]} ${year}`;
      
      try {
        const data = await api('getInitialData', year, month, calendarFilterEntity);
        monthlyEvents = data.monthlyEvents || [];
        renderCalendar5Month(data.calendar);
        renderMonthlyCalendar();
      } catch (e) {
        renderCalendar5Month({ months: [] });
      }
    }

    // Called after saving/deleting - reload in background
    async function refreshData() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      
      try {
        // Single API call to refresh
        const data = await api('getInitialData', year, month);
        
        programs = data.programs || [];
        populateProgramDropdowns();
        renderCalendar5Month(data.calendar);
        
        if (data.stats) updateStats(data.stats);
        
        // Only re-render if on that page
        if (currentPage === 'programs') renderProgramsPage();
        if (currentPage === 'sessions') {
          // Always refresh sessions list when on sessions page
          sessions = await api('getSessionsList') || [];
          dataLoaded.sessions = true;
          renderSessionsTable();
        }
        if (currentPage === 'participants') {
          dataLoaded.participants = false;
          await ensureParticipantsLoaded();
          renderParticipantsPage();
        }
      } catch (e) {
        console.error('refreshData error:', e);
      }
    }

    function updateStats(stats) {
      if (stats) {
        // Update calendar stats
        const total = document.getElementById('statTotalSessions');
        const completed = document.getElementById('statCompleted');
        const upcoming = document.getElementById('statUpcoming');
        const participants = document.getElementById('statParticipants');
        
        if (total) total.textContent = stats.totalSessions || 0;
        if (completed) completed.textContent = stats.completed || 0;
        if (upcoming) upcoming.textContent = stats.upcoming || 0;
        if (participants) participants.textContent = stats.totalParticipants || stats.participants || 0;
      }
    }

    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => navigateTo(item.dataset.page));
      });
    }

    async function navigateTo(page) {
      // Clear session highlight badges when navigating to any page other than sessions
      // OR when navigating to sessions without a highlight filter (normal navigation)
      if (page !== 'sessions') {
        newlyCreatedSessionIds.clear();
        justModifiedSessionId = null;
        highlightProgramFilter = null;
      } else if (!highlightProgramFilter) {
        // Navigating to sessions normally (not after create/edit)
        newlyCreatedSessionIds.clear();
        justModifiedSessionId = null;
      }
      
      currentPage = page;
      document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
      document.querySelectorAll('.page-section').forEach(s => s.classList.toggle('active', s.id === 'page-' + page));

      const titles = { calendar: 'Training Calendar', analytics: 'Training Analytics', dashboard: 'Dashboard', programs: 'Programs', sessions: 'Sessions', participants: 'Participants', 'qr-attendance': 'QR Attendance', reports: 'Reports' };
      document.getElementById('pageTitle').textContent = titles[page] || 'Training Calendar';

      const btn = document.getElementById('primaryAction');
      if (btn) btn.style.display = ['calendar', 'sessions'].includes(page) ? 'flex' : 'none';

      // Lazy load data for each page
      if (page === 'analytics') {
        if (!window.analyticsDataLoaded) {
          // Initialize period dropdown with default (current year) before first load
          initializeAnalyticsPeriod();
          await loadAnalyticsData();
        } else {
          updateCacheIndicator();
        }
      } else if (page === 'sessions') {
        if (!dataLoaded.sessions) {
          showSessionsSkeleton();
          await ensureSessionsLoaded();
        }
        populateSessionYearFilter();
        restoreSessionFilters();
        renderSessionsTable();
      } else if (page === 'programs') {
        renderProgramsPage();
      } else if (page === 'participants') {
        if (!dataLoaded.participants) {
          showParticipantsSkeleton();
          await ensureParticipantsLoaded();
        }
        populateParticipantFilters();
        renderParticipantsPage();
      } else if (page === 'qr-attendance') {
        initQRAttendance();
      }
    }

    function handlePrimaryAction() {
      openSessionModal();
    }

    // Calendar
    function renderCalendar5Month(data) {
      const container = document.getElementById('calendar5Month');
      container.innerHTML = '';
      
      // Get current date for color coding
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (!data || !data.months || data.months.length === 0) {
        // Show empty 5-month grid
        const offsets = [-2, -1, 0, 1, 2];
        offsets.forEach((o, idx) => {
          const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + o, 1);
          const monthName = d.toLocaleString('default', { month: 'long', year: 'numeric' });
          
          const col = document.createElement('div');
          col.className = `month-column ${idx === 2 ? 'current' : ''}`;
          col.innerHTML = `
            <div class="month-header">${monthName}</div>
            <div class="program-list">
              <div class="empty-state" style="padding:1rem; font-size:0.8rem;">No sessions</div>
            </div>
          `;
          container.appendChild(col);
        });
        return;
      }

      data.months.forEach((mData, idx) => {
        const col = document.createElement('div');
        col.className = `month-column ${idx === 2 ? 'current' : ''}`;
        
        col.innerHTML = `<div class="month-header">${mData.monthName}</div>`;
        
        const list = document.createElement('div');
        list.className = 'program-list';
        
        if (mData.programs && mData.programs.length) {
          mData.programs.forEach(p => {
            const card = document.createElement('div');
            
            // Determine card color based on dates
            const maxDate = new Date(p.maxDate);
            maxDate.setHours(0, 0, 0, 0);
            const isCompleted = maxDate < today;
            card.className = `program-card ${isCompleted ? 'program-completed' : 'program-upcoming'}`;
            card.dataset.name = (p.programName || '').toLowerCase();
            
            let dateStr = '';
            if (p.minDate && p.maxDate) {
              const d1 = new Date(p.minDate), d2 = new Date(p.maxDate);
              const mon1 = d1.toLocaleDateString('en', { month: 'short' });
              const mon2 = d2.toLocaleDateString('en', { month: 'short' });
              if (d1.getTime() === d2.getTime()) dateStr = `${d1.getDate()} ${mon1}`;
              else if (mon1 === mon2) dateStr = `${d1.getDate()}-${d2.getDate()} ${mon1}`;
              else dateStr = `${d1.getDate()} ${mon1} - ${d2.getDate()} ${mon2}`;
            }
            
            card.innerHTML = `
              <h4>${p.programName}</h4>
              <div class="program-date-range"><i class="ri-calendar-line"></i> ${dateStr}</div>
              <div class="program-stats">
                <span><i class="ri-stack-line"></i> ${p.sessionCount} Sessions</span>
                <span><i class="ri-team-line"></i> ${p.participantCount} Pax</span>
              </div>
            `;
            
            // Click to navigate to Sessions page with filters
            card.onclick = () => filterSessionsByProgram(p.programId, mData.year, mData.month);
            list.appendChild(card);
          });
        } else {
          list.innerHTML = '<div class="empty-state" style="padding:1rem; font-size:0.8rem;">No sessions</div>';
        }
        
        col.appendChild(list);
        container.appendChild(col);
      });
    }

    // Navigate to Sessions page filtered by program and month
    async function filterSessionsByProgram(programId, year, month) {
      sessionFilterProgram = programId;
      sessionFilterYear = year;
      sessionFilterMonth = month;
      
      await navigateTo('sessions');
      
      // Apply filters after navigation - use program search bar
      setTimeout(() => {
        const yearFilter = document.getElementById('filterYear');
        const monthFilter = document.getElementById('filterMonth');
        const programSearch = document.getElementById('filterProgramSearch');
        
        // Find program name from programId
        const prog = programs.find(p => p.id === programId);
        if (programSearch && prog) programSearch.value = prog.name;
        if (yearFilter) yearFilter.value = year;
        if (monthFilter) monthFilter.value = month;
        renderSessionsTable();
      }, 100);
    }

    let sessionFilterProgram = '';
    let sessionFilterYear = '';
    let sessionFilterMonth = '';

    function filterCalendarPrograms() {
      const term = document.getElementById('calendarSearch').value.toLowerCase();
      document.querySelectorAll('.program-card').forEach(card => {
        card.style.display = card.dataset.name.includes(term) ? 'block' : 'none';
      });
    }

    function changeMonth(delta) { currentMonth.setMonth(currentMonth.getMonth() + delta); loadCalendarData(); }
    function changeYear(delta) { currentMonth.setFullYear(currentMonth.getFullYear() + delta); loadCalendarData(); }
    function goToToday() { currentMonth = new Date(); loadCalendarData(); }

    // Programs
    function populateProgramDropdowns() {
      // For filter dropdown (keep as regular select)
      const filterProgram = document.getElementById('filterProgram');
      if (filterProgram) filterProgram.innerHTML = '<option value="">All Programs</option>' + programs.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      
      // Populate searchable dropdowns
      renderSessionProgramDropdown();
      renderBulkProgramDropdown();
    }
    
    // Session Program searchable dropdown
    function renderSessionProgramDropdown(filter = '') {
      const dropdown = document.getElementById('sessionProgramDropdown');
      if (!dropdown) return;
      
      const filtered = filter 
        ? programs.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()))
        : programs;
      
      if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px; color:#9ca3af; text-align:center; font-size:0.85rem;">No programs found</div>';
      } else {
        dropdown.innerHTML = filtered.map(p => `
          <div class="program-dropdown-item" onclick="selectSessionProgram('${p.id}', '${p.name.replace(/'/g, "\\'")}')" 
               style="padding:10px 14px; cursor:pointer; border-bottom:1px solid #f3f4f6; transition:background 0.15s;"
               onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
            <div style="font-weight:500; font-size:0.85rem;">${p.name}</div>
            ${p.category ? `<div style="font-size:0.75rem; color:#6b7280;">${p.category}</div>` : ''}
          </div>
        `).join('');
      }
    }
    
    function showSessionProgramDropdown() {
      renderSessionProgramDropdown(document.getElementById('sessionProgramSearch').value);
      document.getElementById('sessionProgramDropdown').style.display = 'block';
    }
    
    function filterSessionPrograms() {
      renderSessionProgramDropdown(document.getElementById('sessionProgramSearch').value);
      document.getElementById('sessionProgramDropdown').style.display = 'block';
    }
    
    function selectSessionProgram(id, name) {
      document.getElementById('sessionProgram').value = id;
      document.getElementById('sessionProgramSearch').value = name;
      document.getElementById('sessionProgramDropdown').style.display = 'none';
    }
    
    function clearSessionProgram() {
      document.getElementById('sessionProgram').value = '';
      document.getElementById('sessionProgramSearch').value = '';
      renderSessionProgramDropdown();
    }
    
    // Bulk Program searchable dropdown
    function renderBulkProgramDropdown(filter = '') {
      const dropdown = document.getElementById('bulkProgramDropdown');
      if (!dropdown) return;
      
      const filtered = filter 
        ? programs.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()))
        : programs;
      
      if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding:12px; color:#9ca3af; text-align:center; font-size:0.85rem;">No programs found</div>';
      } else {
        dropdown.innerHTML = filtered.map(p => `
          <div class="program-dropdown-item" onclick="selectBulkProgram('${p.id}', '${p.name.replace(/'/g, "\\'")}')" 
               style="padding:10px 14px; cursor:pointer; border-bottom:1px solid #f3f4f6; transition:background 0.15s;"
               onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
            <div style="font-weight:500; font-size:0.85rem;">${p.name}</div>
            ${p.category ? `<div style="font-size:0.75rem; color:#6b7280;">${p.category}</div>` : ''}
          </div>
        `).join('');
      }
    }
    
    function showBulkProgramDropdown() {
      renderBulkProgramDropdown(document.getElementById('bulkProgramSearch').value);
      document.getElementById('bulkProgramDropdown').style.display = 'block';
    }
    
    function filterBulkPrograms() {
      renderBulkProgramDropdown(document.getElementById('bulkProgramSearch').value);
      document.getElementById('bulkProgramDropdown').style.display = 'block';
    }
    
    function selectBulkProgram(id, name) {
      document.getElementById('bulkProgram').value = id;
      document.getElementById('bulkProgramSearch').value = name;
      document.getElementById('bulkProgramDropdown').style.display = 'none';
    }
    
    function clearBulkProgram() {
      document.getElementById('bulkProgram').value = '';
      document.getElementById('bulkProgramSearch').value = '';
      renderBulkProgramDropdown();
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      const sessionDropdown = document.getElementById('sessionProgramDropdown');
      const bulkDropdown = document.getElementById('bulkProgramDropdown');
      
      if (sessionDropdown && !e.target.closest('#sessionProgramSearch') && !e.target.closest('#sessionProgramDropdown')) {
        sessionDropdown.style.display = 'none';
      }
      if (bulkDropdown && !e.target.closest('#bulkProgramSearch') && !e.target.closest('#bulkProgramDropdown')) {
        bulkDropdown.style.display = 'none';
      }
    });

    function renderProgramsPage() {
      const grid = document.getElementById('programsGrid');
      const newProgramBtn = document.getElementById('newProgramBtn');
      
      // Show/hide New Program button based on permissions
      if (newProgramBtn) {
        newProgramBtn.style.display = canManagePrograms ? 'flex' : 'none';
      }
      
      if (!programs.length) {
        const emptyContent = canManagePrograms 
          ? '<div class="empty-state" style="grid-column:1/-1;"><i class="ri-book-2-line"></i><h3>No programs</h3><p>Create your first program</p><button class="btn btn-primary" onclick="openNewProgramModal()">+ New Program</button></div>'
          : '<div class="empty-state" style="grid-column:1/-1;"><i class="ri-book-2-line"></i><h3>No programs</h3><p>No programs available</p></div>';
        grid.innerHTML = emptyContent;
        return;
      }

      grid.innerHTML = programs.map(p => {
        const sessionCount = p.sessionCount || 0;
        const sessionCountHtml = `<span class="session-count-link" style="cursor:pointer;" onclick="event.stopPropagation(); navigateToSessionsFiltered('${p.id}')">${sessionCount} Session${sessionCount !== 1 ? 's' : ''}</span>`;
        
        const editClick = canManagePrograms 
          ? `onclick="openProgramModal('${p.id}')"`
          : `onclick="navigateToSessionsFiltered('${p.id}')"`;
        
        return `
          <div class="stat-card" style="cursor:default;">
            <div style="cursor:pointer;" ${editClick}>
              <div style="font-size:0.7rem; text-transform:uppercase; color:var(--primary); font-weight:600; margin-bottom:0.5rem;">${p.category || 'Uncategorized'}</div>
              <div style="font-weight:600; margin-bottom:0.5rem;">${p.name}</div>
              <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:1rem;">${p.description || 'No description'}</div>
            </div>
            <div style="font-size:0.75rem; color:var(--text-muted); padding-top:0.75rem; border-top:1px solid var(--border);">
              <i class="ri-presentation-line"></i> ${sessionCountHtml}
            </div>
          </div>`;
      }).join('');
    }
    
    function openNewProgramModal() {
      if (!canManagePrograms) {
        showToast('You do not have permission to create programs', 'error');
        return;
      }
      openProgramModal();
    }
    
    function navigateToSessionsFiltered(programId) {
      // Navigate to Sessions page and filter by program
      navigateTo('sessions');
      // Wait for page to load, then apply filter
      setTimeout(() => {
        const searchInput = document.getElementById('filterProgramSearch');
        const prog = programs.find(p => p.id === programId);
        if (searchInput && prog) {
          searchInput.value = prog.name;
          renderSessionsTable();
        }
      }, 100);
    }

    function openProgramModal(id) {
      document.getElementById('programModal').classList.add('active');
      document.getElementById('programId').value = '';
      document.getElementById('programIdDisplay').value = 'Auto';
      document.getElementById('programName').value = '';
      document.getElementById('programCategory').value = '';
      document.getElementById('programDescription').value = '';
      document.getElementById('programModalTitle').textContent = 'New Program';
      
      const saveProgramBtn = document.getElementById('saveProgramBtn');
      const deleteProgramBtn = document.getElementById('deleteProgramBtn');
      const nameInput = document.getElementById('programName');
      const categorySelect = document.getElementById('programCategory');
      const descInput = document.getElementById('programDescription');
      const auditGroup = document.getElementById('programAuditGroup');
      const createdByInput = document.getElementById('programCreatedBy');
      const createdOnInput = document.getElementById('programCreatedOn');

      if (id) {
        const p = programs.find(x => x.id === id);
        if (p) {
          document.getElementById('programId').value = p.id;
          document.getElementById('programIdDisplay').value = p.id;
          document.getElementById('programName').value = p.name;
          document.getElementById('programCategory').value = p.category || '';
          document.getElementById('programDescription').value = p.description || '';
          document.getElementById('programModalTitle').textContent = canManagePrograms ? 'Edit Program' : 'View Program';
          
          // Show audit info for existing programs
          if (auditGroup) auditGroup.style.display = 'flex';
          if (createdByInput) createdByInput.value = p.modifiedBy || '-';
          if (createdOnInput) createdOnInput.value = p.modifiedOn || '-';
          
          // Show/hide buttons and inputs based on permissions
          if (saveProgramBtn) saveProgramBtn.style.display = canManagePrograms ? 'block' : 'none';
          if (deleteProgramBtn) deleteProgramBtn.style.display = canManagePrograms ? 'block' : 'none';
          
          // Make inputs read-only if no permission
          if (nameInput) nameInput.readOnly = !canManagePrograms;
          if (categorySelect) categorySelect.disabled = !canManagePrograms;
          if (descInput) descInput.readOnly = !canManagePrograms;
        }
      } else {
        // New program - only show if user can manage
        if (!canManagePrograms) {
          closeProgramModal();
          showToast('You do not have permission to create programs', 'error');
          return;
        }
        // Hide audit info for new programs
        if (auditGroup) auditGroup.style.display = 'none';
        if (saveProgramBtn) saveProgramBtn.style.display = 'block';
        if (deleteProgramBtn) deleteProgramBtn.style.display = 'none';
        if (nameInput) nameInput.readOnly = false;
        if (categorySelect) categorySelect.disabled = false;
        if (descInput) descInput.readOnly = false;
      }
    }

    function closeProgramModal() { document.getElementById('programModal').classList.remove('active'); }
    
    async function deleteProgram() {
      const id = document.getElementById('programId').value;
      if (!id) return;
      
      if (!confirm('Delete this program? All sessions under this program will remain but will no longer be associated with a program.')) return;
      
      try {
        showLoading('Deleting...');
        await api('deleteProgram', id);
        closeProgramModal();
        await refreshData();
        showToast('Program deleted!', 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    async function saveProgram() {
      const id = document.getElementById('programId').value;
      const name = document.getElementById('programName').value.trim();
      const category = document.getElementById('programCategory').value;
      const description = document.getElementById('programDescription').value.trim();

      if (!name || !category) { showToast('Please fill required fields', 'error'); return; }

      try {
        showLoading('Saving...');
        if (id) {
          await api('updateProgram', { id, name, category, description });
        } else {
          const newId = await api('generateProgramId');
          await api('createProgram', { id: newId, name, category, description });
        }
        closeProgramModal();
        await refreshData();
        showToast('Program saved!', 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    // Sessions Table - with new columns and filters
    function renderSessionsTable(resetPage = false) {
      if (resetPage) sessionsCurrentPage = 1;
      
      const tbody = document.getElementById('sessionsTableBody');
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const yearFilter = document.getElementById('filterYear')?.value || '';
      const monthFilter = document.getElementById('filterMonth')?.value || '';
      let programSearch = (document.getElementById('filterProgramSearch')?.value || '').toLowerCase();
      
      // Apply auto-filter by program if set (after create/edit)
      if (highlightProgramFilter) {
        document.getElementById('filterProgramSearch').value = highlightProgramFilter;
        programSearch = highlightProgramFilter.toLowerCase();
        highlightProgramFilter = null; // Clear after applying
      }
      
      // Save filters to sessionStorage
      try {
        sessionStorage.setItem('tms_session_filters', JSON.stringify({
          status: statusFilter,
          year: yearFilter,
          month: monthFilter,
          program: programSearch
        }));
      } catch (e) { /* sessionStorage not available */ }

      // Filter data
      let filtered = sessions || [];
      if (statusFilter) filtered = filtered.filter(s => s.status === statusFilter);
      if (yearFilter) filtered = filtered.filter(s => s.year == yearFilter);
      if (monthFilter) filtered = filtered.filter(s => s.month == monthFilter);
      if (programSearch) filtered = filtered.filter(s => (s.programName || '').toLowerCase().includes(programSearch) || (s.name || '').toLowerCase().includes(programSearch));

      // Sort: respect user's column sort, float NEW/UPDATED to top
      filtered.sort((a, b) => {
        const aIsNew = newlyCreatedSessionIds.has(a.sessionId);
        const bIsNew = newlyCreatedSessionIds.has(b.sessionId);
        const aIsModified = justModifiedSessionId === a.sessionId;
        const bIsModified = justModifiedSessionId === b.sessionId;
        
        // New sessions first, then modified, then rest
        if (aIsNew && !bIsNew) return -1;
        if (!aIsNew && bIsNew) return 1;
        if (aIsModified && !bIsModified) return -1;
        if (!aIsModified && bIsModified) return 1;
        
        // Apply user's sort column and direction
        let aVal, bVal;
        const column = sessionsSortColumn;
        
        if (column === 'date') {
          aVal = new Date(a.date || '1900-01-01');
          bVal = new Date(b.date || '1900-01-01');
        } else if (column === 'participants') {
          aVal = parseInt(a.participantCount) || 0;
          bVal = parseInt(b.participantCount) || 0;
        } else if (column === 'programName') {
          aVal = (a.programName || '').toLowerCase();
          bVal = (b.programName || '').toLowerCase();
        } else {
          aVal = String(a[column] || '').toLowerCase();
          bVal = String(b[column] || '').toLowerCase();
        }
        
        if (aVal < bVal) return sessionsSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return sessionsSortDir === 'asc' ? 1 : -1;
        return 0;
      });

      // Store filtered data for pagination
      sessionsFilteredData = filtered;
      const totalItems = filtered.length;
      const totalPages = Math.ceil(totalItems / sessionsPageSize);
      
      // Ensure current page is valid
      if (sessionsCurrentPage > totalPages) sessionsCurrentPage = Math.max(1, totalPages);
      
      // Calculate slice indices
      const startIndex = (sessionsCurrentPage - 1) * sessionsPageSize;
      const endIndex = Math.min(startIndex + sessionsPageSize, totalItems);
      const pageData = filtered.slice(startIndex, endIndex);

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><p>No sessions found</p></div></td></tr>';
        updateSessionsPagination(0, 0, 0, 0);
        return;
      }

      tbody.innerHTML = pageData.map(s => {
        const statusClass = (s.status || 'Open').replace(/\s+/g, '');
        const globalBadge = s.isGlobal ? '<span class="badge-global">GLOBAL</span>' : '';
        const newBadge = newlyCreatedSessionIds.has(s.sessionId) ? '<span class="badge-new">NEW</span>' : '';
        const modifiedBadge = justModifiedSessionId === s.sessionId ? '<span class="badge-modified">UPDATED</span>' : '';
        const canEdit = s.canEdit !== false;
        
        return `
          <tr>
            <td style="padding:0.75rem 1rem;"><div style="font-weight:500;">${s.name || 'Untitled'}${globalBadge}${newBadge}${modifiedBadge}</div><div style="font-size:0.7rem; color:var(--text-muted);">${s.sessionId}</div></td>
            <td style="padding:0.75rem 1rem; font-size:0.85rem;">${s.programName || 'Unknown'}</td>
            <td style="padding:0.75rem 1rem; font-size:0.85rem;">${s.entity || '-'}</td>
            <td style="padding:0.75rem 1rem; font-size:0.85rem;">${s.type || '-'}</td>
            <td style="padding:0.75rem 1rem; font-size:0.85rem;">${formatDate(s.date)}</td>
            <td style="padding:0.75rem 1rem; text-align:center; font-weight:600;">${s.participantCount || 0}</td>
            <td style="padding:0.75rem 1rem;"><span class="status-badge status-${statusClass}">${s.status || 'Open'}</span></td>
            <td style="padding:0.75rem 1rem; width:100px;">
              <div style="display:flex; justify-content:center; gap:4px;">
                <button class="btn btn-secondary btn-sm btn-icon" onclick="openSessionForEdit('${s.sessionId}')" title="${canEdit ? 'Edit' : 'View'}"><i class="ri-${canEdit ? 'edit' : 'eye'}-line"></i></button>
                ${canEdit ? `<button class="btn btn-sm btn-icon" style="background:none; color:var(--danger);" onclick="deleteSessionDirect('${s.sessionId}')" title="Delete"><i class="ri-delete-bin-line"></i></button>` : ''}
              </div>
            </td>
          </tr>`;
      }).join('');
      
      // Update pagination UI
      updateSessionsPagination(startIndex + 1, endIndex, totalItems, totalPages);
    }
    
    function updateSessionsPagination(start, end, total, totalPages) {
      document.getElementById('sessionsShowingStart').textContent = total > 0 ? start : 0;
      document.getElementById('sessionsShowingEnd').textContent = end;
      document.getElementById('sessionsTotalCount').textContent = total;
      
      // Update prev/next buttons
      document.getElementById('sessionsPrevBtn').disabled = sessionsCurrentPage <= 1;
      document.getElementById('sessionsNextBtn').disabled = sessionsCurrentPage >= totalPages;
      
      // Generate page numbers
      const pageNumbersContainer = document.getElementById('sessionsPageNumbers');
      let pageButtons = '';
      
      const maxVisiblePages = 5;
      let startPage = Math.max(1, sessionsCurrentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pageButtons += `<button class="page-btn ${i === sessionsCurrentPage ? 'active' : ''}" onclick="goToSessionsPage(${i})">${i}</button>`;
      }
      
      pageNumbersContainer.innerHTML = pageButtons;
    }
    
    function changeSessionsPage(delta) {
      sessionsCurrentPage += delta;
      renderSessionsTable();
    }
    
    function goToSessionsPage(page) {
      sessionsCurrentPage = page;
      renderSessionsTable();
    }
    
    function changeSessionsPageSize() {
      sessionsPageSize = parseInt(document.getElementById('sessionsPageSize').value);
      sessionsCurrentPage = 1;
      renderSessionsTable();
    }
    
    function restoreSessionFilters() {
      try {
        const saved = sessionStorage.getItem('tms_session_filters');
        if (saved) {
          const filters = JSON.parse(saved);
          const statusEl = document.getElementById('filterStatus');
          const yearEl = document.getElementById('filterYear');
          const monthEl = document.getElementById('filterMonth');
          const programEl = document.getElementById('filterProgramSearch');
          
          if (statusEl && filters.status) statusEl.value = filters.status;
          if (yearEl && filters.year) yearEl.value = filters.year;
          if (monthEl && filters.month) monthEl.value = filters.month;
          if (programEl && filters.program) programEl.value = filters.program;
        }
      } catch (e) { /* sessionStorage not available */ }
    }

    function clearSessionFilters() {
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterMonth').value = '';
      document.getElementById('filterProgramSearch').value = '';
      sessionFilterProgram = '';
      sessionFilterYear = '';
      sessionFilterMonth = '';
      sessionsCurrentPage = 1;
      
      // Clear saved filters
      try { sessionStorage.removeItem('tms_session_filters'); } catch (e) {}
      
      renderSessionsTable();
    }

    async function deleteSessionDirect(sessionId) {
      if (!confirm('Delete this session? This cannot be undone.')) return;
      
      try {
        showLoading('Deleting...');
        await api('deleteSession', sessionId);
        dataLoaded.sessions = false;
        await ensureSessionsLoaded();
        renderSessionsTable();
        showToast('Session deleted', 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    function populateSessionYearFilter() {
      const years = new Set();
      sessions.forEach(s => { if (s.year) years.add(s.year); });
      const yearSelect = document.getElementById('filterYear');
      if (yearSelect) {
        yearSelect.innerHTML = '<option value="">Year</option>' + Array.from(years).sort((a,b) => b-a).map(y => `<option value="${y}">${y}</option>`).join('');
      }
    }

    // ========== PARTICIPANTS PAGE ==========
    let participantFilters = { entities: [], functions: [], jobBands: [] };

    function renderParticipantsPage(resetPage = false) {
      if (resetPage) participantsCurrentPage = 1;
      
      const search = (document.getElementById('participantsSearch')?.value || '').toLowerCase();
      const entityFilter = document.getElementById('filterParticipantEntity')?.value || '';
      const funcFilter = document.getElementById('filterParticipantFunction')?.value || '';
      const jobBandFilter = document.getElementById('filterParticipantJobBand')?.value || '';
      const tbody = document.getElementById('participantsPageTableBody');
      
      // Filter data
      let filtered = participantsSummary.filter(p => {
        if (search && !p.name.toLowerCase().includes(search) && !p.employeeId.toLowerCase().includes(search)) return false;
        if (entityFilter && p.entity !== entityFilter) return false;
        if (funcFilter && p.function !== funcFilter) return false;
        if (jobBandFilter && p.jobBand !== jobBandFilter) return false;
        return true;
      });
      
      // Store filtered data for pagination
      participantsFilteredData = filtered;
      const totalItems = filtered.length;
      const totalPages = Math.ceil(totalItems / participantsPageSize);
      
      // Ensure current page is valid
      if (participantsCurrentPage > totalPages) participantsCurrentPage = Math.max(1, totalPages);
      
      // Calculate slice indices
      const startIndex = (participantsCurrentPage - 1) * participantsPageSize;
      const endIndex = Math.min(startIndex + participantsPageSize, totalItems);
      const pageData = filtered.slice(startIndex, endIndex);

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><p>No participants found</p></div></td></tr>';
        updateParticipantsPagination(0, 0, 0, 0);
        return;
      }

      tbody.innerHTML = pageData.map(p => `
        <tr>
          <td style="padding:0.75rem 1rem;">
            <div style="font-weight:500;">${p.name || 'Unknown'}</div>
            <div style="font-size:0.7rem; color:var(--text-muted);">${p.employeeId}</div>
          </td>
          <td style="padding:0.75rem 1rem; font-size:0.85rem;">${p.entity || '-'}</td>
          <td style="padding:0.75rem 1rem; font-size:0.85rem;">${p.jobBand || '-'}</td>
          <td style="padding:0.75rem 1rem; font-size:0.85rem;">${p.function || '-'}</td>
          <td style="padding:0.75rem 1rem; font-size:0.85rem;">${p.subFunction || '-'}</td>
          <td style="padding:0.75rem 1rem; font-size:0.85rem;">
            ${p.email ? `<span style="display:flex; align-items:center; gap:0.25rem;">${p.email}<button class="btn-icon" style="background:none; border:none; padding:0.125rem; cursor:pointer; color:var(--text-muted);" onclick="copyEmail('${p.email}')" title="Copy"><i class="ri-file-copy-line" style="font-size:0.75rem;"></i></button></span>` : '-'}
          </td>
          <td style="padding:0.75rem 1rem; text-align:center; font-weight:600;">${p.sessionCount}</td>
          <td style="padding:0.75rem 1rem; text-align:center; font-weight:600;">${formatHours(p.totalHours)}</td>
          <td style="padding:0.75rem 1rem; text-align:center;">
            <button class="btn btn-secondary btn-sm" onclick="viewParticipantDetail('${p.employeeId}', '${escapeHtml(p.name)}', '${escapeHtml(p.function || '')}')">
              <i class="ri-eye-line"></i>
            </button>
          </td>
        </tr>
      `).join('');
      
      // Update pagination UI
      updateParticipantsPagination(startIndex + 1, endIndex, totalItems, totalPages);
    }
    
    function updateParticipantsPagination(start, end, total, totalPages) {
      document.getElementById('participantsShowingStart').textContent = total > 0 ? start : 0;
      document.getElementById('participantsShowingEnd').textContent = end;
      document.getElementById('participantsTotalCount').textContent = total;
      
      // Update prev/next buttons
      document.getElementById('participantsPrevBtn').disabled = participantsCurrentPage <= 1;
      document.getElementById('participantsNextBtn').disabled = participantsCurrentPage >= totalPages;
      
      // Generate page numbers
      const pageNumbersContainer = document.getElementById('participantsPageNumbers');
      let pageButtons = '';
      
      const maxVisiblePages = 5;
      let startPage = Math.max(1, participantsCurrentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pageButtons += `<button class="page-btn ${i === participantsCurrentPage ? 'active' : ''}" onclick="goToParticipantsPage(${i})">${i}</button>`;
      }
      
      pageNumbersContainer.innerHTML = pageButtons;
    }
    
    function changeParticipantsPage(delta) {
      participantsCurrentPage += delta;
      renderParticipantsPage();
    }
    
    function goToParticipantsPage(page) {
      participantsCurrentPage = page;
      renderParticipantsPage();
    }
    
    function changeParticipantsPageSize() {
      participantsPageSize = parseInt(document.getElementById('participantsPageSize').value);
      participantsCurrentPage = 1;
      renderParticipantsPage();
    }

    function populateParticipantFilters() {
      const entitySelect = document.getElementById('filterParticipantEntity');
      const funcSelect = document.getElementById('filterParticipantFunction');
      const jobBandSelect = document.getElementById('filterParticipantJobBand');
      
      if (entitySelect && participantFilters.entities) {
        entitySelect.innerHTML = '<option value="">All Entities</option>' + participantFilters.entities.map(e => `<option value="${e}">${e}</option>`).join('');
      }
      if (funcSelect && participantFilters.functions) {
        funcSelect.innerHTML = '<option value="">All Functions</option>' + participantFilters.functions.map(f => `<option value="${f}">${f}</option>`).join('');
      }
      if (jobBandSelect && participantFilters.jobBands) {
        jobBandSelect.innerHTML = '<option value="">All Job Bands</option>' + participantFilters.jobBands.map(j => `<option value="${j}">${j}</option>`).join('');
      }
    }

    function filterParticipantsTable() {
      participantsCurrentPage = 1; // Reset to first page when filtering
      renderParticipantsPage();
    }

    function clearParticipantFilters() {
      document.getElementById('participantsSearch').value = '';
      document.getElementById('filterParticipantEntity').value = '';
      document.getElementById('filterParticipantFunction').value = '';
      document.getElementById('filterParticipantJobBand').value = '';
      participantsCurrentPage = 1;
      renderParticipantsPage();
    }

    function copyEmail(email) {
      navigator.clipboard.writeText(email).then(() => showToast('Email copied!', 'success')).catch(() => showToast('Copy failed', 'error'));
    }

    // Store current participant for export
    let currentParticipantForExport = null;
    
    async function viewParticipantDetail(employeeId, name, func) {
      // Store for export
      currentParticipantForExport = { employeeId, name, func };
      
      document.getElementById('participantDetailModal').classList.add('active');
      document.getElementById('participantDetailName').textContent = name;
      document.getElementById('participantDetailInfo').textContent = `${employeeId}  ${func || 'N/A'}`;
      
      // Show loading state with cached summary data
      const cached = participantsSummary.find(p => p.employeeId === employeeId);
      if (cached) {
        document.getElementById('participantTotalSessions').textContent = cached.sessionCount || 0;
        document.getElementById('participantTotalHours').textContent = formatHours(cached.totalHours || 0);
      }
      
      document.getElementById('participantSessionsBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:var(--text-muted);"><i class="ri-loader-4-line" style="animation:spin 1s linear infinite;"></i> Loading...</td></tr>';
      
      try {
        const data = await api('getParticipantSessions', employeeId);
        
        if (data.summary) {
          document.getElementById('participantTotalSessions').textContent = data.summary.totalSessions || 0;
          document.getElementById('participantTotalHours').textContent = formatHours(data.summary.totalHours || 0);
        }
        
        const tbody = document.getElementById('participantSessionsBody');
        if (!data.sessions?.length) {
          tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state" style="padding:1rem;">No sessions found</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = data.sessions.map(s => `
          <tr>
            <td style="padding:0.5rem 1rem;">${formatDate(s.date)}</td>
            <td style="padding:0.5rem 1rem;">${s.programName}</td>
            <td style="padding:0.5rem 1rem;">${s.sessionName}</td>
            <td style="padding:0.5rem 1rem; text-align:center;">${formatHours(s.hours)}</td>
            <td style="padding:0.5rem 1rem; text-align:center;"><span class="status-badge status-${s.status}">${s.status}</span></td>
          </tr>
        `).join('');
      } catch (e) {
        document.getElementById('participantSessionsBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:var(--danger);">Error loading data</td></tr>';
      }
    }
    
    async function exportParticipantHistoryPDF() {
      if (!currentParticipantForExport) {
        showToast('No participant selected', 'error');
        return;
      }
      
      const { employeeId, name } = currentParticipantForExport;
      const filter = `${employeeId} - ${name}`;
      
      showLoading('Generating PDF...');
      
      try {
        const result = await api('generatePDF', 'All', filter, 'employee');
        
        if (result.success) {
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = `Training_History_${name.replace(/\s+/g, '_')}.pdf`;
          link.click();
          showToast('PDF downloaded!', 'success');
        } else {
          showToast('Error: ' + (result.message || 'Failed to generate PDF'), 'error');
        }
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    function closeParticipantDetailModal() {
      document.getElementById('participantDetailModal').classList.remove('active');
      currentParticipantForExport = null;
    }

    function escapeHtml(str) {
      return (str || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function formatHours(h) {
      if (!h) return '0:00';
      const hrs = Math.floor(h);
      const mins = Math.round((h - hrs) * 60);
      return `${hrs}:${String(mins).padStart(2, '0')}`;
    }

    // Session Modal
    function openSessionModal() {
      document.getElementById('sessionModal').classList.add('active');
      resetSessionForm();
      hideParticipantNotification();
      switchSessionTab('details');
    }

    function openSessionModalForProgram(programId, year, month) {
      openSessionModal();
      const program = programs.find(p => p.id === programId);
      if (program) {
        document.getElementById('sessionProgram').value = programId;
        document.getElementById('sessionProgramSearch').value = program.name;
        document.getElementById('bulkProgram').value = programId;
        document.getElementById('bulkProgramSearch').value = program.name;
      }
      currentProgramId = programId;
    }

    async function openSessionForEdit(sessionId) {
      showLoading('Loading session...');
      
      try {
        // Check if we already have session data cached
        let s = sessions.find(x => x.sessionId === sessionId);
        
        // If not cached, fetch from server
        if (!s) {
          const sessionsList = await api('getSessionsList');
          s = sessionsList.find(x => x.sessionId === sessionId);
        }
        
        if (!s) {
          hideLoading();
          showToast('Session not found', 'error');
          return;
        }
        
        // Get additional details first to check canEdit
        const details = await api('getSessionDetails', s.programId, sessionId);
        const canEdit = details?.canEdit !== false;
        
        // Store canEdit for later use
        window.currentSessionCanEdit = canEdit;
        
        // Get additional details in parallel with opening modal
        openSessionModal();
        editingSessionId = sessionId;
        currentProgramId = s.programId;
        
        // Set basic fields from cached data first
        document.getElementById('currentSessionId').textContent = sessionId;
        document.getElementById('sessionProgram').value = s.programId || '';
        // Set program search field with name
        const prog = programs.find(p => p.id === s.programId);
        document.getElementById('sessionProgramSearch').value = prog ? prog.name : '';
        document.getElementById('sessionName').value = s.name || '';
        document.getElementById('sessionStatus').value = s.status || 'Open';
        
        // Show/hide view-only notice and buttons based on permissions
        const viewOnlyNotice = document.getElementById('viewOnlyNotice');
        const deleteBtn = document.getElementById('deleteSessionBtn');
        const saveBtn = document.getElementById('saveSessionBtn');
        
        if (viewOnlyNotice) viewOnlyNotice.style.display = canEdit ? 'none' : 'flex';
        if (deleteBtn) deleteBtn.style.display = canEdit ? 'block' : 'none';
        if (saveBtn) saveBtn.style.display = canEdit ? 'block' : 'none';
        
        document.getElementById('sessionModalTitle').textContent = canEdit ? 'Edit Session' : 'View Session';
        if (saveBtn) saveBtn.textContent = 'Update Session';
        
        // Make form inputs read-only if no permission
        setSessionFormReadOnly(!canEdit);
        
        updateStepperState(true, true); // true, true = sessionSaved, isEditing
        switchSessionTab('details');
        
        if (details) {
          document.getElementById('sessionDate').value = details.date || s.date || '';
          document.getElementById('sessionType').value = details.type || 'Classroom';
          document.getElementById('sessionProvider').value = details.provider || 'Internal';
          document.getElementById('sessionLocation').value = details.location || '';
          document.getElementById('sessionIndivDev').checked = details.isIndivDev === 'Yes';
          document.getElementById('sessionTrackQR').checked = details.trackQR === 'Yes';
          document.getElementById('sessionDuration').value = decimalToHHMM(details.duration || 1);
          document.getElementById('sessionScore').value = details.score || 0;
          
          const entitySelect = document.getElementById('sessionEntity');
          if (entitySelect && details.entity) {
            entitySelect.value = details.entity;
          }
          
          // Show audit info fields
          const auditInfoGroup = document.getElementById('auditInfoGroup');
          const createdByInput = document.getElementById('sessionCreatedBy');
          const createdOnInput = document.getElementById('sessionCreatedOn');
          if (auditInfoGroup) auditInfoGroup.style.display = 'flex';
          if (createdByInput) createdByInput.value = details.modifiedBy || '-';
          if (createdOnInput) createdOnInput.value = details.modifiedOn || '-';
          
          // Store trackQR for participant display logic
          window.currentSessionTrackQR = details.trackQR === 'Yes';
        }
        
        toggleIndivDev();
        updateScoreBar();
        autoSetStatus();
        
        // DON'T load participants here - lazy load when tab is clicked
        // loadParticipants(sessionId); // REMOVED for lazy loading
        
        // Reset lazy load flags
        window.participantsLoadedForSession = false;
        window.surveyLoadedForSession = false;
        
      } catch (e) {
        showToast('Error loading session: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function setSessionFormReadOnly(readOnly) {
      // Make inputs read-only based on permission
      const inputs = ['sessionProgramSearch', 'sessionName', 'sessionDate', 'sessionLocation'];
      const selects = ['sessionStatus', 'sessionType', 'sessionProvider', 'sessionEntity'];
      const checkboxes = ['sessionIndivDev', 'sessionTrackQR'];
      
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.readOnly = readOnly;
      });
      
      selects.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = readOnly;
      });
      
      checkboxes.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = readOnly;
      });
      
      // Duration steppers
      const durationBtns = document.querySelectorAll('.stepper-btn');
      durationBtns.forEach(btn => btn.disabled = readOnly);
    }

    function resetSessionForm() {
      editingSessionId = null;
      currentProgramId = null;
      selectedEmployeeIds.clear();
      currentParticipants = [];
      bulkRows = [newBulkRowData()];
      
      // Reset lazy load flags
      window.participantsLoadedForSession = false;
      window.surveyLoadedForSession = false;
      
      const currentSessionIdEl = document.getElementById('currentSessionId');
      const sessionProgramEl = document.getElementById('sessionProgram');
      const sessionProgramSearchEl = document.getElementById('sessionProgramSearch');
      const sessionNameEl = document.getElementById('sessionName');
      const sessionDateEl = document.getElementById('sessionDate');
      const sessionTypeEl = document.getElementById('sessionType');
      const sessionStatusEl = document.getElementById('sessionStatus');
      const sessionProviderEl = document.getElementById('sessionProvider');
      const sessionLocationEl = document.getElementById('sessionLocation');
      const sessionIndivDevEl = document.getElementById('sessionIndivDev');
      const sessionTrackQREl = document.getElementById('sessionTrackQR');
      const sessionDurationEl = document.getElementById('sessionDuration');
      const sessionScoreEl = document.getElementById('sessionScore');
      
      if (currentSessionIdEl) currentSessionIdEl.textContent = 'New';
      if (sessionProgramEl) sessionProgramEl.value = '';
      if (sessionProgramSearchEl) sessionProgramSearchEl.value = '';
      if (sessionNameEl) sessionNameEl.value = '';
      if (sessionDateEl) sessionDateEl.value = '';
      if (sessionTypeEl) sessionTypeEl.value = 'Classroom';
      if (sessionStatusEl) sessionStatusEl.value = 'Open';
      if (sessionProviderEl) sessionProviderEl.value = 'Internal';
      if (sessionLocationEl) sessionLocationEl.value = '';
      if (sessionIndivDevEl) sessionIndivDevEl.checked = false;
      if (sessionTrackQREl) sessionTrackQREl.checked = false;
      if (sessionDurationEl) sessionDurationEl.value = '1:00';
      if (sessionScoreEl) sessionScoreEl.value = '0';
      
      // Reset trackQR state
      window.currentSessionTrackQR = false;
      window.currentSessionCanEdit = true;
      
      // Reset entity - default to primary entity or first option
      const entitySelect = document.getElementById('sessionEntity');
      if (entitySelect) {
        entitySelect.value = currentUser.primaryEntity || (entityOptions.length === 1 ? entityOptions[0] : '');
      }
      
      // Hide audit info for new sessions
      const auditInfoGroup = document.getElementById('auditInfoGroup');
      if (auditInfoGroup) auditInfoGroup.style.display = 'none';
      
      // Hide view-only notice
      const viewOnlyNotice = document.getElementById('viewOnlyNotice');
      if (viewOnlyNotice) viewOnlyNotice.style.display = 'none';
      
      // Reset form to editable
      setSessionFormReadOnly(false);
      
      // Reset bulk program search
      const bulkProgramEl = document.getElementById('bulkProgram');
      const bulkProgramSearchEl = document.getElementById('bulkProgramSearch');
      if (bulkProgramEl) bulkProgramEl.value = '';
      if (bulkProgramSearchEl) bulkProgramSearchEl.value = '';
      
      toggleIndivDev();
      updateScoreBar();
      
      const deleteBtn = document.getElementById('deleteSessionBtn');
      const modalTitle = document.getElementById('sessionModalTitle');
      const saveBtn = document.getElementById('saveSessionBtn');
      
      if (deleteBtn) deleteBtn.style.display = 'none';
      if (modalTitle) modalTitle.textContent = 'New Training Session';
      if (saveBtn) {
        saveBtn.textContent = 'Save Session';
        saveBtn.style.display = 'block'; // Show save button for new sessions
      }
      
      // Reset stepper state - participants disabled for new session
      updateStepperState(false, false);
      
      // Reset survey state
      currentSessionFormUrls = { feedback: null, survey: null, assessment: null };
      updateFormCard('feedback', null, 0);
      updateFormCard('survey', null, 0);
      updateFormCard('assessment', null, 0);
      
      renderBulkRows();
      renderEmployeeList();
      renderParticipantsTable();
    }

    function updateStepperState(sessionSaved, isEditing = false) {
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const stepOr = document.querySelector('.stepper-or');
      const step3 = document.getElementById('step3');
      const step4 = document.getElementById('step4');
      const stepLine1 = document.getElementById('stepLine1');
      const stepLine2 = document.getElementById('stepLine2');
      const participantsTab = document.getElementById('participantsTab');
      const surveyTab = document.getElementById('surveyTab');
      const bulkTab = document.querySelector('.tab[data-tab="bulk"]');
      
      // Hide Bulk Create when editing existing session
      if (isEditing) {
        if (step2) step2.style.display = 'none';
        if (stepOr) stepOr.style.display = 'none';
        // Change step numbers when editing (no Bulk Create)
        if (step3) {
          const circle = step3.querySelector('.stepper-circle');
          if (circle) circle.textContent = '2';
        }
        if (step4) {
          const circle = step4.querySelector('.stepper-circle');
          if (circle) circle.textContent = '3';
        }
        if (bulkTab) bulkTab.style.display = 'none';
      } else {
        if (step2) step2.style.display = 'flex';
        if (stepOr) stepOr.style.display = 'flex';
        // Reset step numbers for new session
        if (step3) {
          const circle = step3.querySelector('.stepper-circle');
          if (circle) circle.textContent = '3';
        }
        if (step4) {
          const circle = step4.querySelector('.stepper-circle');
          if (circle) circle.textContent = '4';
        }
        if (bulkTab) bulkTab.style.display = 'flex';
      }
      
      if (sessionSaved) {
        if (step1) step1.classList.add('completed');
        if (step2) step2.classList.add('completed');
        if (step3) {
          step3.classList.remove('disabled');
          step3.classList.add('active');
        }
        if (step4) {
          step4.classList.remove('disabled');
        }
        if (stepLine1) stepLine1.classList.add('completed');
        if (participantsTab) {
          participantsTab.disabled = false;
          participantsTab.style.opacity = '1';
        }
        if (surveyTab) {
          surveyTab.disabled = false;
          surveyTab.style.opacity = '1';
        }
      } else {
        if (step1) {
          step1.classList.remove('completed');
          step1.classList.add('active');
        }
        if (step2) step2.classList.remove('completed', 'active');
        if (step3) {
          step3.classList.add('disabled');
          step3.classList.remove('active', 'completed');
        }
        if (step4) {
          step4.classList.add('disabled');
          step4.classList.remove('active', 'completed');
        }
        if (stepLine1) stepLine1.classList.remove('completed');
        if (stepLine2) stepLine2.classList.remove('completed');
        if (participantsTab) {
          participantsTab.disabled = true;
          participantsTab.style.opacity = '0.5';
        }
        if (surveyTab) {
          surveyTab.disabled = true;
          surveyTab.style.opacity = '0.5';
        }
      }
    }

    function closeSessionModal() {
      document.getElementById('sessionModal').classList.remove('active');
      resetSessionForm();
    }

    async function switchSessionTab(tab) {
      // Check if participants/survey tab is allowed
      if ((tab === 'participants' || tab === 'survey') && !editingSessionId) {
        showToast('Please save the session first', 'error');
        return;
      }
      
      document.querySelectorAll('#sessionModal .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      
      const tabDetails = document.getElementById('tab-details');
      const tabBulk = document.getElementById('tab-bulk');
      const tabParticipants = document.getElementById('tab-participants');
      const tabSurvey = document.getElementById('tab-survey');
      
      if (tabDetails) tabDetails.classList.toggle('hidden', tab !== 'details');
      if (tabBulk) tabBulk.classList.toggle('hidden', tab !== 'bulk');
      if (tabParticipants) tabParticipants.classList.toggle('hidden', tab !== 'participants');
      if (tabSurvey) tabSurvey.classList.toggle('hidden', tab !== 'survey');
      
      // Toggle footer visibility based on tab
      const footerSession = document.getElementById('footerSessionDetails');
      const footerParticipants = document.getElementById('footerParticipants');
      const footerSurvey = document.getElementById('footerSurvey');
      
      if (tab === 'participants') {
        if (footerSession) footerSession.classList.add('hidden');
        if (footerParticipants) footerParticipants.classList.remove('hidden');
        if (footerSurvey) footerSurvey.classList.add('hidden');
      } else if (tab === 'survey') {
        if (footerSession) footerSession.classList.add('hidden');
        if (footerParticipants) footerParticipants.classList.add('hidden');
        if (footerSurvey) footerSurvey.classList.remove('hidden');
      } else {
        if (footerSession) footerSession.classList.remove('hidden');
        if (footerParticipants) footerParticipants.classList.add('hidden');
        if (footerSurvey) footerSurvey.classList.add('hidden');
      }
      
      // Update stepper visuals
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const step4 = document.getElementById('step4');
      const stepLine2 = document.getElementById('stepLine2');
      
      if (step1) step1.classList.toggle('active', tab === 'details');
      if (step2) step2.classList.toggle('active', tab === 'bulk');
      if (editingSessionId && step3) {
        step3.classList.toggle('active', tab === 'participants');
        if (tab === 'survey') step3.classList.add('completed');
      }
      if (editingSessionId && step4) {
        step4.classList.toggle('active', tab === 'survey');
        if (stepLine2 && tab === 'survey') stepLine2.classList.add('completed');
      }
      
      if (tab === 'bulk') renderBulkRows();
      if (tab === 'participants') {
        // LAZY LOAD: Only load participants if not already loaded for this session
        if (!window.participantsLoadedForSession) {
          await loadParticipants(editingSessionId);
          window.participantsLoadedForSession = true;
        }
        await ensureEmployeesLoaded();
        renderEmployeeList();
        populateFilterDropdowns();
        renderParticipantsTable(); // Re-render in case data changed
      }
      if (tab === 'survey') {
        // LAZY LOAD: Only load survey data if not already loaded for this session
        if (!window.surveyLoadedForSession) {
          await loadSurveyData();
          window.surveyLoadedForSession = true;
        }
      }
    }

    // Auto Status
    function autoSetStatus() {
      const dateVal = document.getElementById('sessionDate').value;
      if (!dateVal) return;
      
      const inputDate = new Date(dateVal);
      inputDate.setHours(0, 0, 0, 0);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      document.getElementById('sessionStatus').value = inputDate <= today ? 'Completed' : 'Open';
      updateScoreState();
    }

    function updateScoreState() {
      const isOpen = document.getElementById('sessionStatus').value === 'Open';
      const container = document.getElementById('scoreStepperContainer');
      const input = document.getElementById('sessionScore');
      
      if (isOpen) {
        container.style.opacity = '0.5';
        container.style.pointerEvents = 'none';
        input.disabled = true;
      } else {
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
        input.disabled = false;
      }
    }

    // Duration Stepper
    function adjustDuration(delta) {
      const input = document.getElementById('sessionDuration');
      let mins = hhmmToMinutes(input.value);
      mins = Math.max(30, mins + delta);
      input.value = minutesToHHMM(mins);
    }

    // Score Stepper
    function adjustScore(delta) {
      const input = document.getElementById('sessionScore');
      let val = parseFloat(input.value) || 0;
      val = Math.max(0, Math.min(5, val + delta));
      input.value = val.toFixed(2);
      updateScoreBar();
    }

    function updateScoreBar() {
      const val = parseFloat(document.getElementById('sessionScore').value) || 0;
      const bar = document.getElementById('scoreBarFill');
      const pct = Math.min(100, (val / 5) * 100);
      bar.style.width = pct + '%';
      
      if (val < 2.5) bar.style.backgroundColor = 'var(--danger)';
      else if (val < 4) bar.style.backgroundColor = 'var(--warning)';
      else bar.style.backgroundColor = 'var(--primary)';
    }

    // IndivDev
    function toggleIndivDev() {
      const prov = document.getElementById('sessionProvider').value;
      const wrapper = document.getElementById('indivDevWrapper');
      const checkbox = document.getElementById('sessionIndivDev');
      
      if (prov === 'External') {
        wrapper.classList.remove('hidden');
      } else {
        wrapper.classList.add('hidden');
        checkbox.checked = false;
      }
      
      updateCostColumns();
    }

    function updateCostColumns() {
      const showCost = document.getElementById('sessionIndivDev').checked;
      document.getElementById('colCurrency').classList.toggle('hidden', !showCost);
      document.getElementById('colCost').classList.toggle('hidden', !showCost);
    }

    // Save Session
    async function saveSession() {
      // Check if in view-only mode
      if (editingSessionId && window.currentSessionCanEdit === false) {
        showToast('You do not have permission to edit this session', 'error');
        return;
      }
      
      const activeTab = document.querySelector('#sessionModal .tab.active').dataset.tab;
      
      if (activeTab === 'bulk') {
        await saveBulkSessions();
        return;
      }
      
      const programId = document.getElementById('sessionProgram').value;
      const name = document.getElementById('sessionName').value.trim();
      const date = document.getElementById('sessionDate').value;
      const entity = document.getElementById('sessionEntity').value;
      const type = document.getElementById('sessionType').value;
      const provider = document.getElementById('sessionProvider').value;
      const duration = document.getElementById('sessionDuration').value;

      // Validate all required fields
      const missingFields = [];
      if (!programId) missingFields.push('Program');
      if (!name) missingFields.push('Session Name');
      if (!date) missingFields.push('Date');
      if (!type) missingFields.push('Type');
      if (!provider) missingFields.push('Provider');
      if (!duration) missingFields.push('Duration');
      
      if (missingFields.length > 0) {
        showToast(`Please fill required fields: ${missingFields.join(', ')}`, 'error');
        return;
      }
      
      if (!entity && !editingSessionId) {
        showToast('Please select an entity', 'error');
        return;
      }

      const data = {
        programId,
        sessionId: editingSessionId,
        name,
        date,
        entity,
        type: document.getElementById('sessionType').value,
        status: document.getElementById('sessionStatus').value,
        provider: document.getElementById('sessionProvider').value,
        location: document.getElementById('sessionLocation').value,
        isIndivDev: document.getElementById('sessionIndivDev').checked ? 'Yes' : 'No',
        trackQR: document.getElementById('sessionTrackQR').checked ? 'Yes' : 'No',
        duration: hhmmToDecimal(document.getElementById('sessionDuration').value),
        score: document.getElementById('sessionScore').value
      };
      
      // Update stored trackQR state
      window.currentSessionTrackQR = document.getElementById('sessionTrackQR').checked;

      try {
        showLoading('Saving...');
        if (editingSessionId) {
          // Update existing session
          await api('updateSession', data);
          
          // Track as just modified
          justModifiedSessionId = editingSessionId;
          newlyCreatedSessionIds.clear(); // Clear any new flags
          
          // Get program name for auto-filter
          const prog = programs.find(p => p.id === programId);
          if (prog) {
            highlightProgramFilter = prog.name;
          }
          
          // Close modal and navigate to Sessions
          closeSessionModal();
          
          // Force sessions to reload
          dataLoaded.sessions = false;
          dataLoaded.calendar = false;
          
          // Navigate to Sessions page
          await navigateTo('sessions');
          
          showToast('Session updated!', 'success');
          return;
        } else {
          // Create new session
          const result = await api('createSessionFast', data);
          
          // Track as newly created
          if (result && result.sessionId) {
            newlyCreatedSessionIds = new Set([result.sessionId]);
          }
          justModifiedSessionId = null; // Clear any modified flag
          
          // Get program name for auto-filter
          const prog = programs.find(p => p.id === programId);
          if (prog) {
            highlightProgramFilter = prog.name;
          }
          
          // Close modal
          closeSessionModal();
          
          // Force sessions to reload
          dataLoaded.sessions = false;
          dataLoaded.calendar = false;
          
          // Navigate to Sessions page (will reload data)
          await navigateTo('sessions');
          
          // Show toast after navigation completes
          showToast('Session created!', 'success');
          return; // Exit early for new session
        }
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    async function deleteCurrentSession() {
      if (!editingSessionId) return;
      
      // Check if in view-only mode
      if (window.currentSessionCanEdit === false) {
        showToast('You do not have permission to delete this session', 'error');
        return;
      }
      
      if (!confirm('Delete this session? This cannot be undone.')) return;
      
      try {
        showLoading('Deleting...');
        await api('deleteSession', editingSessionId);
        closeSessionModal();
        await refreshData();
        showToast('Session deleted', 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    // Bulk Create
    function newBulkRowData() {
      const defaultEntity = currentUser.primaryEntity || (entityOptions.length === 1 ? entityOptions[0] : '');
      return { name: '', status: 'Open', type: 'Classroom', provider: 'Internal', entity: defaultEntity, indiv: false, date: '', location: '', duration: '1:00', score: '0' };
    }

    function addBulkRow() {
      bulkRows.push(newBulkRowData());
      renderBulkRows();
    }

    function renderBulkRows() {
      const container = document.getElementById('bulkRows');
      const bulkEntityOptions = entityOptions.map(e => `<option value="${e}">${e}</option>`).join('');
      
      container.innerHTML = bulkRows.map((r, i) => {
        const isInternal = r.provider === 'Internal';
        return `
          <div class="bulk-row">
            <div class="bulk-cell center" style="display:none;"><span class="session-badge" style="font-size:0.6rem; padding:0.2rem 0.4rem;">Auto</span></div>
            <div class="bulk-cell"><input type="text" value="${r.name}" placeholder="Name" onchange="updateBulkRow(${i}, 'name', this.value)"></div>
            <div class="bulk-cell"><select disabled style="background:#f1f3f4; font-size:0.7rem;"><option>${r.status}</option></select></div>
            <div class="bulk-cell"><select style="font-size:0.7rem;" onchange="updateBulkRow(${i}, 'type', this.value)"><option ${r.type==='Classroom'?'selected':''}>Classroom</option><option ${r.type==='E-Learning'?'selected':''}>E-Learning</option><option ${r.type==='Online'?'selected':''}>Online</option></select></div>
            <div class="bulk-cell"><select style="font-size:0.7rem;" onchange="updateBulkRow(${i}, 'provider', this.value)"><option ${r.provider==='Internal'?'selected':''}>Internal</option><option ${r.provider==='External'?'selected':''}>External</option></select></div>
            <div class="bulk-cell"><select style="font-size:0.7rem;" onchange="updateBulkRow(${i}, 'entity', this.value)">${bulkEntityOptions.replace(`value="${r.entity}"`, `value="${r.entity}" selected`)}</select></div>
            <div class="bulk-cell center" style="${isInternal ? 'opacity:0.5;' : ''}"><input type="checkbox" ${r.indiv?'checked':''} ${isInternal?'disabled':''} onchange="updateBulkRow(${i}, 'indiv', this.checked)"></div>
            <div class="bulk-cell"><input type="date" value="${r.date}" style="font-size:0.75rem;" onchange="updateBulkRow(${i}, 'date', this.value)"></div>
            <div class="bulk-cell"><input type="text" value="${r.location}" placeholder="Location" style="font-size:0.75rem;" onchange="updateBulkRow(${i}, 'location', this.value)"></div>
            <div class="bulk-cell">
              <div class="bulk-stepper">
                <button type="button" onclick="adjustBulkDuration(${i}, -0.5)"></button>
                <input type="text" value="${r.duration}" onchange="updateBulkRow(${i}, 'duration', this.value)">
                <button type="button" onclick="adjustBulkDuration(${i}, 0.5)">+</button>
              </div>
            </div>
            <div class="bulk-cell">
              <div class="bulk-stepper">
                <button type="button" onclick="adjustBulkScore(${i}, -0.5)"></button>
                <input type="number" value="${r.score}" step="0.5" min="0" max="5" onchange="updateBulkRow(${i}, 'score', this.value)">
                <button type="button" onclick="adjustBulkScore(${i}, 0.5)">+</button>
              </div>
            </div>
            <div class="bulk-cell center"><button onclick="removeBulkRow(${i})" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1rem;"></button></div>
          </div>`;
      }).join('');
    }

    function adjustBulkDuration(idx, delta) {
      const current = bulkRows[idx].duration || '1:00';
      const decimal = hhmmToDecimal(current);
      const newVal = Math.max(0.5, parseFloat(decimal) + delta);
      bulkRows[idx].duration = decimalToHHMM(newVal);
      renderBulkRows();
    }
    
    function adjustBulkScore(idx, delta) {
      const current = parseFloat(bulkRows[idx].score) || 0;
      const newVal = Math.min(5, Math.max(0, current + delta));
      bulkRows[idx].score = newVal;
      renderBulkRows();
    }

    function updateBulkRow(idx, field, val) {
      bulkRows[idx][field] = val;
      if (field === 'provider' && val === 'Internal') bulkRows[idx].indiv = false;
      if (field === 'date') {
        const d = new Date(val);
        d.setHours(0,0,0,0);
        const today = new Date();
        today.setHours(0,0,0,0);
        bulkRows[idx].status = d <= today ? 'Completed' : 'Open';
      }
      renderBulkRows();
    }

    function removeBulkRow(idx) {
      bulkRows.splice(idx, 1);
      if (!bulkRows.length) bulkRows.push(newBulkRowData());
      renderBulkRows();
    }

    async function saveBulkSessions() {
      const programId = document.getElementById('bulkProgram').value;
      
      if (!programId) { showToast('Please select a program', 'error'); return; }
      
      // Check for rows with any data entered
      const rowsWithData = bulkRows.filter(r => r.name || r.date || r.entity);
      if (!rowsWithData.length) { showToast('Please fill at least one row', 'error'); return; }
      
      // Validate all required fields for each row with data
      const requiredFields = ['name', 'type', 'provider', 'entity', 'date', 'duration'];
      for (let i = 0; i < bulkRows.length; i++) {
        const row = bulkRows[i];
        // Skip completely empty rows
        if (!row.name && !row.date && !row.entity) continue;
        
        // Check required fields
        const missingFields = [];
        if (!row.name) missingFields.push('Name');
        if (!row.type) missingFields.push('Type');
        if (!row.provider) missingFields.push('Provider');
        if (!row.entity) missingFields.push('Entity');
        if (!row.date) missingFields.push('Date');
        if (!row.duration) missingFields.push('Duration');
        
        if (missingFields.length > 0) {
          showToast(`Row ${i + 1}: Please fill required fields (${missingFields.join(', ')})`, 'error');
          return;
        }
      }
      
      const validRows = bulkRows.filter(r => r.name && r.date && r.entity);
      
      try {
        showProgressModal('Creating Sessions', validRows.length);
        let saved = 0;
        const createdSessionIds = [];
        
        for (const row of validRows) {
          updateProgress(saved, validRows.length, `Creating: ${row.name}`);
          const result = await api('createSessionFast', {
            programId,
            name: row.name,
            date: row.date,
            type: row.type,
            status: row.status,
            provider: row.provider,
            entity: row.entity,
            isIndivDev: row.indiv ? 'Yes' : 'No',
            location: row.location,
            duration: hhmmToDecimal(row.duration),
            score: row.score
          });
          
          // Track created session ID
          if (result && result.sessionId) {
            createdSessionIds.push(result.sessionId);
          }
          
          saved++;
          updateProgress(saved, validRows.length, saved === validRows.length ? 'Complete!' : `Creating: ${validRows[saved]?.name || '...'}`);
        }
        
        hideProgressModal();
        closeSessionModal();
        
        // Store newly created session IDs for highlighting
        newlyCreatedSessionIds = new Set(createdSessionIds);
        justModifiedSessionId = null; // Clear any modified flag
        
        // Get program name for auto-filter
        const prog = programs.find(p => p.id === programId);
        if (prog) {
          highlightProgramFilter = prog.name;
        }
        
        // Force sessions to reload
        dataLoaded.sessions = false;
        dataLoaded.calendar = false;
        
        // Navigate to Sessions page (will reload data)
        await navigateTo('sessions');
        
        // Show toast after navigation completes
        showToast(`${saved} session(s) created!`, 'success');
      } catch (e) {
        hideProgressModal();
        showToast('Error: ' + (e.message || e), 'error');
      }
    }

    // Participants
    // Handle Track QR checkbox change
    async function onTrackQRChange() {
      const trackQR = document.getElementById('sessionTrackQR').checked;
      window.currentSessionTrackQR = trackQR;
      
      // Update QR buttons visibility
      const btnDownloadQR = document.getElementById('btnDownloadQR');
      const btnEmailQR = document.getElementById('btnEmailQR');
      if (btnDownloadQR) btnDownloadQR.style.display = trackQR ? 'inline-flex' : 'none';
      if (btnEmailQR) btnEmailQR.style.display = trackQR ? 'inline-flex' : 'none';
      
      // Re-render participants table to update status display
      renderParticipantsTable();
      
      // Save to backend if we have a session
      if (editingSessionId) {
        try {
          await api('updateSessionTrackQR', editingSessionId, trackQR ? 'Yes' : 'No');
        } catch (e) {
          console.error('Failed to save trackQR setting:', e);
        }
      }
    }

    async function loadParticipants(sessionId) {
      console.log('=== loadParticipants START ===');
      console.log('Session ID:', sessionId);
      console.log('Session ID type:', typeof sessionId);
      
      if (!sessionId) {
        console.error('loadParticipants: No sessionId provided');
        currentParticipants = [];
        renderParticipantsTable();
        return;
      }
      
      // Show/hide QR buttons based on trackQR setting
      const trackQR = window.currentSessionTrackQR || false;
      const btnDownloadQR = document.getElementById('btnDownloadQR');
      const btnEmailQR = document.getElementById('btnEmailQR');
      if (btnDownloadQR) btnDownloadQR.style.display = trackQR ? 'inline-flex' : 'none';
      if (btnEmailQR) btnEmailQR.style.display = trackQR ? 'inline-flex' : 'none';
      
      try {
        const enrollments = await api('getEnrollments', sessionId);
        console.log('getEnrollments raw response:', enrollments);
        console.log('getEnrollments response type:', typeof enrollments);
        console.log('Is array:', Array.isArray(enrollments));
        
        if (Array.isArray(enrollments)) {
          currentParticipants = enrollments;
          console.log('Set currentParticipants, count:', currentParticipants.length);
          if (currentParticipants.length > 0) {
            console.log('First participant:', JSON.stringify(currentParticipants[0]));
          }
        } else {
          console.warn('Enrollments is not an array, setting empty');
          currentParticipants = [];
        }
        
        renderParticipantsTable();
        console.log('=== loadParticipants END ===');
      } catch (e) {
        console.error('loadParticipants error:', e);
        currentParticipants = [];
        renderParticipantsTable();
      }
    }

    function populateFilterDropdowns() {
      const funcs = new Set();
      const subs = new Set();
      employees.forEach(e => {
        if (e.function) funcs.add(e.function);
        if (e.subFunction) subs.add(e.subFunction);
      });
      
      document.getElementById('filterFunction').innerHTML = '<option value="">All Functions</option>' + Array.from(funcs).sort().map(f => `<option value="${f}">${f}</option>`).join('');
      document.getElementById('filterSubFunction').innerHTML = '<option value="">All Sub-Functions</option>' + Array.from(subs).sort().map(s => `<option value="${s}">${s}</option>`).join('');
    }

    let filteredEmployeesList = []; // Cache filtered employees for Select All
    
    function renderEmployeeList() {
      const container = document.getElementById('employeeList');
      const search = (document.getElementById('employeeSearch')?.value || '').toLowerCase();
      const funcFilter = document.getElementById('filterFunction')?.value || '';
      const subFilter = document.getElementById('filterSubFunction')?.value || '';
      
      const existingIds = new Set(currentParticipants.map(p => p.employeeId));
      
      filteredEmployeesList = (employees || []).filter(e => {
        if (existingIds.has(e.id)) return false;
        if (funcFilter && e.function !== funcFilter) return false;
        if (subFilter && e.subFunction !== subFilter) return false;
        if (search && !e.name.toLowerCase().includes(search) && !e.id.toLowerCase().includes(search)) return false;
        return true;
      });
      
      // Update filtered count
      const countEl = document.getElementById('filteredEmployeeCount');
      const totalFiltered = filteredEmployeesList.length;
      const displayLimit = 200;
      const displayCount = Math.min(totalFiltered, displayLimit);
      
      if (countEl) {
        if (totalFiltered > displayLimit) {
          countEl.textContent = `${displayCount} of ${totalFiltered}`;
        } else {
          countEl.textContent = displayCount;
        }
      }
      
      // Update Select All checkbox state
      const selectAllCheckbox = document.getElementById('selectAllEmployees');
      if (selectAllCheckbox && filteredEmployeesList.length > 0) {
        const visibleIds = filteredEmployeesList.slice(0, displayLimit).map(e => e.id);
        const allSelected = visibleIds.every(id => selectedEmployeeIds.has(id));
        const someSelected = visibleIds.some(id => selectedEmployeeIds.has(id));
        selectAllCheckbox.checked = allSelected;
        selectAllCheckbox.indeterminate = someSelected && !allSelected;
      }
      
      if (!filteredEmployeesList.length) {
        container.innerHTML = '<div class="empty-state" style="padding:1rem; font-size:0.8rem;">No employees found</div>';
        document.getElementById('selectAllEmployeesRow').style.display = 'none';
        return;
      }
      
      document.getElementById('selectAllEmployeesRow').style.display = 'flex';
      
      // Use DocumentFragment for better performance (show max 200)
      container.innerHTML = filteredEmployeesList.slice(0, 200).map(e => `
        <label class="employee-item">
          <input type="checkbox" value="${e.id}" ${selectedEmployeeIds.has(e.id) ? 'checked' : ''} onchange="toggleEmployeeSelection('${e.id}')">
          <div class="employee-info">
            <div class="employee-name">${e.name}</div>
            <div class="employee-id">${e.id}</div>
          </div>
        </label>
      `).join('');
      
      // Show message if more results available
      if (filteredEmployeesList.length > 200) {
        container.innerHTML += '<div style="padding:10px; text-align:center; font-size:0.75rem; color:#6b7280; background:#f9fafb; border-top:1px solid #e5e7eb;">Use search or filters to find more employees</div>';
      }
    }
    
    function toggleSelectAllEmployees() {
      const selectAllCheckbox = document.getElementById('selectAllEmployees');
      const isChecked = selectAllCheckbox?.checked || false;
      
      // Get visible employee IDs (max 200)
      const visibleIds = filteredEmployeesList.slice(0, 200).map(e => e.id);
      
      if (isChecked) {
        // Select all visible
        visibleIds.forEach(id => selectedEmployeeIds.add(id));
      } else {
        // Deselect all visible
        visibleIds.forEach(id => selectedEmployeeIds.delete(id));
      }
      
      // Update checkboxes in the list
      document.querySelectorAll('#employeeList input[type="checkbox"]').forEach(cb => {
        cb.checked = isChecked;
      });
      
      updateAddButton();
    }

    function filterEmployees() {
      renderEmployeeList();
    }

    function toggleEmployeeSelection(id) {
      if (selectedEmployeeIds.has(id)) selectedEmployeeIds.delete(id);
      else selectedEmployeeIds.add(id);
      updateAddButton();
    }

    function updateAddButton() {
      const btn = document.getElementById('addParticipantsBtn');
      const count = selectedEmployeeIds.size;
      btn.textContent = `Add Selected (${count})`;
      btn.disabled = count === 0;
    }

    async function addSelectedParticipants() {
      if (!editingSessionId) {
        showToast('Please save the session first', 'error');
        return;
      }
      
      if (selectedEmployeeIds.size === 0) {
        showToast('No employees selected', 'error');
        return;
      }
      
      const idsToAdd = Array.from(selectedEmployeeIds);
      const count = idsToAdd.length;
      console.log('Adding participants:', idsToAdd, 'to session:', editingSessionId);
      
      try {
        showLoading('Adding participants...');
        const result = await api('addParticipants', editingSessionId, idsToAdd);
        console.log('addParticipants result:', result);
        
        selectedEmployeeIds.clear();
        updateAddButton();
        
        // Reload participants list
        await loadParticipants(editingSessionId);
        console.log('Current participants after load:', currentParticipants);
        
        // Re-render employee list to remove added employees
        renderEmployeeList();
        
        // Show notification
        showParticipantNotification(' Added ' + count + ' participant(s)', true);
      } catch (e) {
        console.error('addSelectedParticipants error:', e);
        showParticipantNotification('Failed to add participants', false);
      } finally {
        hideLoading();
      }
    }

    function showParticipantNotification(message, isSuccess = true) {
      const notif = document.getElementById('participantNotification');
      const text = document.getElementById('participantNotificationText');
      const icon = notif ? notif.querySelector('i') : null;
      
      if (notif && text) {
        text.textContent = message;
        
        if (isSuccess) {
          notif.style.color = 'var(--success)';
          if (icon) icon.className = 'ri-checkbox-circle-fill';
        } else {
          notif.style.color = 'var(--text-muted)';
          if (icon) icon.className = 'ri-information-line';
        }
        
        // Reset to default message after 3 seconds
        setTimeout(() => {
          text.textContent = 'Changes are saved automatically';
          notif.style.color = 'var(--text-muted)';
          if (icon) icon.className = 'ri-information-line';
        }, 3000);
      }
    }

    function hideParticipantNotification() {
      // No longer needed since footer always shows in participants tab
    }

    function renderParticipantsTable() {
      console.log('=== renderParticipantsTable START ===');
      
      const tbody = document.getElementById('participantsTableBody');
      if (!tbody) {
        console.error('participantsTableBody not found!');
        return;
      }
      
      tbody.innerHTML = '';
      
      const showCost = document.getElementById('sessionIndivDev')?.checked || false;
      const trackQR = window.currentSessionTrackQR || false;
      
      // Get session date for status computation
      const sessionDateStr = document.getElementById('sessionDate')?.value || '';
      const sessionDate = sessionDateStr ? new Date(sessionDateStr) : null;
      
      // Compute date status
      let dateStatus = 'unknown'; // 'future', 'today', 'past'
      if (sessionDate) {
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDay = today.getDate();
        
        const sessYear = sessionDate.getFullYear();
        const sessMonth = sessionDate.getMonth();
        const sessDay = sessionDate.getDate();
        
        if (sessYear === todayYear && sessMonth === todayMonth && sessDay === todayDay) {
          dateStatus = 'today';
        } else if (sessionDate > today) {
          dateStatus = 'future';
        } else {
          dateStatus = 'past';
        }
      }
      
      console.log('currentParticipants:', currentParticipants);
      console.log('currentParticipants length:', currentParticipants ? currentParticipants.length : 0);
      console.log('showCost:', showCost);
      console.log('trackQR:', trackQR);
      console.log('dateStatus:', dateStatus);
      
      // Update count display
      const countEl = document.getElementById('participantCount');
      if (countEl) {
        countEl.textContent = currentParticipants ? currentParticipants.length : 0;
      }
      
      // Toggle cost column visibility
      document.querySelectorAll('#colCurrency, #colCost').forEach(el => {
        if (el) {
          if (showCost) el.classList.remove('hidden');
          else el.classList.add('hidden');
        }
      });
      
      // Handle empty state
      if (!currentParticipants || currentParticipants.length === 0) {
        const colspan = showCost ? 7 : 5;
        tbody.innerHTML = '<tr><td colspan="' + colspan + '" style="text-align:center; color:#888; padding:20px;">No participants yet.</td></tr>';
        console.log('Rendered empty state');
        return;
      }
      
      // Build employee map for function/subFunction lookup
      const empMap = new Map();
      if (employees && employees.length > 0) {
        employees.forEach(e => empMap.set(String(e.id), e));
      }
      console.log('Employee map size:', empMap.size);
      
      // Compute display status based on trackQR setting and date
      function computeDisplayStatus(storedStatus) {
        // If status is explicitly set (Attended, Absent, Cancelled), respect it
        if (storedStatus === 'Attended') return 'Attended';
        if (storedStatus === 'Absent') return 'Absent';
        if (storedStatus === 'Cancelled') return 'Cancelled';
        
        // For "Enrolled" status, compute display based on date and trackQR
        if (trackQR) {
          // QR Tracking ON:
          // - Future: Enrolled
          // - Today: Enrolled (waiting for check-in)
          // - Past: Absent (didn't check in)
          if (dateStatus === 'past') return 'Absent';
          return 'Enrolled';
        } else {
          // QR Tracking OFF:
          // - Future: Enrolled
          // - Today: Enrolled
          // - Past: Attended (assume everyone attended)
          if (dateStatus === 'past') return 'Attended';
          return 'Enrolled';
        }
      }
      
      // Render each participant row
      currentParticipants.forEach((p, idx) => {
        console.log('Rendering participant ' + idx + ':', JSON.stringify(p));
        
        // Get function/subFunction from employee map or from enrollment data
        const empDetails = empMap.get(String(p.employeeId)) || {};
        const funcVal = empDetails.function || p.empFunction || p.function || '-';
        const subVal = empDetails.subFunction || p.subFunction || '-';
        
        // Compute display status
        const storedStatus = p.status || 'Enrolled';
        const displayStatus = computeDisplayStatus(storedStatus);
        
        const tr = document.createElement('tr');
        
        // Build cost cells HTML with datalist for currency suggestions
        let costHtml = '';
        if (showCost) {
          costHtml = '<td style="padding:6px 8px;">' +
            '<input type="text" list="currencyList" class="form-input" style="width:55px; padding:4px; font-size:0.75rem; text-transform:uppercase; text-align:center;" ' +
            'value="' + (p.currency || '') + '" maxlength="3" placeholder="THB" ' +
            'onchange="updateParticipantCost(\'' + (p.enrollmentId || '') + '\', this.value, null)">' +
            '</td>' +
            '<td style="padding:6px 8px;">' +
            '<input type="text" class="form-input" style="width:70px; padding:4px; font-size:0.75rem; text-align:right;" ' +
            'value="' + formatNumber(p.cost) + '" placeholder="0" ' +
            'oninput="formatCostInput(this)" ' +
            'onchange="updateParticipantCost(\'' + (p.enrollmentId || '') + '\', null, this.value)">' +
            '</td>';
        }
        
        tr.innerHTML = 
          '<td style="padding:10px; text-align:center;">' +
            '<input type="checkbox" class="participant-check" value="' + (p.enrollmentId || '') + '" onchange="updateRemoveButton()">' +
          '</td>' +
          '<td style="padding:6px 8px;">' +
            '<div style="font-weight:500;">' + (p.name || 'Unknown') + '</div>' +
            '<div style="font-size:0.7rem; color:#888;">' + (p.employeeId || '') + '</div>' +
          '</td>' +
          '<td style="padding:6px 8px; font-size:0.8rem;">' + funcVal + '</td>' +
          '<td style="padding:6px 8px; font-size:0.8rem;">' + subVal + '</td>' +
          costHtml +
          '<td style="padding:10px; text-align:center;">' +
            '<div class="status-dropdown-container">' +
              '<span class="status-badge status-' + displayStatus + ' clickable" onclick="toggleStatusDropdown(this, \'' + (p.enrollmentId || '') + '\')">' + displayStatus + '</span>' +
              '<div class="status-dropdown" id="statusDropdown_' + (p.enrollmentId || '') + '">' +
                '<div class="status-dropdown-item" onclick="changeParticipantStatus(\'' + (p.enrollmentId || '') + '\', \'Attended\')">' +
                  '<span class="dot attended"></span>Attended' +
                '</div>' +
                '<div class="status-dropdown-item" onclick="changeParticipantStatus(\'' + (p.enrollmentId || '') + '\', \'Enrolled\')">' +
                  '<span class="dot enrolled"></span>Enrolled' +
                '</div>' +
                '<div class="status-dropdown-item" onclick="changeParticipantStatus(\'' + (p.enrollmentId || '') + '\', \'Absent\')">' +
                  '<span class="dot absent"></span>Absent' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</td>';
        
        tbody.appendChild(tr);
      });
      
      console.log('Rendered', currentParticipants.length, 'rows');
      console.log('=== renderParticipantsTable END ===');
    }
    
    // Status dropdown functions
    let activeStatusDropdown = null;
    
    function toggleStatusDropdown(badge, enrollmentId) {
      event.stopPropagation();
      
      const dropdown = document.getElementById('statusDropdown_' + enrollmentId);
      if (!dropdown) return;
      
      // Close any other open dropdown
      if (activeStatusDropdown && activeStatusDropdown !== dropdown) {
        activeStatusDropdown.classList.remove('show');
      }
      
      // Toggle current dropdown
      dropdown.classList.toggle('show');
      activeStatusDropdown = dropdown.classList.contains('show') ? dropdown : null;
    }
    
    async function changeParticipantStatus(enrollmentId, newStatus) {
      event.stopPropagation();
      
      // Close dropdown
      const dropdown = document.getElementById('statusDropdown_' + enrollmentId);
      if (dropdown) dropdown.classList.remove('show');
      activeStatusDropdown = null;
      
      // Find participant and update locally
      const participant = currentParticipants.find(p => p.enrollmentId === enrollmentId);
      if (participant) {
        participant.status = newStatus;
      }
      
      // Re-render table immediately for instant feedback
      renderParticipantsTable();
      
      // Update in backend
      try {
        await api('updateEnrollmentStatus', enrollmentId, newStatus);
      } catch (e) {
        console.error('Failed to update status:', e);
        showToast('Failed to update status', 'error');
      }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (activeStatusDropdown && !e.target.closest('.status-dropdown-container')) {
        activeStatusDropdown.classList.remove('show');
        activeStatusDropdown = null;
      }
    });

    function toggleSelectAllParticipants() {
      const selectAll = document.getElementById('selectAllParticipants');
      const isChecked = selectAll ? selectAll.checked : false;
      document.querySelectorAll('.participant-check').forEach(cb => cb.checked = isChecked);
      updateRemoveButton();
    }

    function updateRemoveButton() {
      const checked = document.querySelectorAll('.participant-check:checked');
      const btn = document.getElementById('removeSelectedBtn');
      if (btn) {
        btn.disabled = checked.length === 0;
        btn.textContent = checked.length > 0 ? 'Remove (' + checked.length + ')' : 'Remove';
      }
    }

    async function removeSelectedParticipants() {
      const ids = Array.from(document.querySelectorAll('.participant-check:checked')).map(cb => cb.value);
      if (!ids.length) return;
      if (!confirm(`Remove ${ids.length} participant(s)?`)) return;
      
      try {
        showLoading('Removing participants...');
        await api('removeParticipants', ids);
        await loadParticipants(editingSessionId);
        renderEmployeeList();
        showParticipantNotification(' ' + ids.length + ' participant(s) removed', true);
      } catch (e) {
        showParticipantNotification('Failed to remove', false);
      } finally {
        hideLoading();
      }
    }

    // Download QR codes for selected participants
    async function downloadParticipantsQR() {
      const checkedBoxes = document.querySelectorAll('.participant-check:checked');
      if (checkedBoxes.length === 0) {
        showToast('Please select participants first', 'error');
        return;
      }
      
      // Get employee IDs from checked participants
      const employeeIds = [];
      checkedBoxes.forEach(cb => {
        const enrollmentId = cb.value;
        const participant = currentParticipants.find(p => p.enrollmentId === enrollmentId);
        if (participant && participant.employeeId) {
          employeeIds.push(participant.employeeId);
        }
      });
      
      if (employeeIds.length === 0) {
        showToast('No valid participants selected', 'error');
        return;
      }
      
      showLoading(`Generating ${employeeIds.length} QR code(s)...`);
      
      try {
        // Get QR data for these employees
        const qrData = await api('getQRCardData', {});
        
        for (const empId of employeeIds) {
          const emp = qrData.find(e => e.id === empId);
          if (emp && emp.qrString) {
            await downloadQRCardImage(emp);
            await new Promise(r => setTimeout(r, 400));
          }
        }
        
        hideLoading();
        showToast(`Downloaded ${employeeIds.length} QR code(s)`, 'success');
      } catch (e) {
        hideLoading();
        showToast('Failed to download QR codes: ' + e.message, 'error');
      }
    }

    // Email QR codes to selected participants
    async function emailParticipantsQR() {
      const checkedBoxes = document.querySelectorAll('.participant-check:checked');
      if (checkedBoxes.length === 0) {
        showToast('Please select participants first', 'error');
        return;
      }
      
      // Get employee IDs from checked participants
      const employeeIds = [];
      checkedBoxes.forEach(cb => {
        const enrollmentId = cb.value;
        const participant = currentParticipants.find(p => p.enrollmentId === enrollmentId);
        if (participant && participant.employeeId) {
          employeeIds.push(participant.employeeId);
        }
      });
      
      if (employeeIds.length === 0) {
        showToast('No valid participants selected', 'error');
        return;
      }
      
      showLoading(`Sending ${employeeIds.length} email(s)...`);
      
      try {
        const result = await api('emailQRCardsBulk', employeeIds, { includeUpcomingTrainings: true });
        hideLoading();
        
        if (result.sent > 0) {
          showToast(`Successfully sent ${result.sent} email(s)`, 'success');
        }
        if (result.failed > 0) {
          showToast(`Failed to send ${result.failed} email(s)`, 'error');
        }
      } catch (e) {
        hideLoading();
        showToast('Failed to send emails: ' + e.message, 'error');
      }
    }

    async function removeSingleParticipant(enrollmentId) {
      if (!confirm('Remove this participant?')) return;
      
      try {
        showLoading('Removing participant...');
        await api('removeParticipants', [enrollmentId]);
        await loadParticipants(editingSessionId);
        renderEmployeeList();
        showParticipantNotification(' Participant removed', true);
      } catch (e) {
        showParticipantNotification('Failed to remove', false);
      } finally {
        hideLoading();
      }
    }

    async function updateParticipantCost(enrollmentId, currency, cost) {
      const p = currentParticipants.find(x => x.enrollmentId === enrollmentId);
      if (!p) return;
      
      if (currency !== null) p.currency = currency;
      if (cost !== null) p.cost = cost.replace(/,/g, '');
      
      try {
        await api('updateParticipantCost', enrollmentId, p.currency || '', p.cost || '');
        showParticipantNotification(' Cost saved', true);
      } catch (e) {
        showParticipantNotification('Failed to save', false);
      }
    }

    // Manual Add
    async function toggleManualAdd() {
      const form = document.getElementById('manualAddForm');
      const isHidden = form.classList.contains('hidden');
      form.classList.toggle('hidden');
      
      // Populate dropdowns when showing form
      if (isHidden) {
        await ensureEmployeesLoaded();
        
        // Get unique values from employees
        const entities = [...new Set(employees.map(e => e.entity).filter(Boolean))].sort();
        const functions = [...new Set(employees.map(e => e.function).filter(Boolean))].sort();
        const subFunctions = [...new Set(employees.map(e => e.subFunction).filter(Boolean))].sort();
        
        const entitySelect = document.getElementById('manualEntity');
        const funcSelect = document.getElementById('manualFunction');
        const subFuncSelect = document.getElementById('manualSubFunction');
        
        entitySelect.innerHTML = '<option value="">Select Entity...</option>' + entities.map(e => `<option value="${e}">${e}</option>`).join('');
        funcSelect.innerHTML = '<option value="">Select Function...</option>' + functions.map(f => `<option value="${f}">${f}</option>`).join('');
        subFuncSelect.innerHTML = '<option value="">Select Sub-Function...</option>' + subFunctions.map(s => `<option value="${s}">${s}</option>`).join('');
      }
    }

    async function saveManualParticipant() {
      const entity = document.getElementById('manualEntity').value;
      const id = document.getElementById('manualId').value.trim();
      const name = document.getElementById('manualName').value.trim();
      const email = document.getElementById('manualEmail').value.trim();
      const func = document.getElementById('manualFunction').value;
      const subFunc = document.getElementById('manualSubFunction').value;
      
      if (!id || !name || !email) {
        showToast('ID, Name, and Email are required', 'error');
        return;
      }
      
      if (!editingSessionId) {
        showToast('Please save the session first', 'error');
        return;
      }
      
      try {
        showLoading('Adding participant...');
        await api('addManualParticipant', editingSessionId, { id, name, email, entity, function: func, subFunction: subFunc });
        
        // Reset form
        document.getElementById('manualEntity').value = '';
        document.getElementById('manualId').value = '';
        document.getElementById('manualName').value = '';
        document.getElementById('manualEmail').value = '';
        document.getElementById('manualFunction').value = '';
        document.getElementById('manualSubFunction').value = '';
        toggleManualAdd();
        
        await loadParticipants(editingSessionId);
        showToast('Participant added!', 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    // Mass Upload
    function openUploadModal() {
      if (!editingSessionId) {
        showToast('Please save the session first', 'error');
        return;
      }
      document.getElementById('uploadModal').classList.add('active');
      document.getElementById('uploadFile').value = '';
      document.getElementById('uploadPreview').classList.add('hidden');
      document.getElementById('previewUploadBtn').disabled = true;
      uploadValidIds = [];
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
    }

    // Setup file input listener
    setTimeout(() => {
      const uploadFile = document.getElementById('uploadFile');
      if (uploadFile) {
        uploadFile.addEventListener('change', function() {
          document.getElementById('previewUploadBtn').disabled = !this.files.length;
        });
      }
    }, 100);

    async function downloadUploadTemplate() {
      const prog = programs.find(p => p.id === currentProgramId);
      const sess = sessions.find(s => s.sessionId === editingSessionId);
      
      try {
        const result = await api('createUploadTemplate', 
          currentProgramId || '', 
          prog?.name || '', 
          editingSessionId || '', 
          sess?.name || ''
        );
        if (result.success && result.base64) {
          // Download using base64
          const link = document.createElement('a');
          link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + result.base64;
          link.download = result.filename || 'Upload_Template.xlsx';
          link.click();
          showToast('Template downloaded!', 'success');
        } else {
          showToast('Error: ' + (result.message || 'Unknown error'), 'error');
        }
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      }
    }

    async function previewUpload() {
      const file = document.getElementById('uploadFile').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64 = e.target.result.split(',')[1];
        
        try {
          showLoading('Validating...');
          const result = await api('previewMassUpload', base64, file.name);
          
          const preview = document.getElementById('uploadPreview');
          const tbody = document.getElementById('uploadPreviewBody');
          const summary = document.getElementById('uploadSummary');
          const confirmBtn = document.getElementById('confirmUploadBtn');
          
          uploadValidIds = [];
          let validCount = 0;
          let errorCount = 0;
          
          tbody.innerHTML = (result.results || []).map(r => {
            if (r.isValid) {
              validCount++;
              uploadValidIds.push(r.employeeId);
              return `<tr style="background:#f6ffed;"><td style="color:var(--success); font-weight:600;"> Ready</td><td>${r.input}</td><td>${r.name}</td></tr>`;
            } else {
              errorCount++;
              return `<tr style="background:#fff5f5;"><td style="color:var(--danger); font-weight:600;"> Error</td><td>${r.input}</td><td style="color:var(--text-muted);">Not Found</td></tr>`;
            }
          }).join('');
          
          summary.innerHTML = `Found <strong>${validCount}</strong> valid. <span style="color:${errorCount > 0 ? 'var(--danger)' : 'var(--text-muted)'}">${errorCount} errors</span>.`;
          confirmBtn.disabled = validCount === 0;
          confirmBtn.textContent = `Confirm & Add (${validCount})`;
          
          preview.classList.remove('hidden');
        } catch (e) {
          showToast('Error: ' + (e.message || e), 'error');
        } finally {
          hideLoading();
        }
      };
      reader.readAsDataURL(file);
    }

    async function confirmUpload() {
      if (!uploadValidIds.length || !editingSessionId) return;
      
      try {
        showLoading('Adding participants...');
        await api('addParticipants', editingSessionId, uploadValidIds);
        closeUploadModal();
        await loadParticipants(editingSessionId);
        renderEmployeeList();
        showToast(`Added ${uploadValidIds.length} participants!`, 'success');
      } catch (e) {
        showToast('Error: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    // Export
    function openExportModal(mode) {
      document.getElementById('exportModal').classList.add('active');
      document.querySelector(`input[name="exportType"][value="${mode}"]`).checked = true;
      
      const yearSelect = document.getElementById('exportYear');
      const curYear = new Date().getFullYear();
      yearSelect.innerHTML = '<option value="All">All History</option>';
      for (let y = curYear - 2; y <= curYear + 1; y++) {
        yearSelect.innerHTML += `<option value="${y}" ${y === curYear ? 'selected' : ''}>${y}</option>`;
      }
      
      // Load entities for dropdown
      loadExportEntities();
      
      // Load programs for session mode
      loadProgramsForSessionExport();
      
      toggleExportFilter();
      document.getElementById('exportStatus').textContent = '';
    }
    
    async function loadExportEntities() {
      try {
        const entities = await api('getEntitiesForExport') || [];
        const entitySelect = document.getElementById('exportEntity');
        entitySelect.innerHTML = '<option value="All">All Entities</option>';
        entities.forEach(e => {
          entitySelect.innerHTML += `<option value="${e}">${e}</option>`;
        });
      } catch (e) {
        console.error('loadExportEntities error:', e);
      }
    }
    
    async function loadProgramsForSessionExport() {
      try {
        const progs = await api('getProgramsForExport') || [];
        const programSelect = document.getElementById('exportSessionProgram');
        programSelect.innerHTML = '<option value="">-- Select Program --</option>';
        progs.forEach(p => {
          programSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
      } catch (e) {
        console.error('loadProgramsForSessionExport error:', e);
      }
    }
    
    async function loadSessionsForExport() {
      const programId = document.getElementById('exportSessionProgram').value;
      const sessionSelect = document.getElementById('exportSessionSelect');
      
      if (!programId) {
        sessionSelect.innerHTML = '<option value="">-- Select Program First --</option>';
        sessionSelect.disabled = true;
        return;
      }
      
      try {
        sessionSelect.innerHTML = '<option value="">Loading...</option>';
        sessionSelect.disabled = true;
        
        const sessions = await api('getSessionsForExport', programId) || [];
        
        if (sessions.length === 0) {
          sessionSelect.innerHTML = '<option value="">No sessions found</option>';
        } else {
          sessionSelect.innerHTML = '<option value="">-- Select Session --</option>';
          sessions.forEach(s => {
            sessionSelect.innerHTML += `<option value="${s.sessionId}">${s.date} - ${s.name}</option>`;
          });
          sessionSelect.disabled = false;
        }
      } catch (e) {
        console.error('loadSessionsForExport error:', e);
        sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
      }
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('active');
    }

    async function toggleExportFilter() {
      const mode = document.querySelector('input[name="exportType"]:checked').value;
      const label = document.getElementById('exportFilterLabel');
      const input = document.getElementById('exportFilter');
      const datalist = document.getElementById('exportFilterList');
      const entityGroup = document.getElementById('exportEntityGroup');
      const programEmployeeFields = document.getElementById('exportProgramEmployeeFields');
      const sessionFields = document.getElementById('exportSessionFields');
      
      input.value = '';
      
      // Toggle visibility based on mode
      if (mode === 'session') {
        programEmployeeFields.style.display = 'none';
        sessionFields.style.display = 'block';
        // Reset session dropdown
        document.getElementById('exportSessionSelect').innerHTML = '<option value="">-- Select Program First --</option>';
        document.getElementById('exportSessionSelect').disabled = true;
      } else {
        programEmployeeFields.style.display = 'block';
        sessionFields.style.display = 'none';
        
        // Show entity dropdown only for program mode
        entityGroup.style.display = mode === 'program' ? 'block' : 'none';
        
        try {
          if (mode === 'program') {
            label.textContent = 'Filter by Program (Optional)';
            input.placeholder = 'Type to search program...';
            const progs = await api('getProgramsForExport') || [];
            datalist.innerHTML = progs.map(p => `<option value="${p.id} - ${p.name}">`).join('');
          } else {
            label.textContent = 'Select Employee (Required)';
            input.placeholder = 'Type to search employee...';
            const emps = await api('getEmployeesForExport') || [];
            datalist.innerHTML = emps.map(e => `<option value="${e.id} - ${e.name}">`).join('');
          }
        } catch (e) {
          console.error('toggleExportFilter error:', e);
        }
      }
    }

    async function downloadCalendarPDF() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const monthName = monthNames[currentMonth.getMonth()];
      
      showLoading('Generating PDF...');
      
      try {
        const result = await api('generateCalendarPDF', year, month);
        
        if (result.success) {
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = `Training_Calendar_${monthName}_${year}.pdf`;
          link.click();
          showToast('Calendar PDF downloaded!', 'success');
        } else {
          showToast('Error: ' + result.message, 'error');
        }
      } catch (e) {
        showToast('Error generating PDF: ' + (e.message || e), 'error');
      } finally {
        hideLoading();
      }
    }

    async function generatePDF() {
      const mode = document.querySelector('input[name="exportType"]:checked').value;
      const status = document.getElementById('exportStatus');
      const btn = document.getElementById('generatePdfBtn');
      
      // Handle session mode separately
      if (mode === 'session') {
        const sessionId = document.getElementById('exportSessionSelect').value;
        if (!sessionId) {
          status.textContent = 'Please select a session.';
          status.style.color = 'var(--danger)';
          return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Generating...';
        status.textContent = 'Processing...';
        status.style.color = 'var(--text-muted)';
        
        try {
          const result = await api('generateSessionPDF', sessionId);
          
          if (result.success) {
            status.textContent = 'Download started!';
            status.style.color = 'var(--success)';
            
            const link = document.createElement('a');
            link.href = 'data:application/pdf;base64,' + result.base64;
            link.download = result.filename;
            link.click();
          } else {
            status.textContent = 'Error: ' + result.message;
            status.style.color = 'var(--danger)';
          }
        } catch (e) {
          status.textContent = 'Error: ' + (e.message || e);
          status.style.color = 'var(--danger)';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Generate PDF';
        }
        return;
      }
      
      // Program/Employee mode
      const year = document.getElementById('exportYear').value;
      const filter = document.getElementById('exportFilter').value;
      const entityFilter = mode === 'program' ? document.getElementById('exportEntity').value : null;
      
      if (mode === 'employee' && !filter) {
        status.textContent = 'Please select an employee.';
        status.style.color = 'var(--danger)';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Generating...';
      status.textContent = 'Processing...';
      status.style.color = 'var(--text-muted)';
      
      try {
        const result = await api('generatePDF', year, filter, mode, entityFilter);
        
        if (result.success) {
          status.textContent = 'Download started!';
          status.style.color = 'var(--success)';
          
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = result.filename;
          link.click();
        } else {
          status.textContent = 'Error: ' + result.message;
          status.style.color = 'var(--danger)';
        }
      } catch (e) {
        status.textContent = 'Error: ' + (e.message || e);
        status.style.color = 'var(--danger)';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate PDF';
      }
    }

    function exportCSV(type) {
      let csv, filename;
      
      if (type === 'sessions') {
        csv = 'Session ID,Program,Name,Date,Status,Type,Provider,Location,Duration,Score\n';
        csv += sessions.map(s => {
          const prog = programs.find(p => p.id === s.programId);
          return [s.sessionId, prog?.name || '', s.name, s.date, s.status, s.type, s.provider, s.location, s.duration, s.score]
            .map(v => `"${(v || '').toString().replace(/"/g, '""')}"`)
            .join(',');
        }).join('\n');
        filename = 'sessions_export.csv';
      } else {
        csv = 'Enrollment ID,Session ID,Employee ID,Name,Email,Function,Status,Currency,Cost\n';
        csv += enrollments.map(e => {
          return [e.enrollmentId, e.sessionId, e.employeeId, e.name, e.email, e.function, e.status, e.currency, e.cost]
            .map(v => `"${(v || '').toString().replace(/"/g, '""')}"`)
            .join(',');
        }).join('\n');
        filename = 'enrollments_export.csv';
      }
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      
      showToast('Downloaded ' + filename, 'success');
    }

    // =====================
    // SURVEY RESULT REPORT
    // =====================
    let surveyReportSessions = [];
    let surveyReportData = [];
    
    function openSurveyResultModal() {
      document.getElementById('surveyResultModal').classList.add('active');
      document.getElementById('surveyReportProgramSearch').value = '';
      document.getElementById('surveyReportProgram').value = '';
      document.getElementById('surveyReportDate').value = '';
      document.getElementById('surveyReportSessionSearch').value = '';
      document.getElementById('surveyReportSession').value = '';
      document.getElementById('surveyReportFormType').value = '';
      document.getElementById('surveyReportResults').innerHTML = `
        <div style="text-align:center; color:var(--text-muted); padding:3rem;">
          <i class="ri-pie-chart-line" style="font-size:3rem; display:block; margin-bottom:1rem; opacity:0.5;"></i>
          <p>Select filters and click "Generate Report" to view survey responses</p>
        </div>`;
      document.getElementById('exportSurveyPdfBtn').disabled = true;
      surveyReportData = [];
      loadSurveyReportSessions();
    }
    
    function closeSurveyResultModal() {
      document.getElementById('surveyResultModal').classList.remove('active');
    }
    
    async function loadSurveyReportSessions() {
      try {
        surveyReportSessions = sessions || [];
      } catch (e) {
        console.error('loadSurveyReportSessions error:', e);
      }
    }
    
    function filterSurveyReportPrograms() {
      const search = document.getElementById('surveyReportProgramSearch').value.toLowerCase();
      const dropdown = document.getElementById('surveyReportProgramDropdown');
      
      const filtered = programs.filter(p => 
        p.name.toLowerCase().includes(search) || p.id.toLowerCase().includes(search)
      ).slice(0, 20);
      
      dropdown.innerHTML = filtered.map(p => `
        <div style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; display:flex; justify-content:space-between;" 
             onclick="selectSurveyReportProgram('${p.id}', '${p.name.replace(/'/g, "\\'")}')">
          <span>${p.name}</span>
          <span style="color:#9ca3af; font-size:0.75rem;">${p.id}</span>
        </div>
      `).join('');
      
      dropdown.style.display = filtered.length > 0 ? 'block' : 'none';
    }
    
    function showSurveyReportProgramDropdown() {
      filterSurveyReportPrograms();
    }
    
    function selectSurveyReportProgram(id, name) {
      document.getElementById('surveyReportProgramSearch').value = name;
      document.getElementById('surveyReportProgram').value = id;
      document.getElementById('surveyReportProgramDropdown').style.display = 'none';
      filterSurveyReportSessions();
    }
    
    function filterSurveyReportSessions() {
      // Clear session selection when filters change
      document.getElementById('surveyReportSessionSearch').value = '';
      document.getElementById('surveyReportSession').value = '';
    }
    
    function filterSurveyReportSessionList() {
      const search = document.getElementById('surveyReportSessionSearch').value.toLowerCase();
      const programId = document.getElementById('surveyReportProgram').value;
      const dateFilter = document.getElementById('surveyReportDate').value;
      const dropdown = document.getElementById('surveyReportSessionDropdown');
      
      let filtered = surveyReportSessions;
      
      // Filter by program
      if (programId) {
        filtered = filtered.filter(s => s.programId === programId);
      }
      
      // Filter by date
      if (dateFilter) {
        filtered = filtered.filter(s => s.date === dateFilter);
      }
      
      // Filter by search text
      if (search) {
        filtered = filtered.filter(s => 
          (s.name || '').toLowerCase().includes(search) || 
          (s.sessionId || '').toLowerCase().includes(search)
        );
      }
      
      filtered = filtered.slice(0, 20);
      
      dropdown.innerHTML = filtered.map(s => {
        const prog = programs.find(p => p.id === s.programId);
        return `
          <div style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;" 
               onclick="selectSurveyReportSession('${s.sessionId}', '${(s.name || '').replace(/'/g, "\\'")}')">
            <div style="font-weight:500;">${s.name || s.sessionId}</div>
            <div style="font-size:0.75rem; color:#6b7280;">${prog?.name || ''}  ${s.date || ''}</div>
          </div>
        `;
      }).join('');
      
      if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding:10px 12px; color:#9ca3af; text-align:center;">No sessions found</div>';
      }
      
      dropdown.style.display = 'block';
    }
    
    function showSurveyReportSessionDropdown() {
      filterSurveyReportSessionList();
    }
    
    function selectSurveyReportSession(id, name) {
      document.getElementById('surveyReportSessionSearch').value = name || id;
      document.getElementById('surveyReportSession').value = id;
      document.getElementById('surveyReportSessionDropdown').style.display = 'none';
    }
    
    async function generateSurveyReport() {
      const programId = document.getElementById('surveyReportProgram').value;
      const sessionId = document.getElementById('surveyReportSession').value;
      const dateFilter = document.getElementById('surveyReportDate').value;
      const formType = document.getElementById('surveyReportFormType').value;
      const resultsContainer = document.getElementById('surveyReportResults');
      
      resultsContainer.innerHTML = '<div style="text-align:center; padding:3rem;"><i class="ri-loader-4-line" style="animation:spin 1s linear infinite; font-size:2rem;"></i><p style="margin-top:1rem;">Loading responses...</p></div>';
      
      try {
        // Build filters object
        const filters = {
          programId: programId || null,
          sessionId: sessionId || null,
          date: dateFilter || null,
          formType: formType || null
        };
        
        const result = await api('getSurveyReportData', filters);
        
        if (!result || !result.success) {
          resultsContainer.innerHTML = `<div style="text-align:center; color:var(--danger); padding:3rem;"><i class="ri-error-warning-line" style="font-size:2rem;"></i><p>${result?.message || 'Failed to load data'}</p></div>`;
          return;
        }
        
        surveyReportData = result.responses || [];
        
        if (surveyReportData.length === 0) {
          resultsContainer.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:3rem;"><i class="ri-inbox-line" style="font-size:3rem; display:block; margin-bottom:1rem;"></i><p>No responses found for the selected filters</p></div>`;
          document.getElementById('exportSurveyPdfBtn').disabled = true;
          return;
        }
        
        // Enable export button
        document.getElementById('exportSurveyPdfBtn').disabled = false;
        
        // Build results HTML
        let html = `<div style="padding:1rem; background:white; border-bottom:1px solid var(--border);">
          <div style="font-weight:600; font-size:1.1rem;">${surveyReportData.length} Response${surveyReportData.length !== 1 ? 's' : ''}</div>
          <div style="font-size:0.8rem; color:var(--text-muted);">${sessionId ? 'Session: ' + sessionId : 'All Sessions'}${formType ? '  Type: ' + formType : ''}</div>
        </div>`;
        
        // Table view
        html += `<div style="overflow-x:auto; padding:1rem;">
          <table style="width:100%; border-collapse:collapse; font-size:0.8rem;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Timestamp</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Session</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Type</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Email</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid var(--border);">Q1 Score</th>
              </tr>
            </thead>
            <tbody>`;
        
        surveyReportData.forEach((r, idx) => {
          const ts = r.timestamp ? new Date(r.timestamp).toLocaleString() : '-';
          const typeLabel = r.formType === 'feedback' ? 'Feedback' : (r.formType === 'survey' ? 'Survey' : (r.formType === 'assessment' ? 'Assessment' : r.formType));
          const typeBg = r.formType === 'feedback' ? '#fef3c7' : (r.formType === 'survey' ? '#dbeafe' : '#fce7f3');
          const typeColor = r.formType === 'feedback' ? '#92400e' : (r.formType === 'survey' ? '#1e40af' : '#9d174d');
          
          html += `
            <tr style="border-bottom:1px solid #f3f4f6;${idx % 2 === 1 ? ' background:#fafafa;' : ''}">
              <td style="padding:10px;">${ts}</td>
              <td style="padding:10px;">${r.sessionId}</td>
              <td style="padding:10px;"><span style="padding:2px 8px; border-radius:10px; font-size:0.7rem; background:${typeBg}; color:${typeColor};">${typeLabel}</span></td>
              <td style="padding:10px;">${r.email || '-'}</td>
              <td style="padding:10px;">${r.q1 || '-'}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        resultsContainer.innerHTML = html;
        
      } catch (e) {
        console.error('generateSurveyReport error:', e);
        resultsContainer.innerHTML = `<div style="text-align:center; color:var(--danger); padding:3rem;"><i class="ri-error-warning-line" style="font-size:2rem;"></i><p>Error: ${e.message}</p></div>`;
      }
    }
    
    async function exportSurveyResultPDF() {
      if (surveyReportData.length === 0) {
        showToast('No data to export', 'error');
        return;
      }
      
      showLoading('Generating PDF...');
      
      try {
        const sessionId = document.getElementById('surveyReportSession').value;
        const formType = document.getElementById('surveyReportFormType').value;
        
        const result = await api('exportSurveyResultPDF', surveyReportData, sessionId, formType);
        
        if (result && result.success) {
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = result.filename || 'survey_report.pdf';
          link.click();
          showToast('PDF downloaded!', 'success');
        } else {
          showToast(result?.message || 'Failed to generate PDF', 'error');
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      const surveyProgramDropdown = document.getElementById('surveyReportProgramDropdown');
      const surveySessionDropdown = document.getElementById('surveyReportSessionDropdown');
      
      if (surveyProgramDropdown && !e.target.closest('#surveyReportProgramSearch') && !e.target.closest('#surveyReportProgramDropdown')) {
        surveyProgramDropdown.style.display = 'none';
      }
      if (surveySessionDropdown && !e.target.closest('#surveyReportSessionSearch') && !e.target.closest('#surveyReportSessionDropdown')) {
        surveySessionDropdown.style.display = 'none';
      }
    });

    // Logout
    function handleLogout() {
      if (!confirm('Are you sure you want to logout?')) return;
      
      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler(url => {
            window.top.location.href = url;
          }).getScriptUrl();
        })
        .logout(sessionToken);
    }

    // Utilities
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function hhmmToMinutes(str) {
      if (!str) return 60;
      const parts = str.split(':');
      return (parseInt(parts[0]) || 0) * 60 + (parseInt(parts[1]) || 0);
    }

    function minutesToHHMM(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}:${String(m).padStart(2, '0')}`;
    }

    function hhmmToDecimal(str) {
      return (hhmmToMinutes(str) / 60).toFixed(2);
    }

    function decimalToHHMM(dec) {
      return minutesToHHMM(Math.round((parseFloat(dec) || 1) * 60));
    }

    function formatNumber(n) {
      if (!n) return '';
      return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    // Debounce utility for search inputs
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function formatCostInput(input) {
      let val = input.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
      input.value = formatNumber(val);
    }

    function showToast(msg, type) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `<i class="ri-${type === 'success' ? 'check' : 'error-warning'}-line"></i><span>${msg}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ============================================
    // PROGRESS BAR FOR BULK OPERATIONS
    // ============================================
    
    function showProgressModal(title, total) {
      document.getElementById('progressTitle').textContent = title;
      document.getElementById('progressTotal').textContent = total;
      document.getElementById('progressCurrent').textContent = '0';
      document.getElementById('progressBarFill').style.width = '0%';
      document.getElementById('progressStatusText').textContent = 'Initializing...';
      document.getElementById('progressModalContainer').style.display = 'block';
    }
    
    function updateProgress(current, total, statusText) {
      document.getElementById('progressCurrent').textContent = current;
      document.getElementById('progressTotal').textContent = total;
      const percentage = total > 0 ? (current / total * 100) : 0;
      document.getElementById('progressBarFill').style.width = percentage + '%';
      if (statusText) {
        document.getElementById('progressStatusText').textContent = statusText;
      }
    }
    
    function hideProgressModal() {
      document.getElementById('progressModalContainer').style.display = 'none';
    }

    // ============================================
    // SKELETON LOADING
    // ============================================
    
    function showSessionsSkeleton() {
      const tbody = document.getElementById('sessionsTableBody');
      let skeletonRows = '';
      for (let i = 0; i < 8; i++) {
        skeletonRows += `
          <tr>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${120 + Math.random()*60}px; height:14px; margin-bottom:4px;"></div><div class="skeleton" style="width:80px; height:10px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${100 + Math.random()*40}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${60 + Math.random()*30}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${70 + Math.random()*20}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:80px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem; text-align:center;"><div class="skeleton" style="width:30px; height:14px; margin:0 auto;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:70px; height:22px; border-radius:4px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:60px; height:28px; margin:0 auto;"></div></td>
          </tr>`;
      }
      tbody.innerHTML = skeletonRows;
    }
    
    function showParticipantsSkeleton() {
      const tbody = document.getElementById('participantsPageTableBody');
      let skeletonRows = '';
      for (let i = 0; i < 8; i++) {
        skeletonRows += `
          <tr>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${100 + Math.random()*50}px; height:14px; margin-bottom:4px;"></div><div class="skeleton" style="width:60px; height:10px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${60 + Math.random()*30}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:40px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${70 + Math.random()*30}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${60 + Math.random()*30}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem;"><div class="skeleton" style="width:${120 + Math.random()*40}px; height:14px;"></div></td>
            <td style="padding:0.75rem 1rem; text-align:center;"><div class="skeleton" style="width:30px; height:14px; margin:0 auto;"></div></td>
            <td style="padding:0.75rem 1rem; text-align:center;"><div class="skeleton" style="width:40px; height:14px; margin:0 auto;"></div></td>
            <td style="padding:0.75rem 1rem; text-align:center;"><div class="skeleton" style="width:32px; height:28px; margin:0 auto;"></div></td>
          </tr>`;
      }
      tbody.innerHTML = skeletonRows;
    }

    // ============================================
    // ANALYTICS CACHING
    // ============================================
    
    function getCacheKey() {
      const year = document.getElementById('analyticsYear')?.value || '';
      const period = document.getElementById('analyticsPeriod')?.value || '';
      const entity = document.getElementById('analyticsEntity')?.value || '';
      const periodType = document.querySelector('.period-toggle-btn.active')?.dataset?.period || 'monthly';
      return `${year}-${period}-${entity}-${periodType}`;
    }
    
    function isCacheValid() {
      if (!analyticsCache.data || !analyticsCache.timestamp) return false;
      const now = Date.now();
      const cacheAge = now - analyticsCache.timestamp;
      const currentKey = getCacheKey();
      return cacheAge < analyticsCache.CACHE_DURATION && analyticsCache.filters === currentKey;
    }
    
    function updateCacheIndicator() {
      const indicator = document.getElementById('analyticsCacheIndicator');
      const timeSpan = document.getElementById('analyticsCacheTime');
      
      if (analyticsCache.timestamp && isCacheValid()) {
        const ageSeconds = Math.floor((Date.now() - analyticsCache.timestamp) / 1000);
        let timeText;
        if (ageSeconds < 60) {
          timeText = 'Updated just now';
        } else if (ageSeconds < 120) {
          timeText = 'Updated 1 min ago';
        } else {
          timeText = `Updated ${Math.floor(ageSeconds / 60)} mins ago`;
        }
        timeSpan.textContent = timeText;
        indicator.style.display = 'flex';
      } else {
        indicator.style.display = 'none';
      }
    }
    
    async function refreshAnalyticsData() {
      // Clear cache and reload
      analyticsCache.data = null;
      analyticsCache.timestamp = null;
      analyticsCache.filters = null;
      document.getElementById('analyticsCacheIndicator').style.display = 'none';
      await loadAnalyticsData();
      showToast('Analytics data refreshed', 'success');
    }

    // ============================================
    // SURVEY FORM FUNCTIONS
    // ============================================
    
    let currentSessionFormUrls = {
      feedback: null,
      survey: null,
      assessment: null
    };
    
    let currentSessionFormEditUrls = {
      feedback: null,
      survey: null,
      assessment: null
    };
    
    async function loadSurveyData() {
      if (!editingSessionId) return;
      
      try {
        const result = await api('getSessionForms', editingSessionId);
        if (result && result.success) {
          currentSessionFormUrls = {
            feedback: result.feedbackUrl || null,
            survey: result.surveyUrl || null,
            assessment: result.assessmentUrl || null
          };
          
          currentSessionFormEditUrls = {
            feedback: result.feedbackEditUrl || null,
            survey: result.surveyEditUrl || null,
            assessment: result.assessmentEditUrl || null
          };
          
          // Update UI for each form type
          updateFormCard('feedback', result.feedbackUrl, result.feedbackResponses || 0, result.avgScore);
          updateFormCard('survey', result.surveyUrl, result.surveyResponses || 0);
          updateFormCard('assessment', result.assessmentUrl, result.assessmentResponses || 0);
          
          // Sync avg score to Session Details if available from feedback
          if (result.avgScore !== undefined && result.avgScore !== null && result.feedbackResponses > 0) {
            const sessionScoreInput = document.getElementById('sessionScore');
            if (sessionScoreInput) {
              sessionScoreInput.value = result.avgScore.toFixed(1);
              updateScoreBar();
            }
          }
        }
      } catch (e) {
        console.error('Error loading survey data:', e);
      }
    }
    
    async function refreshSurveyData() {
      showLoading('Refreshing survey data...');
      await loadSurveyData();
      hideLoading();
      showToast('Survey data refreshed', 'success');
    }
    
    function updateFormCard(formType, url, responseCount, avgScore) {
      const notLinked = document.getElementById(`${formType}NotLinked`);
      const linked = document.getElementById(`${formType}Linked`);
      const responseCountEl = document.getElementById(`${formType}ResponseCount`);
      const scoreEl = document.getElementById(`${formType}Score`);
      
      if (url) {
        if (notLinked) notLinked.style.display = 'none';
        if (linked) linked.style.display = 'block';
        if (responseCountEl) responseCountEl.textContent = `${responseCount} response${responseCount !== 1 ? 's' : ''}`;
        
        // Show avg score for feedback forms
        if (formType === 'feedback' && scoreEl) {
          if (responseCount > 0 && avgScore !== undefined && avgScore !== null) {
            scoreEl.style.display = 'block';
            scoreEl.querySelector('div:first-child').textContent = avgScore.toFixed(1);
          } else {
            scoreEl.style.display = 'none';
          }
        }
      } else {
        if (notLinked) notLinked.style.display = 'block';
        if (linked) linked.style.display = 'none';
        if (scoreEl) scoreEl.style.display = 'none';
      }
    }
    
    async function createSurveyForm(formType) {
      if (!editingSessionId) {
        showToast('Please save the session first', 'error');
        return;
      }
      
      const sessionName = document.getElementById('sessionName')?.value || 'Training Session';
      
      showLoading('Creating form...');
      
      try {
        const result = await api('createSessionForm', editingSessionId, formType, sessionName);
        
        if (result && result.success) {
          currentSessionFormUrls[formType] = result.formUrl;
          currentSessionFormEditUrls[formType] = result.editUrl || null;
          updateFormCard(formType, result.formUrl, 0);
          showToast(`${getFormTypeName(formType)} created successfully!`, 'success');
          
          // Open the form in new tab for customization
          if (result.editUrl) {
            window.open(result.editUrl, '_blank');
          }
        } else {
          showToast(result?.message || 'Failed to create form', 'error');
        }
      } catch (e) {
        showToast('Error creating form: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function unlinkForm(formType) {
      if (!editingSessionId) return;
      
      if (!confirm(`Are you sure you want to unlink this ${getFormTypeName(formType)}? The form itself will not be deleted.`)) {
        return;
      }
      
      showLoading('Unlinking form...');
      
      try {
        const result = await api('unlinkSessionForm', editingSessionId, formType);
        
        if (result && result.success) {
          currentSessionFormUrls[formType] = null;
          currentSessionFormEditUrls[formType] = null;
          updateFormCard(formType, null, 0);
          showToast(`${getFormTypeName(formType)} unlinked`, 'success');
        } else {
          showToast(result?.message || 'Failed to unlink form', 'error');
        }
      } catch (e) {
        showToast('Error unlinking form: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function openSurveyForm(formType) {
      const url = currentSessionFormUrls[formType];
      if (url) {
        // Convert to viewform URL if needed
        let viewUrl = url;
        if (url.includes('/edit')) {
          viewUrl = url.replace('/edit', '/viewform');
        } else if (!url.includes('/viewform')) {
          viewUrl = url + (url.includes('?') ? '&' : '/viewform');
        }
        window.open(viewUrl, '_blank');
      } else {
        showToast('No form linked', 'error');
      }
    }
    
    function editSurveyForm(formType) {
      const editUrl = currentSessionFormEditUrls[formType];
      if (editUrl) {
        window.open(editUrl, '_blank');
      } else {
        // Fallback: try to open with published URL (might redirect to edit for owners)
        const publishedUrl = currentSessionFormUrls[formType];
        if (publishedUrl) {
          showToast('Loading editor...', 'info');
          // Try to construct edit URL from published URL
          window.open(publishedUrl.replace('/viewform', '/edit').replace('/d/e/', '/d/'), '_blank');
        } else {
          showToast('No form linked', 'error');
        }
      }
    }
    
    let pendingSendFormType = null;
    let selectedFormRecipients = new Set();
    
    async function sendFormToParticipants(formType) {
      if (!editingSessionId) return;
      
      const url = currentSessionFormUrls[formType];
      if (!url) {
        showToast('No form linked', 'error');
        return;
      }
      
      // Load participants if not already loaded
      if (currentParticipants.length === 0) {
        showLoading('Loading participants...');
        await loadParticipants(editingSessionId);
        hideLoading();
      }
      
      if (currentParticipants.length === 0) {
        showToast('No participants enrolled in this session', 'error');
        return;
      }
      
      // Filter participants with email
      const participantsWithEmail = currentParticipants.filter(p => p.email && p.email.includes('@'));
      
      if (participantsWithEmail.length === 0) {
        showToast('No participants have email addresses', 'error');
        return;
      }
      
      // Open send modal
      pendingSendFormType = formType;
      selectedFormRecipients = new Set(participantsWithEmail.map(p => p.enrollmentId));
      
      document.getElementById('sendFormModalTitle').textContent = `Send ${getFormTypeName(formType)}`;
      document.getElementById('sendAllCount').textContent = `${participantsWithEmail.length} participant${participantsWithEmail.length !== 1 ? 's' : ''} with email`;
      
      // Populate recipient list
      const listContainer = document.getElementById('formRecipientsList');
      listContainer.innerHTML = participantsWithEmail.map(p => `
        <label style="display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid #f3f4f6; cursor:pointer; transition:background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
          <input type="checkbox" class="form-recipient-check" value="${p.enrollmentId}" checked onchange="updateFormRecipientSelection()" style="width:16px; height:16px;">
          <div style="flex:1; min-width:0;">
            <div style="font-size:0.85rem; font-weight:500;">${p.name || 'Unknown'}</div>
            <div style="font-size:0.75rem; color:#6b7280; overflow:hidden; text-overflow:ellipsis;">${p.email}</div>
          </div>
        </label>
      `).join('');
      
      // Reset to "all" option
      document.querySelector('input[name="sendOption"][value="all"]').checked = true;
      document.getElementById('participantSelectionList').style.display = 'none';
      document.getElementById('selectedRecipientsCount').style.display = 'none';
      document.getElementById('selectAllFormRecipients').checked = true;
      
      document.getElementById('sendFormModal').style.display = 'flex';
    }
    
    function closeSendFormModal() {
      document.getElementById('sendFormModal').style.display = 'none';
      pendingSendFormType = null;
    }
    
    function selectSendOption(option) {
      const selectionList = document.getElementById('participantSelectionList');
      const countDisplay = document.getElementById('selectedRecipientsCount');
      
      if (option === 'selected') {
        selectionList.style.display = 'block';
        countDisplay.style.display = 'block';
        updateFormRecipientSelection();
      } else {
        selectionList.style.display = 'none';
        countDisplay.style.display = 'none';
        // Select all when switching to "all"
        document.querySelectorAll('.form-recipient-check').forEach(cb => cb.checked = true);
        selectedFormRecipients = new Set(currentParticipants.filter(p => p.email && p.email.includes('@')).map(p => p.enrollmentId));
      }
    }
    
    function toggleAllFormRecipients() {
      const selectAll = document.getElementById('selectAllFormRecipients').checked;
      document.querySelectorAll('.form-recipient-check').forEach(cb => cb.checked = selectAll);
      updateFormRecipientSelection();
    }
    
    function updateFormRecipientSelection() {
      selectedFormRecipients.clear();
      document.querySelectorAll('.form-recipient-check:checked').forEach(cb => {
        selectedFormRecipients.add(cb.value);
      });
      
      const countEl = document.getElementById('selectedRecipientsCount');
      countEl.querySelector('span').textContent = selectedFormRecipients.size;
      
      // Update select all checkbox state
      const allChecks = document.querySelectorAll('.form-recipient-check');
      const checkedChecks = document.querySelectorAll('.form-recipient-check:checked');
      const selectAllCb = document.getElementById('selectAllFormRecipients');
      selectAllCb.checked = allChecks.length === checkedChecks.length;
      selectAllCb.indeterminate = checkedChecks.length > 0 && checkedChecks.length < allChecks.length;
    }
    
    async function confirmSendForm() {
      console.log('confirmSendForm called, pendingSendFormType:', pendingSendFormType, 'editingSessionId:', editingSessionId);
      
      if (!pendingSendFormType || !editingSessionId) {
        showToast('No form type selected', 'error');
        console.error('Missing pendingSendFormType or editingSessionId');
        return;
      }
      
      // Save formType BEFORE closing modal (which clears pendingSendFormType)
      const formType = pendingSendFormType;
      console.log('formType saved as:', formType);
      
      const sendOption = document.querySelector('input[name="sendOption"]:checked').value;
      let recipientIds = [];
      
      if (sendOption === 'all') {
        recipientIds = currentParticipants.filter(p => p.email && p.email.includes('@')).map(p => p.enrollmentId);
      } else {
        recipientIds = Array.from(selectedFormRecipients);
      }
      
      if (recipientIds.length === 0) {
        showToast('Please select at least one recipient', 'error');
        return;
      }
      
      closeSendFormModal();
      showLoading(`Sending form to ${recipientIds.length} participant(s)...`);
      
      try {
        console.log('Calling sendFormToParticipants API with:', { sessionId: editingSessionId, formType, recipientCount: recipientIds.length });
        const result = await api('sendFormToParticipants', editingSessionId, formType, recipientIds);
        console.log('sendFormToParticipants result:', result);
        
        if (result && result.success) {
          showToast(`Form sent to ${result.sentCount} participant(s)!`, 'success');
        } else {
          showToast(result?.message || 'Failed to send form', 'error');
        }
      } catch (e) {
        console.error('sendFormToParticipants error:', e);
        showToast('Error sending form: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function getFormTypeName(formType) {
      const names = {
        feedback: 'Post-Training Feedback',
        survey: 'Pre-Training Survey',
        assessment: 'Assessment Quiz'
      };
      return names[formType] || formType;
    }

    // ============================================
    // QR ATTENDANCE FUNCTIONS
    // ============================================
    
    let qrCardsData = [];
    let qrSelectedCards = new Set();
    let scanHistoryData = [];
    let embeddedScanner = null;
    let embeddedScannerRunning = false;
    let currentScannerSessionId = null;
    let currentScannerSession = null;
    let recentScans = [];
    let qrEnrollmentsData = []; // For session-based filtering
    let scannerProgramsData = [];
    let scannerSessionsData = [];
    
    // Tab switching
    function switchQRTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.qr-tab').forEach(t => t.classList.remove('active'));
      document.getElementById('qrTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
      
      // Show/hide tabs
      document.getElementById('qrCardsTab').style.display = tab === 'cards' ? 'block' : 'none';
      document.getElementById('qrScannerTab').style.display = tab === 'scanner' ? 'block' : 'none';
      document.getElementById('qrHistoryTab').style.display = tab === 'history' ? 'block' : 'none';
      
      // Stop scanner when switching away
      if (tab !== 'scanner' && embeddedScannerRunning) {
        stopEmbeddedScanner();
      }
      
      // LAZY LOAD: Load data for active tab only when needed
      if (tab === 'cards' && qrCardsData.length === 0) {
        loadQRCards();
        loadQRProgramFilter();
      } else if (tab === 'scanner') {
        initScannerSetup();
      } else if (tab === 'history' && !window.historyDataLoaded) {
        loadHistorySessions();
        loadScanHistory();
        window.historyDataLoaded = true;
      }
    }
    
    // Load QR cards data
    async function loadQRCards() {
      const grid = document.getElementById('qrCardsGrid');
      const empty = document.getElementById('qrCardsEmpty');
      
      grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--text-muted);"><i class="ri-loader-4-line ri-spin" style="font-size:2rem;"></i><p style="margin-top:1rem;">Loading employees...</p></div>';
      empty.style.display = 'none';
      
      try {
        const filters = {
          entity: document.getElementById('qrEntityFilter').value,
          function: document.getElementById('qrFunctionFilter').value,
          search: document.getElementById('qrSearchInput').value
        };
        
        qrCardsData = await api('getQRCardData', filters);
        
        // Populate filter dropdowns
        populateQRFilters();
        
        renderQRCards();
        
      } catch (e) {
        console.error('Failed to load QR cards:', e);
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--error);"><i class="ri-error-warning-line" style="font-size:2rem;"></i><p style="margin-top:1rem;">Failed to load employees. Please try again.</p></div>';
      }
    }
    
    // Load program filter for QR cards
    async function loadQRProgramFilter() {
      const programSelect = document.getElementById('qrProgramFilter');
      if (!programSelect) return;
      
      try {
        const programs = window.programsData || await api('getPrograms');
        programSelect.innerHTML = '<option value="all">All Programs</option>' +
          programs.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      } catch (e) {
        console.error('Failed to load programs for QR filter:', e);
      }
    }
    
    function populateQRFilters() {
      const entities = [...new Set(qrCardsData.map(e => e.entity).filter(Boolean))].sort();
      const functions = [...new Set(qrCardsData.map(e => e.function).filter(Boolean))].sort();
      
      const entitySelect = document.getElementById('qrEntityFilter');
      const funcSelect = document.getElementById('qrFunctionFilter');
      
      const currentEntity = entitySelect.value;
      const currentFunc = funcSelect.value;
      
      entitySelect.innerHTML = '<option value="all">All Entities</option>' + 
        entities.map(e => `<option value="${e}">${e}</option>`).join('');
      
      funcSelect.innerHTML = '<option value="all">All Functions</option>' + 
        functions.map(f => `<option value="${f}">${f}</option>`).join('');
      
      entitySelect.value = currentEntity || 'all';
      funcSelect.value = currentFunc || 'all';
    }
    
    async function filterQRCards() {
      const search = document.getElementById('qrSearchInput').value.toLowerCase();
      const entity = document.getElementById('qrEntityFilter').value;
      const func = document.getElementById('qrFunctionFilter').value;
      const sessionId = document.getElementById('qrSessionFilter')?.value || 'all';
      const dateVal = document.getElementById('qrEnrollmentDate')?.value || '';
      
      let filtered = qrCardsData.filter(emp => {
        if (search && !emp.name.toLowerCase().includes(search) && !emp.id.toLowerCase().includes(search)) return false;
        if (entity !== 'all' && emp.entity !== entity) return false;
        if (func !== 'all' && emp.function !== func) return false;
        return true;
      });
      
      // Filter by session enrollment if selected
      if (sessionId !== 'all') {
        try {
          const enrollments = await api('getEnrollments', sessionId);
          const enrolledIds = new Set(enrollments.map(e => e.employeeId));
          filtered = filtered.filter(emp => enrolledIds.has(emp.id));
        } catch (e) {
          console.error('Failed to filter by session:', e);
        }
      } else if (dateVal && window.qrSessionsOnDate && window.qrSessionsOnDate.length > 0) {
        // Filter by date - show employees enrolled in any session on this date
        const programId = document.getElementById('qrProgramFilter').value;
        let sessionsToCheck = window.qrSessionsOnDate;
        if (programId !== 'all') {
          sessionsToCheck = sessionsToCheck.filter(s => s.programId === programId);
        }
        
        if (sessionsToCheck.length > 0) {
          try {
            const allEnrolledIds = new Set();
            for (const session of sessionsToCheck) {
              const enrollments = await api('getEnrollments', session.id);
              enrollments.forEach(e => allEnrolledIds.add(e.employeeId));
            }
            filtered = filtered.filter(emp => allEnrolledIds.has(emp.id));
          } catch (e) {
            console.error('Failed to filter by date enrollments:', e);
          }
        }
      }
      
      renderQRCards(filtered);
    }
    
    function renderQRCards(data = null) {
      const grid = document.getElementById('qrCardsGrid');
      const empty = document.getElementById('qrCardsEmpty');
      const employees = data || qrCardsData;
      
      if (!employees || employees.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      
      // Render cards WITHOUT QR preview - just employee info
      grid.innerHTML = employees.map(emp => `
        <div class="qr-card ${qrSelectedCards.has(emp.id) ? 'selected' : ''}" data-id="${emp.id}" data-qrstring="${emp.qrString || ''}" onclick="toggleQRCardSelection('${emp.id}', event)">
          <div class="qr-card-header">
            <div class="qr-card-badge">Employee</div>
            <input type="checkbox" class="qr-card-checkbox" ${qrSelectedCards.has(emp.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleQRCardSelection('${emp.id}', event)">
          </div>
          <div class="qr-card-body">
            <div class="qr-card-name">${emp.name}</div>
            <div class="qr-card-id">ID: ${emp.id}</div>
            <div class="qr-card-meta">
              <div class="qr-card-meta-item">
                <i class="ri-building-line"></i>
                <span>${emp.entity || 'N/A'}</span>
              </div>
              <div class="qr-card-meta-item">
                <i class="ri-briefcase-line"></i>
                <span>${emp.function || 'N/A'}</span>
              </div>
            </div>
          </div>
          <div class="qr-card-actions">
            <button class="qr-card-action-btn" onclick="event.stopPropagation(); downloadSingleQRCard('${emp.id}')">
              <i class="ri-download-line"></i> Download
            </button>
            <button class="qr-card-action-btn" onclick="event.stopPropagation(); emailSingleQRCard('${emp.id}')">
              <i class="ri-mail-line"></i> Email
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function filterQRCards() {
      const search = document.getElementById('qrSearchInput').value.toLowerCase();
      const entity = document.getElementById('qrEntityFilter').value;
      const func = document.getElementById('qrFunctionFilter').value;
      
      const filtered = qrCardsData.filter(emp => {
        if (search && !emp.name.toLowerCase().includes(search) && !emp.id.toLowerCase().includes(search)) return false;
        if (entity !== 'all' && emp.entity !== entity) return false;
        if (func !== 'all' && emp.function !== func) return false;
        return true;
      });
      
      renderQRCards(filtered);
    }
    
    function toggleQRCardSelection(empId, event) {
      if (event) event.stopPropagation();
      
      if (qrSelectedCards.has(empId)) {
        qrSelectedCards.delete(empId);
      } else {
        qrSelectedCards.add(empId);
      }
      
      updateQRSelectionUI();
    }
    
    function toggleSelectAllQRCards() {
      const checkAll = document.getElementById('selectAllQRCards').checked;
      const search = document.getElementById('qrSearchInput').value.toLowerCase();
      const entity = document.getElementById('qrEntityFilter').value;
      const func = document.getElementById('qrFunctionFilter').value;
      
      const filtered = qrCardsData.filter(emp => {
        if (search && !emp.name.toLowerCase().includes(search) && !emp.id.toLowerCase().includes(search)) return false;
        if (entity !== 'all' && emp.entity !== entity) return false;
        if (func !== 'all' && emp.function !== func) return false;
        return true;
      });
      
      if (checkAll) {
        filtered.forEach(emp => qrSelectedCards.add(emp.id));
      } else {
        qrSelectedCards.clear();
      }
      
      updateQRSelectionUI();
      renderQRCards(filtered);
    }
    
    function updateQRSelectionUI() {
      const count = qrSelectedCards.size;
      document.getElementById('qrSelectedCount').textContent = `${count} selected`;
      document.getElementById('downloadSelectedBtn').disabled = count === 0;
      document.getElementById('emailSelectedBtn').disabled = count === 0;
      
      // Update card visual state
      document.querySelectorAll('.qr-card').forEach(card => {
        const id = card.dataset.id;
        const isSelected = qrSelectedCards.has(id);
        card.classList.toggle('selected', isSelected);
        const checkbox = card.querySelector('.qr-card-checkbox');
        if (checkbox) checkbox.checked = isSelected;
      });
    }
    
    // ============================================
    // DOWNLOAD QR FUNCTIONS
    // ============================================
    
    async function downloadSelectedQRCards() {
      if (qrSelectedCards.size === 0) return;
      
      const selected = qrCardsData.filter(emp => qrSelectedCards.has(emp.id));
      showLoading(`Generating ${selected.length} QR code(s)...`);
      
      try {
        for (let i = 0; i < selected.length; i++) {
          await downloadQRCardImage(selected[i]);
          // Small delay between downloads
          if (selected.length > 1) {
            await new Promise(r => setTimeout(r, 400));
          }
        }
        
        hideLoading();
        showToast(`Downloaded ${selected.length} QR code(s)`, 'success');
        
      } catch (e) {
        hideLoading();
        console.error('Download error:', e);
        showToast('Failed to download QR codes: ' + e.message, 'error');
      }
    }
    
    async function downloadSingleQRCard(empId) {
      // Find employee in cached data
      let emp = qrCardsData.find(e => e.id === empId);
      
      // If not found in cache, try to load it
      if (!emp || !emp.qrString) {
        showLoading('Loading employee data...');
        try {
          const allData = await api('getQRCardData', {});
          qrCardsData = allData; // Update cache
          emp = allData.find(e => e.id === empId);
        } catch (e) {
          hideLoading();
          console.error('Failed to load employee data:', e);
          showToast('Failed to load employee data', 'error');
          return;
        }
      }
      
      if (!emp) {
        hideLoading();
        showToast('Employee not found: ' + empId, 'error');
        return;
      }
      
      if (!emp.qrString) {
        hideLoading();
        showToast('QR data not available for this employee', 'error');
        return;
      }
      
      showLoading('Generating QR code...');
      
      try {
        await downloadQRCardImage(emp);
        hideLoading();
        showToast('QR code downloaded', 'success');
      } catch (e) {
        hideLoading();
        console.error('Download error:', e);
        showToast('Failed to generate QR code: ' + (e.message || 'Unknown error'), 'error');
      }
    }
    
    function downloadQRCardImage(emp) {
      return new Promise((resolve, reject) => {
        try {
          // Check if QRCode library is available
          if (typeof QRCode === 'undefined') {
            reject(new Error('QRCode library not loaded. Please refresh the page.'));
            return;
          }
          
          // Create canvas for QR card
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Card dimensions
          canvas.width = 525;
          canvas.height = 330;
          
          // Helper function for rounded rectangles
          function drawRoundRect(x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
          }
          
          // White background
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Border
          ctx.strokeStyle = '#e2e8f0';
          ctx.lineWidth = 2;
          drawRoundRect(5, 5, canvas.width - 10, canvas.height - 10, 12);
          ctx.stroke();
          
          // Header bar
          ctx.fillStyle = '#1e40af';
          ctx.fillRect(0, 0, canvas.width, 40);
          
          // Header text
          ctx.fillStyle = '#ffffff';
          ctx.font = 'bold 14px Arial';
          ctx.fillText('TRAINING ATTENDANCE QR CODE', 20, 26);
          
          // Generate QR code in hidden div
          const tempDiv = document.createElement('div');
          tempDiv.style.cssText = 'position:fixed; left:-9999px; top:-9999px; visibility:hidden;';
          document.body.appendChild(tempDiv);
          
          // Create QR Code
          new QRCode(tempDiv, {
            text: emp.qrString,
            width: 180,
            height: 180,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
          });
          
          // Wait for QR to render then draw on canvas
          setTimeout(() => {
            try {
              const qrCanvas = tempDiv.querySelector('canvas');
              const qrImg = tempDiv.querySelector('img');
              
              if (qrCanvas) {
                ctx.drawImage(qrCanvas, 30, 60, 180, 180);
              } else if (qrImg) {
                ctx.drawImage(qrImg, 30, 60, 180, 180);
              }
              
              // Clean up
              if (tempDiv.parentNode) {
                document.body.removeChild(tempDiv);
              }
              
              // QR border
              ctx.strokeStyle = '#e2e8f0';
              ctx.lineWidth = 1;
              drawRoundRect(25, 55, 190, 190, 8);
              ctx.stroke();
              
              // Employee info
              const infoX = 240;
              
              ctx.fillStyle = '#0f172a';
              ctx.font = 'bold 20px Arial';
              const name = emp.name || 'Unknown';
              ctx.fillText(name.length > 22 ? name.substring(0, 22) + '...' : name, infoX, 95);
              
              ctx.fillStyle = '#64748b';
              ctx.font = '14px Courier New, monospace';
              ctx.fillText('ID: ' + (emp.id || 'N/A'), infoX, 125);
              
              ctx.fillStyle = '#475569';
              ctx.font = '12px Arial';
              ctx.fillText('Entity: ' + (emp.entity || 'N/A'), infoX, 160);
              ctx.fillText('Function: ' + (emp.function || 'N/A'), infoX, 185);
              
              ctx.fillStyle = '#94a3b8';
              ctx.font = '10px Arial';
              ctx.fillText('Present this QR code when attending training', 30, 268);
              ctx.fillText('This is a lifetime QR code. Keep it safe.', 30, 285);
              
              ctx.fillStyle = '#cbd5e1';
              ctx.font = '9px Arial';
              ctx.fillText('Generated: ' + new Date().toLocaleDateString(), 30, 310);
              
              // Trigger download
              const link = document.createElement('a');
              const safeName = (emp.name || 'employee').replace(/[^a-zA-Z0-9]/g, '_');
              link.download = `QR_${emp.id}_${safeName}.png`;
              link.href = canvas.toDataURL('image/png');
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              resolve();
            } catch (innerErr) {
              if (tempDiv.parentNode) document.body.removeChild(tempDiv);
              reject(innerErr);
            }
          }, 300); // Increased timeout for QR rendering
          
        } catch (err) {
          reject(err);
        }
      });
    }
    
    // ============================================
    // EMAIL QR FUNCTIONS (Direct send, no modal)
    // ============================================
    
    async function emailSelectedQRCards() {
      if (qrSelectedCards.size === 0) return;
      
      const ids = [...qrSelectedCards];
      showLoading(`Sending ${ids.length} email(s)...`);
      
      try {
        const result = await api('emailQRCardsBulk', ids, { includeUpcomingTrainings: true });
        hideLoading();
        
        if (result.sent > 0) {
          showToast(`Successfully sent ${result.sent} email(s)`, 'success');
        }
        if (result.failed > 0) {
          showToast(`Failed to send ${result.failed} email(s)`, 'error');
        }
      } catch (e) {
        hideLoading();
        showToast('Failed to send emails: ' + e.message, 'error');
      }
    }
    
    async function emailSingleQRCard(empId) {
      showLoading('Sending email...');
      
      try {
        const result = await api('emailQRCard', empId, { includeUpcomingTrainings: true });
        hideLoading();
        
        if (result.success) {
          showToast(result.message || 'Email sent successfully', 'success');
        } else {
          showToast(result.error || 'Failed to send email', 'error');
        }
      } catch (e) {
        hideLoading();
        showToast('Failed to send email: ' + e.message, 'error');
      }
    }
    
    // ============================================
    // SCANNER SETUP & FUNCTIONS
    // ============================================
    
    async function initScannerSetup() {
      // Set today's date
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('scannerTodayDate').textContent = today.toLocaleDateString('en-US', options);
      
      // Get today's date components for comparison (local timezone - no UTC conversion!)
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth();
      const todayDay = today.getDate();
      
      const container = document.getElementById('todaySessionsContainer');
      const noSessionsMsg = document.getElementById('noSessionsMessage');
      
      try {
        // Load all sessions using getSessionsForScanner (doesn't require session token)
        // This already includes programName, so no need to load programs separately
        const rawSessions = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getSessionsForScanner();
        }) || [];
        
        // Filter to only sessions happening TODAY (compare date parts only)
        const todaysSessions = rawSessions.filter(s => {
          const dateStr = s.date || s.startDate;
          if (!dateStr || dateStr === 'TBD') return false;
          
          const sessionDate = new Date(dateStr);
          // Compare year, month, day in local timezone
          return sessionDate.getFullYear() === todayYear &&
                 sessionDate.getMonth() === todayMonth &&
                 sessionDate.getDate() === todayDay;
        }).map(s => ({
          id: s.id || s.sessionId,
          sessionId: s.id || s.sessionId,
          name: s.name,
          programId: s.programId,
          programName: s.programName,  // Preserve programName!
          date: s.date || s.startDate,
          location: s.location,
          entity: s.entity,
          capacity: s.capacity,
          status: s.status
        }));
        
        scannerSessionsData = todaysSessions;
        
        if (todaysSessions.length === 0) {
          // No sessions today
          container.innerHTML = '';
          noSessionsMsg.style.display = 'block';
        } else {
          // Render today's sessions as clickable cards
          noSessionsMsg.style.display = 'none';
          container.innerHTML = todaysSessions.map(session => {
            // Use programName from getSessionsForScanner - no lookup needed
            return `
              <div class="today-session-card" onclick="selectTodaySession('${session.id}')">
                <div class="today-session-card-header">
                  <div>
                    <div class="today-session-name">${session.name}</div>
                    <div class="today-session-program">${session.programName || session.programId}</div>
                  </div>
                  <div class="today-session-badge">Today</div>
                </div>
                <div class="today-session-details">
                  <div class="today-session-detail">
                    <i class="ri-map-pin-line"></i>
                    <span>${session.location || 'Not specified'}</span>
                  </div>
                  <div class="today-session-detail">
                    <i class="ri-building-line"></i>
                    <span>${session.entity || 'All Entities'}</span>
                  </div>
                </div>
                <div class="today-session-action">
                  <i class="ri-qr-scan-2-line"></i>
                  <span>Click to start scanning</span>
                </div>
              </div>
            `;
          }).join('');
        }
        
      } catch (e) {
        console.error('Failed to load sessions:', e);
        const errorMsg = e.message || 'Unknown error';
        container.innerHTML = `<div class="today-sessions-loading" style="color:#ef4444;"><i class="ri-error-warning-line"></i> Failed to load sessions: ${errorMsg}</div>`;
      }
      
      // Initialize cameras
      await initScannerCameras();
    }
    
    // Select a session from today's list and start scanning
    async function selectTodaySession(sessionId) {
      const session = scannerSessionsData.find(s => s.id === sessionId || s.sessionId === sessionId);
      if (!session) {
        showToast('Session not found', 'error');
        return;
      }
      
      // Use programName from session data (from getSessionsForScanner)
      const programName = session.programName || session.programId;
      
      showLoading('Setting up scanner...');
      
      try {
        // IMPORTANT: Set active session on the backend first!
        const result = await api('setActiveScannerSession', sessionId, session.name, programName);
        
        if (!result || !result.success) {
          hideLoading();
          showToast('Failed to set scanner session: ' + (result?.error || 'Unknown error'), 'error');
          return;
        }
        
        currentScannerSessionId = sessionId;
        currentScannerSession = session;
        
        // Update active header
        document.getElementById('activeScannerSession').textContent = session.name;
        document.getElementById('activeScannerProgram').textContent = programName;
        
        // Switch panels
        document.getElementById('scannerSetupPanel').style.display = 'none';
        document.getElementById('scannerActivePanel').style.display = 'block';
        
        // Update stats
        await refreshScannerStats();
        
        // Clear recent scans
        recentScans = [];
        renderRecentScans();
        
        hideLoading();
        showToast('Ready to scan for: ' + session.name, 'success');
        
      } catch (e) {
        hideLoading();
        console.error('Failed to set scanner session:', e);
        showToast('Failed to initialize scanner: ' + (e.message || e), 'error');
      }
    }
    
    async function changeScannerSession() {
      // Clear active session on backend
      try {
        await api('clearActiveScannerSession');
      } catch (e) {
        console.error('Failed to clear scanner session:', e);
      }
      
      // Stop camera if running
      if (embeddedScanner && embeddedScannerRunning) {
        try {
          await embeddedScanner.stop();
          embeddedScanner = null;
          embeddedScannerRunning = false;
        } catch (e) {
          console.error('Error stopping scanner:', e);
        }
      }
      
      currentScannerSessionId = null;
      currentScannerSession = null;
      
      // Show setup panel, hide active panel
      document.getElementById('scannerSetupPanel').style.display = 'block';
      document.getElementById('scannerActivePanel').style.display = 'none';
      
      // Reset start/stop button
      const btn = document.getElementById('scannerStartStop');
      if (btn) {
        btn.innerHTML = '<i class="ri-play-fill"></i><span>Start Camera</span>';
        btn.classList.remove('stop');
      }
      
      // Reload today's sessions
      await initScannerSetup();
    }
    
    // Scanner Mode Toggle
    function switchScannerMode(mode) {
      document.getElementById('modeCameraBtn').classList.toggle('active', mode === 'camera');
      document.getElementById('modeReaderBtn').classList.toggle('active', mode === 'reader');
      
      document.getElementById('cameraModePanel').style.display = mode === 'camera' ? 'block' : 'none';
      document.getElementById('readerModePanel').style.display = mode === 'reader' ? 'block' : 'none';
      
      if (mode === 'reader') {
        // Stop camera if running
        if (embeddedScannerRunning) {
          stopEmbeddedScanner();
        }
        // Focus reader input
        setTimeout(() => document.getElementById('readerInput').focus(), 100);
      }
    }
    
    // Reader Mode Handlers
    let readerBuffer = '';
    let readerTimer = null;
    
    function handleReaderKeydown(event) {
      if (event.key === 'Enter' || event.key === 'Tab') {
        event.preventDefault();
        processReaderInput();
      }
    }
    
    function handleReaderInput() {
      const input = document.getElementById('readerInput');
      readerBuffer = input.value;
      
      // Auto-submit after 150ms pause (typical scanner behavior)
      clearTimeout(readerTimer);
      if (readerBuffer.length > 5) {
        readerTimer = setTimeout(processReaderInput, 150);
      }
    }
    
    function processReaderInput() {
      const input = document.getElementById('readerInput');
      const value = input.value.trim();
      
      if (value.length > 5) {
        onQRCodeScanned(value);
        input.value = '';
        readerBuffer = '';
      }
      
      // Keep focus
      input.focus();
    }
    
    async function initScannerCameras() {
      const select = document.getElementById('scannerCameraSelect');
      if (!select) return;
      
      try {
        const devices = await Html5Qrcode.getCameras();
        select.innerHTML = devices.map(d => 
          `<option value="${d.id}">${d.label || 'Camera ' + (devices.indexOf(d) + 1)}</option>`
        ).join('');
      } catch (e) {
        console.error('Failed to get cameras:', e);
        select.innerHTML = '<option value="">No cameras found</option>';
      }
    }
    
    async function refreshScannerStats() {
      if (!currentScannerSessionId) return;
      
      try {
        const stats = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getSessionAttendanceStats(currentScannerSessionId);
        });
        document.getElementById('scannerCheckedIn').textContent = stats.enrolled || 0;
        document.getElementById('scannerTarget').textContent = stats.target || 0;
      } catch (e) {
        console.error('Failed to get stats:', e);
      }
    }
    
    async function toggleEmbeddedScanner() {
      if (embeddedScannerRunning) {
        await stopEmbeddedScanner();
      } else {
        await startEmbeddedScanner();
      }
    }
    
    async function startEmbeddedScanner() {
      if (!currentScannerSessionId) {
        showToast('Please select a session first', 'error');
        return;
      }
      
      const cameraId = document.getElementById('scannerCameraSelect').value;
      const btn = document.getElementById('scannerStartStop');
      
      try {
        embeddedScanner = new Html5Qrcode('qrReader');
        
        await embeddedScanner.start(
          cameraId || { facingMode: 'environment' },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          onQRCodeScanned,
          () => {} // Ignore errors
        );
        
        embeddedScannerRunning = true;
        btn.innerHTML = '<i class="ri-stop-fill"></i><span>Stop Camera</span>';
        btn.classList.add('stop');
        
      } catch (e) {
        console.error('Failed to start scanner:', e);
        showToast('Failed to start camera. Check permissions.', 'error');
      }
    }
    
    async function stopEmbeddedScanner() {
      const btn = document.getElementById('scannerStartStop');
      
      if (embeddedScanner) {
        try {
          await embeddedScanner.stop();
        } catch (e) {}
        embeddedScanner = null;
      }
      
      embeddedScannerRunning = false;
      if (btn) {
        btn.innerHTML = '<i class="ri-play-fill"></i><span>Start Camera</span>';
        btn.classList.remove('stop');
      }
    }
    
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 1500; // Reduced from 2000ms since we're faster now
    
    // Client-side duplicate detection cache
    const recentScannedIds = new Set();
    const DUPLICATE_CACHE_TIMEOUT = 5000; // 5 seconds
    
    // Client-side QR format validation (quick reject invalid formats)
    function validateQRFormat(qrString) {
      if (!qrString || typeof qrString !== 'string') {
        return { valid: false, error: 'Empty QR code' };
      }
      const parts = qrString.split('|');
      if (parts.length !== 5 || parts[0] !== 'EMP') {
        return { valid: false, error: 'Invalid QR format' };
      }
      return { valid: true, employeeId: parts[1], name: parts[2] };
    }
    
    async function onQRCodeScanned(decodedText) {
      const now = Date.now();
      if (now - lastScanTime < SCAN_COOLDOWN) return;
      lastScanTime = now;
      
      if (!currentScannerSessionId) {
        showToast('No session selected', 'error');
        return;
      }
      
      // CLIENT-SIDE: Quick format validation (avoid API call for invalid QRs)
      const formatCheck = validateQRFormat(decodedText);
      if (!formatCheck.valid) {
        playErrorSound();
        showScanResult({ status: 'error', message: formatCheck.error });
        return;
      }
      
      // CLIENT-SIDE: Duplicate detection (skip API for very recent re-scans)
      const cacheKey = `${currentScannerSessionId}_${formatCheck.employeeId}`;
      if (recentScannedIds.has(cacheKey)) {
        playDetectSound();
        showScanResult({ 
          status: 'success', 
          message: `${formatCheck.name} already scanned`,
          name: formatCheck.name,
          alreadyMarked: true
        });
        return;
      }
      
      // OPTIMISTIC UI: Show Welcome IMMEDIATELY using QR data
      // Don't wait for server - user sees instant feedback!
      playSuccessSound();
      showScanResult({ 
        status: 'success', 
        message: 'Checked in!',
        name: formatCheck.name,
        alreadyMarked: false
      });
      
      // Add to duplicate cache immediately
      recentScannedIds.add(cacheKey);
      setTimeout(() => recentScannedIds.delete(cacheKey), DUPLICATE_CACHE_TIMEOUT);
      
      // Add to recent scans immediately
      recentScans.unshift({
        name: formatCheck.name,
        time: new Date().toLocaleTimeString(),
        isNew: true,
        pending: true  // Mark as pending server confirmation
      });
      if (recentScans.length > 10) recentScans.pop();
      renderRecentScans();
      
      // Update last scan time
      document.getElementById('scannerLastScan').textContent = new Date().toLocaleTimeString();
      
      // BACKGROUND: Send to server (fire and mostly forget)
      api('scanAttendance', currentScannerSessionId, decodedText)
        .then(response => {
          // Update stats from response
          if (response.stats) {
            document.getElementById('scannerCheckedIn').textContent = response.stats.checkedIn || 0;
            document.getElementById('scannerTarget').textContent = response.stats.target || 0;
          }
          
          // If server says already enrolled, update recent scan entry
          if (response.alreadyMarked || response.alreadyEnrolled) {
            const scan = recentScans.find(s => s.name === formatCheck.name && s.pending);
            if (scan) {
              scan.isNew = false;
              scan.pending = false;
              renderRecentScans();
            }
          } else {
            // Mark as confirmed
            const scan = recentScans.find(s => s.name === formatCheck.name && s.pending);
            if (scan) scan.pending = false;
          }
          
          // Increment checked-in count for new enrollments
          if (!response.alreadyMarked && !response.alreadyEnrolled && response.status === 'success') {
            const countEl = document.getElementById('scannerCheckedIn');
            countEl.textContent = parseInt(countEl.textContent || 0) + 1;
          }
        })
        .catch(e => {
          // Server error - show subtle error, but don't undo the Welcome
          // (user already saw success, we just log the issue)
          console.error('Background scan error:', e);
          // Optionally show a small warning
          const scan = recentScans.find(s => s.name === formatCheck.name && s.pending);
          if (scan) {
            scan.error = true;
            scan.pending = false;
            renderRecentScans();
          }
        });
    }
    
    function showCheckingIn() {
      const toast = document.getElementById('scanResultToast');
      const nameEl = document.getElementById('scanResultName');
      const msgEl = document.getElementById('scanResultMessage');
      const iconEl = toast.querySelector('.scan-result-icon i');
      
      toast.classList.remove('error');
      toast.classList.add('checking');
      iconEl.className = 'ri-loader-4-line ri-spin';
      nameEl.textContent = 'Checking in...';
      msgEl.textContent = 'Please wait';
      
      toast.classList.add('show');
    }
    
    function showScanResult(response) {
      const toast = document.getElementById('scanResultToast');
      const nameEl = document.getElementById('scanResultName');
      const msgEl = document.getElementById('scanResultMessage');
      const iconEl = toast.querySelector('.scan-result-icon i');
      
      // Clear checking state
      toast.classList.remove('checking');
      
      if (response.status === 'success') {
        toast.classList.remove('error');
        iconEl.className = 'ri-check-line';
        nameEl.textContent = `Welcome, ${response.name || 'Guest'}!`;
        
        if (response.alreadyMarked) {
          msgEl.textContent = 'Already checked in';
        } else if (response.walkIn) {
          msgEl.textContent = 'Walk-in  Checked in successfully!';
        } else {
          msgEl.textContent = 'Successfully checked in!';
        }
        
        // Play welcome sound and voice
        playWelcomeSound();
        speakWelcome(response.name || 'Guest');
        
      } else {
        toast.classList.add('error');
        iconEl.className = 'ri-close-line';
        nameEl.textContent = 'Scan Failed';
        msgEl.textContent = response.message || 'Please try again';
        
        // Play error sound
        playErrorSound();
      }
      
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    }
    
    // Audio feedback functions
    let audioContext = null;
    
    function getAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }
    
    // Quick beep when QR is detected (immediate feedback)
    function playDetectSound() {
      try {
        const ctx = getAudioContext();
        const now = ctx.currentTime;
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        
        osc.start(now);
        osc.stop(now + 0.1);
        
        if (navigator.vibrate) navigator.vibrate(30);
        
      } catch (e) {
        console.log('Audio not available:', e);
      }
    }
    
    // Celebratory welcome sound (when name is shown)
    function playWelcomeSound() {
      try {
        const ctx = getAudioContext();
        const now = ctx.currentTime;
        
        // Play a nice ascending arpeggio C-E-G-C (major chord)
        const playTone = (freq, startTime, duration) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(freq, startTime);
          
          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(0.25, startTime + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
          
          osc.start(startTime);
          osc.stop(startTime + duration);
        };
        
        // C major arpeggio: C5 -> E5 -> G5 -> C6
        playTone(523.25, now, 0.15);           // C5
        playTone(659.25, now + 0.1, 0.15);     // E5
        playTone(783.99, now + 0.2, 0.15);     // G5
        playTone(1046.50, now + 0.3, 0.25);    // C6 (hold longer)
        
        if (navigator.vibrate) navigator.vibrate([30, 30, 50]);
        
      } catch (e) {
        console.log('Audio not available:', e);
      }
    }
    
    // Keep old function name for compatibility
    function playSuccessSound() {
      playWelcomeSound();
    }
    
    function playErrorSound() {
      try {
        const ctx = getAudioContext();
        const now = ctx.currentTime;
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        
        osc.start(now);
        osc.stop(now + 0.3);
        
      } catch (e) {
        console.log('Audio not available:', e);
      }
    }
    
    function speakWelcome(name) {
      try {
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech
          window.speechSynthesis.cancel();
          
          const utterance = new SpeechSynthesisUtterance(`Welcome, ${name}`);
          utterance.rate = 1.0;
          utterance.pitch = 1.2; // Slightly higher pitch for friendly tone
          utterance.volume = 0.8;
          
          // Try to use a female voice for friendlier sound
          const voices = window.speechSynthesis.getVoices();
          const femaleVoice = voices.find(v => 
            v.name.includes('Female') || 
            v.name.includes('Samantha') || 
            v.name.includes('Victoria') ||
            v.name.includes('Karen') ||
            v.name.includes('Google') && v.lang.startsWith('en')
          );
          if (femaleVoice) {
            utterance.voice = femaleVoice;
          }
          
          // Small delay to let the chime play first
          setTimeout(() => {
            window.speechSynthesis.speak(utterance);
          }, 300);
        }
      } catch (e) {
        console.log('Speech synthesis not available:', e);
      }
    }
    
    // Pre-load voices (needed for some browsers)
    if ('speechSynthesis' in window) {
      window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
    }
    
    function renderRecentScans() {
      const container = document.getElementById('recentScansContainer');
      
      if (recentScans.length === 0) {
        container.innerHTML = '<div class="scanner-recent-empty">No scans yet</div>';
        return;
      }
      
      container.innerHTML = recentScans.map(scan => {
        let badgeClass = scan.isNew ? 'new' : 'existing';
        let badgeText = scan.isNew ? 'New' : 'Existing';
        let statusIcon = '';
        
        if (scan.pending) {
          statusIcon = '<i class="ri-loader-4-line ri-spin" style="color:#f59e0b;margin-left:8px;"></i>';
        } else if (scan.error) {
          statusIcon = '<i class="ri-error-warning-line" style="color:#ef4444;margin-left:8px;" title="Sync error"></i>';
        }
        
        return `
          <div class="scanner-recent-item">
            <div class="avatar">${scan.name.charAt(0).toUpperCase()}</div>
            <div class="info">
              <div class="name">${scan.name}${statusIcon}</div>
              <div class="time">${scan.time}</div>
            </div>
            <span class="badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
    }
    
    // ============================================
    // SCAN HISTORY FUNCTIONS
    // ============================================
    
    let historySessionsData = []; // Store all sessions for filtering
    let historySortColumn = 'scannedAt';
    let historySortDir = 'desc';
    
    async function loadHistorySessions() {
      try {
        // Use getSessionsForScanner which doesn't require session token
        historySessionsData = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getSessionsForScanner();
        }) || [];
        
        // Populate program dropdown
        populateHistoryProgramDropdown();
        
        // Initially show all sessions
        updateHistorySessionDropdown('');
        
      } catch (e) {
        console.error('Failed to load history sessions:', e);
      }
    }
    
    function populateHistoryProgramDropdown() {
      const dropdown = document.getElementById('historyProgramDropdown');
      const uniquePrograms = new Map();
      
      historySessionsData.forEach(s => {
        // Use programName from getSessionsForScanner data
        const programName = s.programName || s.programId;
        if (!uniquePrograms.has(s.programId)) {
          uniquePrograms.set(s.programId, programName);
        }
      });
      
      // Sort alphabetically
      const sorted = Array.from(uniquePrograms.entries()).sort((a, b) => a[1].localeCompare(b[1]));
      
      dropdown.innerHTML = `<div class="dropdown-item" onclick="selectHistoryProgram('', 'All Programs')">All Programs</div>` +
        sorted.map(([id, name]) => 
          `<div class="dropdown-item" onclick="selectHistoryProgram('${id}', '${name.replace(/'/g, "\\'")}')">${name}</div>`
        ).join('');
    }
    
    function showHistoryProgramDropdown() {
      document.getElementById('historyProgramDropdown').classList.add('show');
    }
    
    function hideHistoryProgramDropdown() {
      setTimeout(() => {
        document.getElementById('historyProgramDropdown').classList.remove('show');
      }, 150);
    }
    
    function filterHistoryPrograms(query) {
      const dropdown = document.getElementById('historyProgramDropdown');
      const items = dropdown.querySelectorAll('.dropdown-item');
      const q = query.toLowerCase();
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(q) ? 'block' : 'none';
      });
      
      dropdown.classList.add('show');
    }
    
    function selectHistoryProgram(programId, programName) {
      document.getElementById('historyProgramSearch').value = programName;
      document.getElementById('historyProgramId').value = programId;
      document.getElementById('historyProgramDropdown').classList.remove('show');
      
      // Update session dropdown based on selected program
      updateHistorySessionDropdown(programId);
      
      // Reload data
      loadScanHistory();
    }
    
    function updateHistorySessionDropdown(programId) {
      const select = document.getElementById('historySessionFilter');
      
      let filtered = historySessionsData;
      if (programId) {
        filtered = historySessionsData.filter(s => s.programId === programId);
      }
      
      select.innerHTML = '<option value="">All Sessions</option>' +
        filtered.map(s => {
          const sessionId = s.sessionId || s.id;
          return `<option value="${sessionId}">${s.name}</option>`;
        }).join('');
    }
    
    function clearHistoryFilters() {
      document.getElementById('historyProgramSearch').value = 'All Programs';
      document.getElementById('historyProgramId').value = '';
      document.getElementById('historyDateFilter').value = '';
      updateHistorySessionDropdown('');
      document.getElementById('historySessionFilter').value = '';
      // Force reload when clearing filters
      loadScanHistory();
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.history-program-dropdown')) {
        document.getElementById('historyProgramDropdown')?.classList.remove('show');
      }
    });
    
    async function loadScanHistory() {
      const sessionId = document.getElementById('historySessionFilter').value;
      const programId = document.getElementById('historyProgramId').value;
      const tbody = document.getElementById('scanHistoryTableBody');
      
      tbody.innerHTML = '<tr><td colspan="5" class="history-empty"><i class="ri-loader-4-line ri-spin"></i> Loading...</td></tr>';
      
      try {
        console.log('Loading scan history, sessionId filter:', sessionId || 'ALL');
        scanHistoryData = await api('getScanHistory', sessionId || '');
        console.log('Received scan history:', scanHistoryData?.length || 0, 'records');
        
        if (!scanHistoryData || scanHistoryData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="history-empty">No scan history found</td></tr>';
          updateHistoryStats([]);
          return;
        }
        
        // Apply filters
        let filtered = [...scanHistoryData];
        
        // Filter by program if no session selected but program is
        if (!sessionId && programId) {
          const programSessions = historySessionsData
            .filter(s => s.programId === programId)
            .map(s => s.sessionId || s.id);
          filtered = filtered.filter(h => programSessions.includes(h.sessionId));
        }
        
        // Apply date filter
        const dateFilter = document.getElementById('historyDateFilter').value;
        if (dateFilter) {
          filtered = filtered.filter(h => {
            if (!h.scannedAt) return false;
            return h.scannedAt.startsWith(dateFilter);
          });
        }
        
        // Apply sort
        filtered = sortHistoryData(filtered);
        
        updateHistoryStats(filtered);
        renderHistoryTable(filtered);
        
      } catch (e) {
        console.error('Failed to load scan history:', e);
        tbody.innerHTML = '<tr><td colspan="5" class="history-empty" style="color:var(--error);">Failed to load scan history</td></tr>';
      }
    }
    
    function sortHistoryData(data) {
      return data.sort((a, b) => {
        let aVal = a[historySortColumn] || '';
        let bVal = b[historySortColumn] || '';
        
        if (historySortColumn === 'scannedAt') {
          aVal = new Date(aVal);
          bVal = new Date(bVal);
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }
        
        if (aVal < bVal) return historySortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return historySortDir === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    function sortHistoryTable(column) {
      // Toggle direction if same column
      if (historySortColumn === column) {
        historySortDir = historySortDir === 'asc' ? 'desc' : 'asc';
      } else {
        historySortColumn = column;
        historySortDir = 'asc';
      }
      
      // Update header classes
      document.querySelectorAll('#historyTable th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === column) {
          th.classList.add(historySortDir);
        }
      });
      
      // Re-render with current data
      if (scanHistoryData && scanHistoryData.length > 0) {
        let filtered = [...scanHistoryData];
        
        // Apply same filters
        const sessionId = document.getElementById('historySessionFilter').value;
        const programId = document.getElementById('historyProgramId').value;
        const dateFilter = document.getElementById('historyDateFilter').value;
        
        if (!sessionId && programId) {
          const programSessions = historySessionsData
            .filter(s => s.programId === programId)
            .map(s => s.sessionId || s.id);
          filtered = filtered.filter(h => programSessions.includes(h.sessionId));
        }
        
        if (dateFilter) {
          filtered = filtered.filter(h => h.scannedAt?.startsWith(dateFilter));
        }
        
        filtered = sortHistoryData(filtered);
        renderHistoryTable(filtered);
      }
    }
    
    function renderHistoryTable(data) {
      const tbody = document.getElementById('scanHistoryTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="history-empty">No records match your filters</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.map(h => {
        let statusClass = 'existing';
        if (h.action === 'Enrolled' || h.action === 'Walk-in Attended' || h.action === 'Checked In') {
          statusClass = 'enrolled';
        }
        
        return `
        <tr>
          <td>${h.scannedAt || 'N/A'}</td>
          <td>
            <div class="history-emp-name">${h.employeeName || 'Unknown'}</div>
            <div class="history-emp-id">${h.employeeId || ''}</div>
          </td>
          <td>${h.sessionId || 'N/A'}</td>
          <td>
            <span class="history-status ${statusClass}">
              ${h.action || 'Unknown'}
            </span>
          </td>
          <td style="color:var(--text-muted);">${h.scannedBy || 'Scanner'}</td>
        </tr>
      `}).join('');
    }
    
    function updateHistoryStats(data) {
      document.getElementById('historyTotalScans').textContent = data.length;
      
      const uniqueEmps = new Set(data.map(h => h.employeeId));
      document.getElementById('historyUniqueEmployees').textContent = uniqueEmps.size;
      
      // Count new check-ins (Walk-in Attended, Checked In, Enrolled)
      const newEnrollments = data.filter(h => 
        h.action === 'Enrolled' || 
        h.action === 'Walk-in Attended' || 
        h.action === 'Checked In'
      ).length;
      document.getElementById('historyEnrolled').textContent = newEnrollments;
      
      // Count duplicates (Already Enrolled, Already Attended)
      const duplicates = data.filter(h => 
        h.action === 'Already Enrolled' || 
        h.action === 'Already Attended'
      ).length;
      document.getElementById('historyDuplicates').textContent = duplicates;
    }
    
    // ============================================
    // SESSIONS TABLE SORT
    // ============================================
    
    let sessionsSortColumn = 'date';
    let sessionsSortDir = 'desc';
    
    function sortSessionsTable(column) {
      if (sessionsSortColumn === column) {
        sessionsSortDir = sessionsSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        sessionsSortColumn = column;
        sessionsSortDir = column === 'date' ? 'desc' : 'asc';
      }
      
      // Update header classes
      document.querySelectorAll('#sessionsTable th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === column) {
          th.classList.add(sessionsSortDir);
        }
      });
      
      // Sort the sessions array
      sessions.sort((a, b) => {
        let aVal, bVal;
        
        if (column === 'date') {
          aVal = new Date(a.date || '1900-01-01');
          bVal = new Date(b.date || '1900-01-01');
        } else if (column === 'participants') {
          aVal = parseInt(a.participantCount) || 0;
          bVal = parseInt(b.participantCount) || 0;
        } else if (column === 'programName') {
          const pA = programs.find(p => p.id === a.programId);
          const pB = programs.find(p => p.id === b.programId);
          aVal = (pA?.name || '').toLowerCase();
          bVal = (pB?.name || '').toLowerCase();
        } else {
          aVal = String(a[column] || '').toLowerCase();
          bVal = String(b[column] || '').toLowerCase();
        }
        
        if (aVal < bVal) return sessionsSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return sessionsSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderSessionsTable();
    }
    
    // ============================================
    // PARTICIPANTS PAGE TABLE SORT
    // ============================================
    
    let participantsPageSortColumn = 'name';
    let participantsPageSortDir = 'asc';
    
    function sortParticipantsPageTable(column) {
      if (participantsPageSortColumn === column) {
        participantsPageSortDir = participantsPageSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        participantsPageSortColumn = column;
        participantsPageSortDir = 'asc';
      }
      
      // Update header classes
      document.querySelectorAll('#participantsPageTable th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === column) {
          th.classList.add(participantsPageSortDir);
        }
      });
      
      // Sort participantsSummary (existing global variable)
      if (participantsSummary && participantsSummary.length > 0) {
        participantsSummary.sort((a, b) => {
          let aVal, bVal;
          
          if (column === 'sessionCount' || column === 'totalHours') {
            aVal = parseFloat(a[column]) || 0;
            bVal = parseFloat(b[column]) || 0;
          } else {
            aVal = String(a[column] || '').toLowerCase();
            bVal = String(b[column] || '').toLowerCase();
          }
          
          if (aVal < bVal) return participantsPageSortDir === 'asc' ? -1 : 1;
          if (aVal > bVal) return participantsPageSortDir === 'asc' ? 1 : -1;
          return 0;
        });
        
        // Re-render with sorted data (use existing filter logic if filters are active)
        const search = document.getElementById('participantsSearch')?.value || '';
        const entityFilter = document.getElementById('filterParticipantEntity')?.value || '';
        const funcFilter = document.getElementById('filterParticipantFunction')?.value || '';
        const jobBandFilter = document.getElementById('filterParticipantJobBand')?.value || '';
        
        if (search || entityFilter || funcFilter || jobBandFilter) {
          filterParticipantsTable();
        } else {
          renderParticipantsPage();
        }
      }
    }
    
    async function exportScanHistory() {
      if (!scanHistoryData || scanHistoryData.length === 0) {
        showToast('No data to export', 'error');
        return;
      }
      
      // Create CSV
      const headers = ['Timestamp', 'Employee ID', 'Employee Name', 'Session ID', 'Action', 'Scanned By'];
      const rows = scanHistoryData.map(h => [
        h.scannedAt || '',
        h.employeeId || '',
        h.employeeName || '',
        h.sessionId || '',
        h.action || '',
        h.scannedBy || ''
      ]);
      
      const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `scan-history-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Export downloaded', 'success');
    }
    
    // Initialize QR attendance when page loads
    function initQRAttendance() {
      // Will be called when navigating to QR Attendance page
      if (qrCardsData.length === 0) {
        loadQRCards();
      }
    }
    
    // ============================================
    // ANALYTICS FUNCTIONS
    // ============================================
    
    let analyticsData = null;
    let analyticsCharts = {};
    
    // Chart color palettes
    const chartColors = {
      blue: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'],
      green: ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'],
      purple: ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'],
      orange: ['#f59e0b', '#fbbf24', '#fcd34d', '#fde68a', '#fef3c7'],
      multi: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16']
    };
    
    // Period type state
    let currentPeriodType = 'monthly'; // Default to monthly
    
    function initializeAnalyticsPeriod() {
      // Default to Monthly + current month
      currentPeriodType = 'monthly';
      
      // Update toggle buttons
      document.querySelectorAll('.period-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === 'monthly');
      });
      
      // Populate year and period dropdowns
      populateYearDropdown();
      updatePeriodFilter();
    }
    
    function populateYearDropdown() {
      const yearSelect = document.getElementById('analyticsYear');
      if (!yearSelect) return;
      
      const currentYear = new Date().getFullYear();
      const years = analyticsData?.availableYears || [currentYear, currentYear - 1, currentYear - 2];
      const sortedYears = [...new Set(years)].sort((a, b) => b - a);
      
      yearSelect.innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
      yearSelect.value = String(currentYear);
    }
    
    function updatePeriodFilter() {
      const periodGroup = document.getElementById('periodFilterGroup');
      const periodLabel = document.getElementById('periodFilterLabel');
      const periodSelect = document.getElementById('analyticsPeriod');
      
      if (!periodSelect) return;
      
      const currentMonth = new Date().getMonth() + 1;
      const currentQuarter = Math.ceil(currentMonth / 3);
      
      if (currentPeriodType === 'yearly') {
        // Hide period dropdown for yearly view
        periodGroup.style.display = 'none';
      } else if (currentPeriodType === 'quarterly') {
        periodGroup.style.display = 'flex';
        periodLabel.textContent = 'Quarter';
        periodSelect.innerHTML = `
          <option value="Q1">Q1 (Jan-Mar)</option>
          <option value="Q2">Q2 (Apr-Jun)</option>
          <option value="Q3">Q3 (Jul-Sep)</option>
          <option value="Q4">Q4 (Oct-Dec)</option>
        `;
        periodSelect.value = 'Q' + currentQuarter;
      } else if (currentPeriodType === 'monthly') {
        periodGroup.style.display = 'flex';
        periodLabel.textContent = 'Month';
        periodSelect.innerHTML = `
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        `;
        periodSelect.value = String(currentMonth);
      }
    }
    
    function onYearChange() {
      onAnalyticsFilterChange();
    }
    
    async function loadAnalyticsData() {
      const cacheKey = getCacheKey();
      
      // Check if cache is valid
      if (isCacheValid()) {
        console.log('Using cached analytics data');
        analyticsData = analyticsCache.data;
        populateAnalyticsFilters();
        updateCostVisibility({});
        renderKPIs();
        renderAllCharts();
        renderIndivDevTable();
        window.analyticsDataLoaded = true;
        updateCacheIndicator();
        return;
      }
      
      showLoading('Loading analytics...');
      
      try {
        const yearValue = document.getElementById('analyticsYear')?.value || '';
        const periodValue = document.getElementById('analyticsPeriod')?.value || '';
        
        // Build filter values
        let year = yearValue;
        let quarter = '';
        let month = '';
        
        if (currentPeriodType === 'quarterly') {
          quarter = periodValue; // "Q1", "Q2", etc.
        } else if (currentPeriodType === 'monthly') {
          month = periodValue; // "1", "2", etc.
        }
        // For yearly, just year is set
        
        const filters = {
          year: year,
          quarter: quarter,
          month: month,
          periodType: currentPeriodType,
          entity: document.getElementById('analyticsEntity')?.value || '',
          function: document.getElementById('analyticsFunction')?.value || '',
          subFunction: document.getElementById('analyticsSubFunction')?.value || '',
          jobBand: document.getElementById('analyticsJobBand')?.value || '',
          program: document.getElementById('analyticsProgram')?.value || ''
        };
        
        console.log('Analytics filters:', filters);
        
        // Call API with explicit error handling
        analyticsData = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler((result) => {
              console.log('Analytics raw result:', result);
              resolve(result);
            })
            .withFailureHandler((error) => {
              console.error('Analytics API error:', error);
              reject(error);
            })
            .getAnalyticsData(sessionToken, filters);
        });
        
        console.log('Analytics response:', analyticsData);
        console.log('Analytics KPIs:', analyticsData?.kpis);
        
        if (analyticsData) {
          // Store in cache
          analyticsCache.data = analyticsData;
          analyticsCache.timestamp = Date.now();
          analyticsCache.filters = cacheKey;
          
          if (analyticsData.error) {
            console.warn('Analytics backend note:', analyticsData.error);
          }
          
          populateAnalyticsFilters();
          updateCostVisibility(filters);
          renderKPIs();
          renderAllCharts();
          renderIndivDevTable();
          
          window.analyticsDataLoaded = true;
          updateCacheIndicator();
        } else {
          console.warn('Analytics returned empty - this may be normal if no data matches filters');
        }
      } catch (e) {
        // Only show error for actual failures, not empty data
        console.error('Analytics load error:', e);
        if (e.message && !e.message.includes('undefined')) {
          showToast('Failed to load analytics', 'error');
        }
      } finally {
        hideLoading();
      }
    }
    
    function updateCostVisibility(filters) {
      // TM1 only has Year/Quarter/Month/Entity level data
      // Hide cost cards when Function/SubFunction/Job Band/Program filters are active
      const hasCostIncompatibleFilters = filters.function || filters.subFunction || filters.jobBand || filters.program;
      
      // Completion Rate - Entity filter now applies to Sessions too (same entity names across sources)
      // Only hide when Function/SubFunction/Job Band filters are active (these only filter Enrollments, not Sessions)
      const hasCompletionIncompatibleFilters = filters.function || filters.subFunction || filters.jobBand;
      
      // Cost-related KPI cards (row 2) - except Avg Satisfaction which is always shown
      const costKPIRow = document.getElementById('costKPIRow');
      if (costKPIRow) {
        // Hide only the orange cards, keep the purple satisfaction card visible
        const orangeCards = costKPIRow.querySelectorAll('.kpi-card.orange');
        orangeCards.forEach(card => card.style.display = hasCostIncompatibleFilters ? 'none' : 'flex');
      }
      
      // Cost-related chart cards
      const spendChartCard = document.getElementById('chartCardSpendByEntity');
      const budgetChartCard = document.getElementById('chartCardBudgetByEntity');
      if (spendChartCard) spendChartCard.style.display = hasCostIncompatibleFilters ? 'none' : 'block';
      if (budgetChartCard) budgetChartCard.style.display = hasCostIncompatibleFilters ? 'none' : 'block';
      
      // Completion Rate KPI card
      const completionRateCard = document.getElementById('kpiCompletionRate')?.closest('.kpi-card');
      if (completionRateCard) completionRateCard.style.display = hasCompletionIncompatibleFilters ? 'none' : 'flex';
      
      // Completion Rate chart cards
      const completionCategoryCard = document.getElementById('chartCompletionByCategory')?.closest('.chart-card');
      const completionEntityCard = document.getElementById('chartCompletionByEntity')?.closest('.chart-card');
      if (completionCategoryCard) completionCategoryCard.style.display = hasCompletionIncompatibleFilters ? 'none' : 'block';
      if (completionEntityCard) completionEntityCard.style.display = hasCompletionIncompatibleFilters ? 'none' : 'block';
    }
    
    function setPeriodType(type) {
      currentPeriodType = type;
      
      // Update toggle buttons
      document.querySelectorAll('.period-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === type);
      });
      
      // Update period filter (show/hide, change options)
      updatePeriodFilter();
      
      // Trigger data reload
      onAnalyticsFilterChange();
    }
    
    function populateAnalyticsFilters() {
      if (!analyticsData) return;
      
      // Save current values
      const currentYear = document.getElementById('analyticsYear')?.value || '';
      const currentPeriod = document.getElementById('analyticsPeriod')?.value || '';
      const currentEntity = document.getElementById('analyticsEntity')?.value || '';
      const currentFunction = document.getElementById('analyticsFunction')?.value || '';
      const currentSubFunction = document.getElementById('analyticsSubFunction')?.value || '';
      const currentJobBand = document.getElementById('analyticsJobBand')?.value || '';
      const currentProgram = document.getElementById('analyticsProgram')?.value || '';
      
      // Update year dropdown with available years
      populateYearDropdown();
      if (currentYear) {
        const yearSelect = document.getElementById('analyticsYear');
        const optionExists = Array.from(yearSelect.options).some(opt => opt.value === currentYear);
        if (optionExists) yearSelect.value = currentYear;
      }
      
      // Period dropdown preserves selection
      if (currentPeriod) {
        const periodSelect = document.getElementById('analyticsPeriod');
        if (periodSelect) {
          const optionExists = Array.from(periodSelect.options).some(opt => opt.value === currentPeriod);
          if (optionExists) periodSelect.value = currentPeriod;
        }
      }
      
      // Populate entity filter
      const entitySelect = document.getElementById('analyticsEntity');
      if (entitySelect) {
        const entities = analyticsData.availableEntities || [];
        entitySelect.innerHTML = '<option value="">All Entities</option>' + 
          entities.map(e => `<option value="${e}"${currentEntity === e ? ' selected' : ''}>${e}</option>`).join('');
      }
      
      // Populate function filter
      const functionSelect = document.getElementById('analyticsFunction');
      if (functionSelect) {
        const functions = analyticsData.availableFunctions || [];
        functionSelect.innerHTML = '<option value="">All Functions</option>' + 
          functions.map(f => `<option value="${f}"${currentFunction === f ? ' selected' : ''}>${f}</option>`).join('');
      }
      
      // Populate sub-function filter
      const subFunctionSelect = document.getElementById('analyticsSubFunction');
      if (subFunctionSelect) {
        const subFunctions = analyticsData.availableSubFunctions || [];
        subFunctionSelect.innerHTML = '<option value="">All Sub-Functions</option>' + 
          subFunctions.map(sf => `<option value="${sf}"${currentSubFunction === sf ? ' selected' : ''}>${sf}</option>`).join('');
      }
      
      // Populate job band filter
      const jobBandSelect = document.getElementById('analyticsJobBand');
      if (jobBandSelect) {
        const jobBands = analyticsData.availableJobBands || [];
        jobBandSelect.innerHTML = '<option value="">All Job Bands</option>' + 
          jobBands.map(jb => `<option value="${jb}"${currentJobBand === jb ? ' selected' : ''}>${jb}</option>`).join('');
      }
      
      // Populate program filter
      const programSelect = document.getElementById('analyticsProgram');
      if (programSelect) {
        const programs = analyticsData.availablePrograms || [];
        programSelect.innerHTML = '<option value="">All Programs</option>' + 
          programs.map(p => `<option value="${p}"${currentProgram === p ? ' selected' : ''}>${p}</option>`).join('');
      }
    }
    
    function onAnalyticsFilterChange() {
      window.analyticsDataLoaded = false;
      loadAnalyticsData();
    }
    
    function resetAnalyticsFilters() {
      // Reset to Monthly + current month + current year
      currentPeriodType = 'monthly';
      document.querySelectorAll('.period-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === 'monthly');
      });
      
      // Reset year to current year
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('analyticsYear');
      if (yearSelect) yearSelect.value = String(currentYear);
      
      // Reset period filter
      updatePeriodFilter();
      
      document.getElementById('analyticsEntity').value = '';
      document.getElementById('analyticsFunction').value = '';
      document.getElementById('analyticsSubFunction').value = '';
      document.getElementById('analyticsJobBand').value = '';
      document.getElementById('analyticsProgram').value = '';
      
      window.analyticsDataLoaded = false;
      loadAnalyticsData();
    }
    
    function renderKPIs() {
      if (!analyticsData || !analyticsData.kpis) return;
      const kpis = analyticsData.kpis;
      
      // Format helpers
      const formatHours = (h) => h >= 1000 ? (h/1000).toFixed(1) + 'K' : h.toFixed(1);
      const formatCurrency = (c) => {
        if (c >= 1000000) return (c/1000000).toFixed(1) + 'M';
        if (c >= 1000) return (c/1000).toFixed(1) + 'K';
        return c.toFixed(0);
      };
      const formatPercent = (p) => p.toFixed(1) + '%';
      
      document.getElementById('kpiTotalHours').textContent = formatHours(kpis.totalHours || 0);
      document.getElementById('kpiAvgHoursPerEmp').textContent = (kpis.avgHoursPerEmp || 0).toFixed(1);
      document.getElementById('kpiCompletionRate').textContent = formatPercent(kpis.completionRate || 0);
      document.getElementById('kpiUniqueLearners').textContent = kpis.uniqueLearners || 0;
      document.getElementById('kpiTotalCost').textContent = formatCurrency(kpis.totalCost || 0);
      document.getElementById('kpiAvgCostPerEmp').textContent = formatCurrency(kpis.avgCostPerEmp || 0);
      document.getElementById('kpiBudgetUtil').textContent = formatPercent(kpis.budgetUtilization || 0);
      document.getElementById('kpiAvgSatisfaction').textContent = (kpis.avgSatisfaction || 0).toFixed(1);
    }
    
    function renderAllCharts() {
      if (!analyticsData || !analyticsData.charts) {
        console.log('renderAllCharts: No analyticsData or charts');
        return;
      }
      const charts = analyticsData.charts;
      
      console.log('renderAllCharts - charts data:', {
        hoursByCategory: charts.hoursByCategory?.labels?.length || 0,
        hoursByChannel: charts.hoursByChannel?.labels?.length || 0,
        hoursByEntity: charts.hoursByEntity?.labels?.length || 0,
        spendByEntity: charts.spendByEntity?.labels?.length || 0,
        budgetByEntity: charts.budgetByEntity?.labels?.length || 0
      });
      
      // Destroy existing charts
      Object.values(analyticsCharts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') chart.destroy();
      });
      analyticsCharts = {};
      
      // Restore all canvas elements first (in case they were replaced with "No data" divs)
      restoreChartCanvas('chartHoursByCategory');
      restoreChartCanvas('chartHoursByChannel');
      restoreChartCanvas('chartCompletionByCategory');
      restoreChartCanvas('chartCompletionByEntity');
      restoreChartCanvas('chartHoursByEntity');
      restoreChartCanvas('chartHoursByFunction');
      restoreChartCanvas('chartSpendByEntity');
      restoreChartCanvas('chartBudgetByEntity');
      
      // Pie Charts
      renderPieChart('chartHoursByCategory', charts.hoursByCategory, 'Hours');
      renderPieChart('chartHoursByChannel', charts.hoursByChannel, 'Hours');
      
      // Horizontal Bar Charts
      renderHorizontalBarChart('chartCompletionByCategory', charts.completionByCategory, '%', chartColors.green[0], 100);
      renderHorizontalBarChart('chartCompletionByEntity', charts.completionByEntity, '%', chartColors.green[0], 100);
      renderHorizontalBarChart('chartHoursByEntity', charts.hoursByEntity, 'hrs', chartColors.blue[0]);
      renderHorizontalBarChart('chartHoursByFunction', charts.hoursByFunction, 'hrs', chartColors.blue[0]);
      renderHorizontalBarChart('chartSpendByEntity', charts.spendByEntity, 'USD', chartColors.orange[0]);
      renderHorizontalBarChart('chartBudgetByEntity', charts.budgetByEntity, '%', chartColors.orange[0], 100);
    }
    
    function restoreChartCanvas(canvasId) {
      // Check if canvas exists
      let canvas = document.getElementById(canvasId);
      if (canvas) return; // Canvas exists, no need to restore
      
      // Find container by data-canvas-id attribute
      const container = document.querySelector(`.chart-container[data-canvas-id="${canvasId}"]`);
      if (container) {
        container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
        console.log('Restored canvas:', canvasId);
      }
    }
    
    function renderPieChart(canvasId, data, unit) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Check if data is empty - show "No data" message
      if (!data || !data.labels || data.labels.length === 0) {
        const container = canvas.parentElement;
        container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-muted);font-size:0.9rem;"><i class="ri-pie-chart-line" style="margin-right:8px;opacity:0.5;"></i>No data available</div>';
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      analyticsCharts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: chartColors.multi.slice(0, data.labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value.toFixed(1)} ${unit} (${percent}%)`;
                }
              }
            }
          },
          cutout: '55%'
        }
      });
    }
    
    function renderHorizontalBarChart(canvasId, data, unit, color, maxValue = null) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Check if data is empty - show "No data" message
      if (!data || !data.labels || data.labels.length === 0) {
        const container = canvas.parentElement;
        container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-muted);font-size:0.9rem;"><i class="ri-bar-chart-horizontal-line" style="margin-right:8px;opacity:0.5;"></i>No data available</div>';
        return;
      }
      
      const ctx = canvas.getContext('2d');
      
      // Sort by value descending and take top 8
      const combined = data.labels.map((label, i) => ({ label, value: data.values[i] }));
      combined.sort((a, b) => b.value - a.value);
      const top = combined.slice(0, 8);
      
      analyticsCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top.map(d => truncateLabel(d.label, 15)),
          datasets: [{
            data: top.map(d => d.value),
            backgroundColor: color,
            borderRadius: 4,
            barThickness: 20
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const fullLabel = top[context.dataIndex]?.label || context.label;
                  return `${fullLabel}: ${context.raw.toFixed(1)} ${unit}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: maxValue,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: {
                callback: function(value) {
                  if (unit === '%') return value + '%';
                  if (value >= 1000) return (value/1000).toFixed(0) + 'K';
                  return value;
                }
              }
            },
            y: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            }
          }
        }
      });
    }
    
    function truncateLabel(label, maxLen) {
      if (!label) return '';
      return label.length > maxLen ? label.substring(0, maxLen) + '...' : label;
    }
    
    // Individual Development Table
    function toggleIndivDevTable() {
      const checkbox = document.getElementById('showIndivDev');
      const content = document.getElementById('indivDevContent');
      
      if (checkbox.checked) {
        content.classList.add('show');
      } else {
        content.classList.remove('show');
      }
    }
    
    function renderIndivDevTable() {
      if (!analyticsData) return;
      
      const data = analyticsData.indivDev || [];
      const tbody = document.getElementById('indivDevTableBody');
      const countBadge = document.getElementById('indivDevCount');
      
      countBadge.textContent = data.length;
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="indiv-dev-empty">No individual development records</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${row.entity || '-'}</td>
          <td>
            <div style="font-weight:500;">${row.name || '-'}</div>
            <div style="font-size:0.75rem; color:var(--text-muted);">${row.employeeId || ''}</div>
          </td>
          <td>${row.program || '-'}</td>
          <td>${row.session || '-'}</td>
          <td>${row.date || '-'}</td>
          <td>${row.currency || '-'}</td>
          <td style="text-align:right; font-weight:500;">${row.cost ? row.cost.toLocaleString() : '-'}</td>
          <td style="text-align:right; font-weight:500; color:var(--primary);">${row.costUSD != null ? '$' + row.costUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</td>
        </tr>
      `).join('');
    }
    
    async function exportAnalyticsPDF() {
      if (!analyticsData) {
        showToast('No analytics data to export', 'error');
        return;
      }
      
      showLoading('Generating Analytics PDF...');
      
      try {
        const yearValue = document.getElementById('analyticsYear')?.value || '';
        const periodValue = document.getElementById('analyticsPeriod')?.value || '';
        
        // Build filter values
        let year = yearValue;
        let quarter = '';
        let month = '';
        
        if (currentPeriodType === 'quarterly') {
          quarter = periodValue; // "Q1", "Q2", etc.
        } else if (currentPeriodType === 'monthly') {
          month = periodValue; // "1", "2", etc.
        }
        
        const filters = {
          year: year,
          quarter: quarter,
          month: month,
          periodType: currentPeriodType,
          entity: document.getElementById('analyticsEntity')?.value || ''
        };
        
        const result = await api('exportAnalyticsPDF', filters);
        
        if (result && result.success && result.base64) {
          // Download using base64
          const link = document.createElement('a');
          link.href = 'data:application/pdf;base64,' + result.base64;
          link.download = result.filename || 'Analytics_Report.pdf';
          link.click();
          showToast('Analytics PDF downloaded successfully', 'success');
        } else {
          showToast('Failed to generate PDF: ' + (result?.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        console.error('Analytics PDF export error:', e);
        showToast('Export failed: ' + e.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    // ============================================
    // WALKTHROUGH / TOUR SYSTEM
    // ============================================
    
    let currentTourSteps = [];
    let currentTourStep = 0;
    let currentTourName = '';
    
    // Tour Definitions
    const tourDefinitions = {
      quick: [
        {
          target: null,
          type: 'welcome'
        },
        {
          target: '.sidebar nav',
          title: 'Navigation Menu',
          desc: 'This is your main menu with 7 modules: Calendar, Analytics, Programs, Sessions, Participants, QR Attendance, and Reports. Click any item to navigate.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '[data-page="calendar"]',
          title: ' Calendar',
          desc: 'Your training calendar shows all sessions at a glance. Switch between 5-Month overview and Monthly detail view. This is your default landing page.',
          position: 'right',
          arrow: 'left',
          beforeShow: () => navigateTo('calendar')
        },
        {
          target: '#primaryAction',
          title: 'Create New Sessions',
          desc: 'Click here to create a new training session. Fill in details, add participants, enable QR tracking, and link survey forms.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '[data-page="sessions"]',
          title: ' Sessions List',
          desc: 'View all sessions in a table. Filter by year, month, program, or status. Sort by clicking column headers. NEW and UPDATED badges highlight recent changes.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '[data-page="programs"]',
          title: ' Training Programs',
          desc: 'Manage your training program catalog. Each program can have multiple sessions. Global & Regional COEs can create and edit programs.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '[data-page="qr-attendance"]',
          title: ' QR Attendance',
          desc: 'Track attendance using QR codes. Generate QR cards for employees, scan with USB scanner or camera, and view scan history.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '[data-page="reports"]',
          title: ' Reports & Export',
          desc: 'Generate PDF reports  training calendar by program or training history by employee. Great for documentation and audits!',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '[data-page="analytics"]',
          title: ' Analytics',
          desc: 'View training metrics and charts. Track total sessions, participants, hours, and satisfaction scores across your organization.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '#helpBtn',
          title: 'Need Help? Click Here!',
          desc: 'You\'re all set!  Click this Help button anytime to restart this tour or learn about specific modules. Happy training!',
          position: 'bottom',
          arrow: 'top',
          isLast: true
        }
      ],
      calendar: [
        {
          target: '#page-calendar',
          title: ' Your Training Calendar',
          desc: 'This is your training calendar. Sessions are color-coded by status: Orange = Open (upcoming), Green = Completed.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('calendar')
        },
        {
          target: '.view-toggle',
          title: 'Switch Views',
          desc: 'Toggle between views: <b>5-Month</b> shows a bird\'s eye view of 5 months. <b>Monthly</b> shows detailed daily view of one month.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#calendarEntityFilter',
          title: 'Filter by Entity',
          desc: 'Filter sessions by company entity or global-initiated program. Select "All" to see everything.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.calendar-nav',
          title: 'Navigate Time',
          desc: 'Use < and > arrows to move between months. Click <b>Today</b> to jump back to the current month.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.monthly-event, .calendar-event',
          title: 'Click to Edit',
          desc: 'Click any session card to open it for viewing or editing. You\'ll see session details, participants, and survey options.',
          position: 'bottom',
          arrow: 'top',
          isLast: true
        }
      ],
      analytics: [
        {
          target: '#page-analytics',
          title: ' Training Analytics',
          desc: 'Your analytics dashboard shows training performance across your organization. Data updates automatically as sessions are completed.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('analytics')
        },
        {
          target: '.kpi-grid, .stats-grid',
          title: 'Key Metrics',
          desc: 'Four key metrics at a glance: <b>Total Sessions</b> conducted, <b>Participants</b> trained, <b>Training Hours</b> delivered, and <b>Avg Satisfaction</b> score.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#analyticsFilters, .analytics-filters',
          title: 'Filter Data',
          desc: 'Filter analytics by <b>Entity</b> and <b>Year</b>. This updates all charts and metrics to show only the filtered data.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.charts-grid, .chart-container',
          title: 'Visual Insights',
          desc: 'Interactive charts show: Sessions by Entity, Sessions by Type (Classroom/Online/E-Learning), Monthly trends, and more.',
          position: 'top',
          arrow: 'bottom',
          isLast: true
        }
      ],
      programs: [
        {
          target: '#page-programs',
          title: ' Training Programs',
          desc: 'Programs are your training curriculum catalog. Each program (e.g., "Leadership Development") can have multiple sessions throughout the year.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('programs')
        },
        {
          target: '#newProgramBtn',
          title: 'Create a Program',
          desc: 'Click to create a new training program. Fill in: Name, Category, Description, and Program Owner. <b>Only Global & Regional COEs can create programs.</b>',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.program-card',
          title: 'Program Card',
          desc: 'Each card shows: Program name, category, description, and number of sessions. The colored bar indicates the category.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '.session-count-link, .program-sessions',
          title: 'Quick Navigation',
          desc: 'Click the <b>sessions count</b> (e.g., "12 Sessions") to jump directly to the Sessions page filtered by this program.',
          position: 'bottom',
          arrow: 'top',
          isLast: true
        }
      ],
      sessions: [
        {
          target: '#page-sessions',
          title: ' Sessions List',
          desc: 'This is your master list of all training sessions. Each row shows session details, participant count, and status.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('sessions')
        },
        {
          target: '#primaryAction',
          title: 'Create Session',
          desc: 'Click to open the Session Creation wizard. You can create a single session or use Bulk Create for multiple sessions at once.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.filter-bar, #filterYear',
          title: 'Filter Sessions',
          desc: 'Narrow down your view: Filter by <b>Year</b>, <b>Month</b>, search by <b>Program name</b>, or filter by <b>Status</b> (Open/Completed).',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#sessionsTable thead',
          title: 'Sort Columns',
          desc: 'Click any column header to sort. Click again to reverse. Sort by: Session name, Program, Entity, Type, Date, Participants, or Status.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '.badge-new',
          title: 'New Sessions',
          desc: 'Green <b>NEW</b> badge marks sessions you just created. They automatically float to the top so you can find them easily.',
          position: 'bottom',
          arrow: 'top',
          optional: true
        },
        {
          target: '.badge-modified',
          title: 'Updated Sessions',
          desc: 'Orange <b>UPDATED</b> badge marks sessions you recently edited. Also floats to the top for easy access.',
          position: 'bottom',
          arrow: 'top',
          optional: true
        },
        {
          target: '#sessionsTableBody tr:first-child .btn-icon',
          title: 'Edit Session',
          desc: 'Click the <b>pencil icon</b> to edit session details, manage participants, enable QR tracking, or link survey forms.',
          position: 'left',
          arrow: 'right'
        },
        {
          target: '.pagination, #sessionsShowingStart',
          title: 'Navigate Pages',
          desc: 'Sessions are shown 10 per page. Use < > arrows or page numbers to navigate. The counter shows "Showing 1-10 of 247".',
          position: 'top',
          arrow: 'bottom',
          isLast: true
        }
      ],
      participants: [
        {
          target: '#page-participants',
          title: ' Participant Directory',
          desc: 'View all employees who have attended at least one training session. See their training statistics at a glance.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('participants')
        },
        {
          target: '#participantsSearch, .search-input',
          title: 'Find Employees',
          desc: 'Search by <b>name or ID</b>. Filter by <b>Entity</b>, <b>Function</b>, or <b>Job Band</b> to narrow down the list.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#participantsPageTable thead',
          title: 'Sort & Analyze',
          desc: 'Sort by clicking column headers: Name, Entity, Job Band, Function, Sessions attended, or Total Hours. Great for identifying training gaps.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#participantsTableBody tr:first-child',
          title: 'Training History',
          desc: 'Click the <b>eye icon</b> on any row to view that employee\'s complete training history with dates, programs, and attendance status.',
          position: 'left',
          arrow: 'right',
          isLast: true
        }
      ],
      qr: [
        {
          target: '#page-qr-attendance',
          title: ' QR Attendance System',
          desc: 'Track attendance using QR codes. Each employee has a unique QR code. Scan it during sessions to record attendance automatically.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('qr-attendance')
        },
        {
          target: '#qrTabCards',
          title: 'Employee QR Cards',
          desc: 'Browse all employee QR cards. Search by name/ID, filter by Entity or Function. Each card shows the employee\'s unique QR code.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#downloadSelectedBtn, #emailSelectedBtn',
          title: 'Bulk Actions',
          desc: 'Select multiple employees using checkboxes, then: <b>Download QR</b> to save as images, or <b>Email QR</b> to send codes directly to employees.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#qrTabScanner',
          title: 'Scan Attendance',
          desc: 'Use a <b>USB barcode scanner</b> or <b>device camera</b> to scan QR codes. First select a session, then scan. Attendance is recorded instantly. <b>Note:</b> Only sessions scheduled for today can be scanned.',
          position: 'bottom',
          arrow: 'top'
        },
        {
          target: '#scannerSessionSelect',
          title: 'Select Session First',
          desc: 'Important: Select the <b>training session</b> before scanning. This links each scan to the correct session for accurate records.',
          position: 'bottom',
          arrow: 'top',
          optional: true
        },
        {
          target: '#qrTabHistory',
          title: 'Scan History',
          desc: 'View all scan records: Who scanned, when, which session, and the action (Check-in/Check-out). Export history for reporting.',
          position: 'bottom',
          arrow: 'top',
          isLast: true
        }
      ],
      reports: [
        {
          target: '#page-reports',
          title: ' Export Reports',
          desc: 'Generate professional PDF reports for documentation, audits, or sharing with stakeholders.',
          position: 'center',
          arrow: 'none',
          beforeShow: () => navigateTo('reports')
        },
        {
          target: '.stat-card:first-child, [onclick*="program"]',
          title: 'Training Calendar PDF',
          desc: 'Click to export a <b>Program Training Calendar</b>. Select a program and year to generate a PDF showing all sessions with dates and details.',
          position: 'right',
          arrow: 'left'
        },
        {
          target: '.stat-card:last-child, [onclick*="employee"]',
          title: 'Training History PDF',
          desc: 'Click to export an <b>Employee Training History</b>. Search for an employee to generate a PDF of all their completed training with hours and scores.',
          position: 'left',
          arrow: 'right',
          isLast: true
        }
      ]
    };
    
    // Check first login and show welcome
    function checkFirstLogin() {
      const hasSeenTour = localStorage.getItem('tms_tour_completed');
      if (!hasSeenTour) {
        setTimeout(() => {
          showWelcomeModal();
        }, 1000);
      }
    }
    
    function showWelcomeModal() {
      document.getElementById('walkthroughOverlay').classList.add('active');
      document.getElementById('welcomeModal').classList.add('active');
    }
    
    function hideWelcomeModal() {
      document.getElementById('welcomeModal').classList.remove('active');
    }
    
    function skipWelcomeTour() {
      hideWelcomeModal();
      document.getElementById('walkthroughOverlay').classList.remove('active');
      localStorage.setItem('tms_tour_completed', 'true');
      document.getElementById('helpBtn').classList.add('pulse');
      setTimeout(() => {
        document.getElementById('helpBtn').classList.remove('pulse');
      }, 5000);
    }
    
    function startQuickTourFromWelcome() {
      hideWelcomeModal();
      startTour('quick', 1);
    }
    
    function startQuickTour() {
      closeHelpMenu();
      startTour('quick', 1);
    }
    
    function startGuide(guideName) {
      closeHelpMenu();
      startTour(guideName, 0);
    }
    
    function startTour(tourName, startStep = 0) {
      currentTourName = tourName;
      currentTourSteps = tourDefinitions[tourName] || [];
      currentTourStep = startStep;
      
      if (currentTourSteps.length === 0) {
        console.error('Tour not found:', tourName);
        return;
      }
      
      currentTourSteps = currentTourSteps.filter(step => {
        if (step.optional && step.target) {
          return document.querySelector(step.target);
        }
        return true;
      });
      
      document.getElementById('walkthroughOverlay').classList.add('active');
      showTourStep(currentTourStep);
    }
    
    async function showTourStep(stepIndex) {
      const step = currentTourSteps[stepIndex];
      if (!step) {
        endTour();
        return;
      }
      
      if (step.type === 'welcome') {
        showWelcomeModal();
        return;
      }
      
      if (step.beforeShow) {
        await step.beforeShow();
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      
      const overlay = document.getElementById('walkthroughOverlay');
      const spotlight = document.getElementById('walkthroughSpotlight');
      const tooltip = document.getElementById('walkthroughTooltip');
      
      overlay.classList.add('active');
      
      let target = null;
      if (step.target) {
        target = document.querySelector(step.target);
      }
      
      if (target) {
        const rect = target.getBoundingClientRect();
        
        spotlight.classList.add('active');
        spotlight.style.top = (rect.top - 8) + 'px';
        spotlight.style.left = (rect.left - 8) + 'px';
        spotlight.style.width = (rect.width + 16) + 'px';
        spotlight.style.height = (rect.height + 16) + 'px';
        
        positionTooltip(rect, step.position, step.arrow);
      } else {
        spotlight.classList.remove('active');
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        document.getElementById('tooltipArrow').style.display = 'none';
      }
      
      document.getElementById('tooltipStepBadge').textContent = stepIndex + 1;
      document.getElementById('tooltipStepCurrent').textContent = stepIndex + 1;
      document.getElementById('tooltipStepTotal').textContent = currentTourSteps.length;
      document.getElementById('tooltipTitle').textContent = step.title;
      document.getElementById('tooltipDesc').innerHTML = step.desc;
      
      const progressHtml = currentTourSteps.map((_, i) => {
        let cls = 'tooltip-progress-dot';
        if (i === stepIndex) cls += ' active';
        else if (i < stepIndex) cls += ' completed';
        return `<div class="${cls}"></div>`;
      }).join('');
      document.getElementById('tooltipProgress').innerHTML = progressHtml;
      
      document.getElementById('tooltipPrevBtn').style.display = stepIndex > 0 ? 'flex' : 'none';
      const nextBtn = document.getElementById('tooltipNextBtn');
      if (step.isLast) {
        nextBtn.innerHTML = 'Finish <i class="ri-check-line"></i>';
      } else {
        nextBtn.innerHTML = 'Next <i class="ri-arrow-right-s-line"></i>';
      }
      
      tooltip.classList.add('active');
    }
    
    function positionTooltip(rect, position, arrow) {
      const tooltip = document.getElementById('walkthroughTooltip');
      const tooltipArrow = document.getElementById('tooltipArrow');
      const tooltipWidth = 360;
      const tooltipHeight = tooltip.offsetHeight || 200;
      const padding = 20;
      
      let top, left;
      tooltip.style.transform = 'none';
      tooltipArrow.style.display = 'block';
      tooltipArrow.className = 'tooltip-arrow ' + arrow;
      
      switch (position) {
        case 'right':
          top = rect.top;
          left = rect.right + padding;
          if (left + tooltipWidth > window.innerWidth) {
            left = rect.left - tooltipWidth - padding;
            tooltipArrow.className = 'tooltip-arrow right';
          }
          break;
        case 'left':
          top = rect.top;
          left = rect.left - tooltipWidth - padding;
          if (left < 0) {
            left = rect.right + padding;
            tooltipArrow.className = 'tooltip-arrow left';
          }
          break;
        case 'bottom':
          top = rect.bottom + padding;
          left = rect.left;
          if (left + tooltipWidth > window.innerWidth) {
            left = window.innerWidth - tooltipWidth - padding;
          }
          break;
        case 'top':
          top = rect.top - tooltipHeight - padding;
          left = rect.left;
          if (top < 0) {
            top = rect.bottom + padding;
            tooltipArrow.className = 'tooltip-arrow top';
          }
          break;
        case 'center':
          top = rect.top + rect.height / 2;
          left = rect.left + rect.width / 2;
          tooltip.style.transform = 'translate(-50%, -50%)';
          tooltipArrow.style.display = 'none';
          break;
        default:
          top = rect.bottom + padding;
          left = rect.left;
      }
      
      if (top < 10) top = 10;
      if (top + tooltipHeight > window.innerHeight - 10) {
        top = window.innerHeight - tooltipHeight - 10;
      }
      if (left < 10) left = 10;
      if (left + tooltipWidth > window.innerWidth - 10) {
        left = window.innerWidth - tooltipWidth - 10;
      }
      
      tooltip.style.top = top + 'px';
      tooltip.style.left = left + 'px';
    }
    
    function nextTourStep() {
      currentTourStep++;
      if (currentTourStep >= currentTourSteps.length) {
        endTour();
      } else {
        showTourStep(currentTourStep);
      }
    }
    
    function prevTourStep() {
      if (currentTourStep > 0) {
        currentTourStep--;
        showTourStep(currentTourStep);
      }
    }
    
    function endTour() {
      document.getElementById('walkthroughOverlay').classList.remove('active');
      document.getElementById('walkthroughSpotlight').classList.remove('active');
      document.getElementById('walkthroughTooltip').classList.remove('active');
      document.getElementById('welcomeModal').classList.remove('active');
      
      localStorage.setItem('tms_tour_completed', 'true');
      
      const helpBtn = document.getElementById('helpBtn');
      helpBtn.classList.add('pulse');
      setTimeout(() => {
        helpBtn.classList.remove('pulse');
      }, 5000);
      
      currentTourSteps = [];
      currentTourStep = 0;
    }
    
    // Help Menu
    function toggleHelpMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('helpMenu');
      menu.classList.toggle('active');
      
      if (menu.classList.contains('active')) {
        document.addEventListener('click', closeHelpMenuOnOutsideClick);
      }
    }
    
    function closeHelpMenuOnOutsideClick(event) {
      const menu = document.getElementById('helpMenu');
      const btn = document.getElementById('helpBtn');
      if (!menu.contains(event.target) && !btn.contains(event.target)) {
        closeHelpMenu();
      }
    }
    
    function closeHelpMenu() {
      document.getElementById('helpMenu').classList.remove('active');
      document.removeEventListener('click', closeHelpMenuOnOutsideClick);
    }
    
    // Tips Modal
    function showTipsModal() {
      closeHelpMenu();
      document.getElementById('tipsModal').classList.add('active');
    }
    
    function closeTipsModal() {
      document.getElementById('tipsModal').classList.remove('active');
    }
  </script>
  
  <!-- Hidden print area for QR cards -->
  <div id="qrPrintArea" style="display:none;"></div>
  
  <!-- Walkthrough System Components -->
  <div class="walkthrough-overlay" id="walkthroughOverlay"></div>
  <div class="walkthrough-spotlight" id="walkthroughSpotlight"></div>
  
  <div class="walkthrough-tooltip" id="walkthroughTooltip">
    <div class="tooltip-arrow" id="tooltipArrow"></div>
    <div class="tooltip-header">
      <div class="tooltip-step-badge" id="tooltipStepBadge">1</div>
      <div class="tooltip-step-label">Step <span id="tooltipStepCurrent">1</span> of <span id="tooltipStepTotal">10</span></div>
    </div>
    <div class="tooltip-title" id="tooltipTitle">Welcome!</div>
    <div class="tooltip-desc" id="tooltipDesc">Let's explore the Training Management System.</div>
    <div class="tooltip-footer">
      <div class="tooltip-progress" id="tooltipProgress"></div>
      <div class="tooltip-btns">
        <button class="tooltip-btn skip" onclick="endTour()">Skip</button>
        <button class="tooltip-btn prev" id="tooltipPrevBtn" onclick="prevTourStep()" style="display:none;">
          <i class="ri-arrow-left-s-line"></i> Back
        </button>
        <button class="tooltip-btn next" id="tooltipNextBtn" onclick="nextTourStep()">
          Next <i class="ri-arrow-right-s-line"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Welcome Modal -->
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-icon">
      <i class="ri-graduation-cap-line"></i>
    </div>
    <h2 class="welcome-title">Welcome to TMS! </h2>
    <p class="welcome-desc">
      The Training Management System helps you manage training sessions, track participant attendance, and analyze training effectiveness across your organization.
    </p>
    <div class="welcome-features">
      <div class="welcome-feature">
        <i class="ri-calendar-check-line"></i>
        <span>Manage Sessions</span>
      </div>
      <div class="welcome-feature">
        <i class="ri-team-line"></i>
        <span>Track Attendance</span>
      </div>
      <div class="welcome-feature">
        <i class="ri-pie-chart-line"></i>
        <span>View Analytics</span>
      </div>
    </div>
    <div class="welcome-actions">
      <button class="welcome-btn secondary" onclick="skipWelcomeTour()">I'll explore myself</button>
      <button class="welcome-btn primary" onclick="startQuickTourFromWelcome()">
        <i class="ri-play-line"></i> Take a Quick Tour
      </button>
    </div>
  </div>
  
  <!-- Tips Modal -->
  <div class="modal-overlay" id="tipsModal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h2 class="modal-title"><i class="ri-lightbulb-line" style="color:var(--primary);"></i> Tips & Shortcuts</h2>
        <button class="modal-close" onclick="closeTipsModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:1.5rem;">
        <div style="display:flex; flex-direction:column; gap:1rem;">
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-keyboard-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Press Escape</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Close any modal or popup instantly</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-sort-asc"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Click Column Headers</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Sort any table by clicking the header. Click again to reverse.</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:#dcfce7; color:#16a34a; width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-price-tag-3-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">NEW / UPDATED Badges</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Recently created or edited sessions float to the top with badges.</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-calendar-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Click Calendar Events</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Click any session card on the calendar to view or edit it directly.</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-stack-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Bulk Create Sessions</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Use the "Bulk Create" tab to create multiple sessions at once.</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-upload-2-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Mass Upload Participants</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Import participant lists via Excel or CSV using the Mass Upload button.</div>
            </div>
          </div>
          <div style="display:flex; align-items:flex-start; gap:12px; padding:0.75rem; background:var(--bg-card-hover); border-radius:10px;">
            <div style="background:var(--primary-light); color:var(--primary); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;"><i class="ri-mail-send-line"></i></div>
            <div>
              <div style="font-weight:600; font-size:0.9rem;">Email QR Codes</div>
              <div style="font-size:0.8rem; color:var(--text-muted);">Select employees and click "Email QR" to send codes directly to their inbox.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:flex-end;">
        <button class="btn btn-primary" onclick="closeTipsModal()">Got it!</button>
      </div>
    </div>
  </div>
</body>
</html>